<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Spring Cloud 学习笔记 | LLQWQ的博客</title><meta name="keywords" content="java,框架,分布式,spring-cloud"><meta name="author" content="LLQWQ"><meta name="copyright" content="LLQWQ"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="spring-boot 官方文档 spring-cloud 官方文档 spring-cloud中文文档 一、项目搭建project创建一个简单的maven项目（mavn-archetype-site）创建的过程中请使用3.5以上的maven，不要使用idea自带的  设置字符编码 注解生效激活打开enable annotation processors选项 default里面的enable ann">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Cloud 学习笔记">
<meta property="og:url" content="http://llqwq.gitee.io/2020/07/05/spring-cloud/spring-cloud/index.html">
<meta property="og:site_name" content="LLQWQ的博客">
<meta property="og:description" content="spring-boot 官方文档 spring-cloud 官方文档 spring-cloud中文文档 一、项目搭建project创建一个简单的maven项目（mavn-archetype-site）创建的过程中请使用3.5以上的maven，不要使用idea自带的  设置字符编码 注解生效激活打开enable annotation processors选项 default里面的enable ann">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://llqwq.gitee.io/img/spring-cloud-cover.jpg">
<meta property="article:published_time" content="2020-07-04T16:00:00.000Z">
<meta property="article:modified_time" content="2021-03-24T17:18:19.414Z">
<meta property="article:author" content="LLQWQ">
<meta property="article:tag" content="java">
<meta property="article:tag" content="框架">
<meta property="article:tag" content="分布式">
<meta property="article:tag" content="spring-cloud">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://llqwq.gitee.io/img/spring-cloud-cover.jpg"><link rel="shortcut icon" href="/img/48668845.jpg"><link rel="canonical" href="http://llqwq.gitee.io/2020/07/05/spring-cloud/spring-cloud/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-03-25 01:18:19'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" data-lazy-src="/img/48668845.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">13</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">21</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">28</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/spring-cloud.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">LLQWQ的博客</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Spring Cloud 学习笔记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-07-04T16:00:00.000Z" title="发表于 2020-07-05 00:00:00">2020-07-05</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-03-24T17:18:19.414Z" title="更新于 2021-03-25 01:18:19">2021-03-25</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/java/">java</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/java/spring/">spring</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%A1%86%E6%9E%B6/">框架</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/java/spring-cloud/">spring-cloud</a></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p><a target="_blank" rel="noopener" href="https://spring.io/projects/spring-boot">spring-boot 官方文档</a></p>
<p><a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud">spring-cloud 官方文档</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bookstack.cn/read/spring-cloud-docs/docs-index.md">spring-cloud中文文档</a></p>
<h1 id="一、项目搭建"><a href="#一、项目搭建" class="headerlink" title="一、项目搭建"></a>一、项目搭建</h1><h2 id="project"><a href="#project" class="headerlink" title="project"></a>project</h2><h3 id="创建一个简单的maven项目（mavn-archetype-site）"><a href="#创建一个简单的maven项目（mavn-archetype-site）" class="headerlink" title="创建一个简单的maven项目（mavn-archetype-site）"></a>创建一个简单的maven项目（mavn-archetype-site）</h3><p>创建的过程中请使用3.5以上的maven，不要使用idea自带的</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200523123547798.png" alt="image-20200523123547798"></p>
<h3 id="设置字符编码"><a href="#设置字符编码" class="headerlink" title="设置字符编码"></a>设置字符编码</h3><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200523124518170.png" alt="image-20200523124518170"></p>
<h3 id="注解生效激活"><a href="#注解生效激活" class="headerlink" title="注解生效激活"></a>注解生效激活</h3><p>打开enable annotation processors选项</p>
<p>default里面的enable annotation processors选项也要√</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200523124807004.png" alt="image-20200523124807004"></p>
<h3 id="设置java8"><a href="#设置java8" class="headerlink" title="设置java8"></a>设置java8</h3><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200523125155066.png" alt="image-20200523125155066"></p>
<h3 id="File-Type-过滤【可选】"><a href="#File-Type-过滤【可选】" class="headerlink" title="File Type 过滤【可选】"></a>File Type 过滤【可选】</h3><p>将不需要看到的文件添加到下面那个框里面就好了</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200523125416059.png" alt="image-20200523125416059"></p>
<h2 id="搭建父工程pom"><a href="#搭建父工程pom" class="headerlink" title="搭建父工程pom"></a>搭建父工程pom</h2><p>删除src文件，因为这是父工程，不需要src文件</p>
<h3 id="pom文件"><a href="#pom文件" class="headerlink" title="pom文件"></a>pom文件</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ll.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud2020<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">junit.version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">junit.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">lombok.version</span>&gt;</span>1.16.18<span class="tag">&lt;/<span class="name">lombok.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">log4j.version</span>&gt;</span>1.2.17<span class="tag">&lt;/<span class="name">log4j.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mysql.version</span>&gt;</span>5.1.47<span class="tag">&lt;/<span class="name">mysql.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">druid.version</span>&gt;</span>1.1.16<span class="tag">&lt;/<span class="name">druid.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mybatis.spring.boot.version</span>&gt;</span>1.3.0<span class="tag">&lt;/<span class="name">mybatis.spring.boot.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--子模块继承之后，提供作用：锁定版本+子module不用谢groupId和version--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-project-info-reports-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--spring boot 2.2.2--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--spring cloud Hoxton.SR1--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>Hoxton.SR1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--spring cloud 阿里巴巴--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--mysql--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mysql.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- druid--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;druid.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--mybatis--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mybatis.spring.boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--junit--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;junit.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--log4j--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;log4j.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="关闭单元测试"><a href="#关闭单元测试" class="headerlink" title="关闭单元测试"></a>关闭单元测试</h3><p>这一步只是为了打包节省时间</p>
<p>看到test指令被划了横线就好了</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200523131615272.png" alt="image-20200523131615272"></p>
<h3 id="测试是否搭建成功"><a href="#测试是否搭建成功" class="headerlink" title="测试是否搭建成功"></a>测试是否搭建成功</h3><p>运行maven的install命令查看一下是否出现了<code>BUILD SUCCESS</code></p>
<p>测试完了之后执行clean指令删除刚刚编译的项目jar包</p>
<h2 id="Rest微服务工程构建"><a href="#Rest微服务工程构建" class="headerlink" title="Rest微服务工程构建"></a>Rest微服务工程构建</h2><h3 id="创建一个普通的maven工程【cloud-provider-payment8001】"><a href="#创建一个普通的maven工程【cloud-provider-payment8001】" class="headerlink" title="创建一个普通的maven工程【cloud-provider-payment8001】"></a>创建一个普通的maven工程【cloud-provider-payment8001】</h3><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200523133057294.png" alt="image-20200523133057294"></p>
<h4 id="添加pom依赖"><a href="#添加pom依赖" class="headerlink" title="添加pom依赖"></a>添加pom依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--如果没有用到就不要导--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--如果没有用到就不要导--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--mysql-connector-java--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--如果没有用到就不要导--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--jdbc--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--如果没有用到就不要导--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="写application-yml"><a href="#写application-yml" class="headerlink" title="写application.yml"></a>写application.yml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-payment-service</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">org.gjt.mm.mysql.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/db2020?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:mapper/*.xml</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.ll.springcloud.entities</span></span><br></pre></td></tr></table></figure>

<h4 id="主启动类"><a href="#主启动类" class="headerlink" title="主启动类"></a>主启动类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentMain8001</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(PaymentMain8001.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h4 id="业务类"><a href="#业务类" class="headerlink" title="业务类"></a>业务类</h4><h5 id="建表sql"><a href="#建表sql" class="headerlink" title="建表sql"></a>建表sql</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `payment` (</span><br><span class="line">	`id` <span class="type">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> auto_increment COMMENT <span class="string">&#x27;ID&#x27;</span>,</span><br><span class="line">	`serial` <span class="type">VARCHAR</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span>(<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">	<span class="keyword">primary</span> key (`id`)</span><br><span class="line">)ENGINE<span class="operator">=</span>INNODB auto_increment<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> charset<span class="operator">=</span>utf8</span><br></pre></td></tr></table></figure>

<p>其他的类去看项目里面的代码</p>
<h3 id="热部署-Devtools"><a href="#热部署-Devtools" class="headerlink" title="热部署 Devtools"></a>热部署 Devtools</h3><h4 id="添加devtools-jar包"><a href="#添加devtools-jar包" class="headerlink" title="添加devtools jar包"></a>添加devtools jar包</h4><p>这个要添加到子工程里面</p>
<p>如果是拷贝的之前创建8001工程的pom文件，这个就不用拷了</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="添加插件到父工程"><a href="#添加插件到父工程" class="headerlink" title="添加插件到父工程"></a>添加插件到父工程</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">fork</span>&gt;</span>true<span class="tag">&lt;/<span class="name">fork</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">addResources</span>&gt;</span>true<span class="tag">&lt;/<span class="name">addResources</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="开启自动编译选项"><a href="#开启自动编译选项" class="headerlink" title="开启自动编译选项"></a>开启自动编译选项</h4><p>勾上，automatically的那个也要勾</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200523155942164.png" alt="image-20200523155942164"></p>
<p>按住<code>ctrl+shift+alt+/</code>,点击第一个</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200523160233748.png" alt="image-20200523160233748"></p>
<p>勾上以下两个选项（可以搜索）</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200523160509841.png" alt="image-20200523160509841"></p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200523160603567.png" alt="image-20200523160603567"></p>
<h4 id="重启idea"><a href="#重启idea" class="headerlink" title="重启idea"></a>重启idea</h4><h3 id="创建消费者【cloud-customer-order80】"><a href="#创建消费者【cloud-customer-order80】" class="headerlink" title="创建消费者【cloud-customer-order80】"></a>创建消费者【cloud-customer-order80】</h3><p>没什么需要记的，和创建payment项目的步骤一样，就是不需要的依赖记得移除，代码看项目</p>
<h3 id="项目重构"><a href="#项目重构" class="headerlink" title="项目重构"></a>项目重构</h3><p>由于之前的项目中有代码相同的部分，所以将他们全都提取出来，单独作为一个项目【cloud-api-commons】</p>
<h1 id="二、eureka服务注册与发现"><a href="#二、eureka服务注册与发现" class="headerlink" title="二、eureka服务注册与发现"></a>二、eureka服务注册与发现</h1><h2 id="单机eureka构建步骤"><a href="#单机eureka构建步骤" class="headerlink" title="单机eureka构建步骤"></a>单机eureka构建步骤</h2><h3 id="eurekaServer端"><a href="#eurekaServer端" class="headerlink" title="eurekaServer端"></a>eurekaServer端</h3><h5 id="建maven工程"><a href="#建maven工程" class="headerlink" title="建maven工程"></a>建maven工程</h5><h5 id="修改pom文件"><a href="#修改pom文件" class="headerlink" title="修改pom文件"></a>修改pom文件</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--eureka-server--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ll.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--boot web actuator--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200523192756143.png" alt="image-20200523192756143"></p>
<h5 id="写yml"><a href="#写yml" class="headerlink" title="写yml"></a>写yml</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7001</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span> <span class="comment">#eureka服务端的实例名称</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span>     <span class="comment">#false表示不向注册中心注册自己。</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span>     <span class="comment">#false表示自己端就是注册中心，我的职责就是维护服务实例，并不需要去检索服务</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="comment">#集群指向其它eureka</span></span><br><span class="line">      <span class="comment">#defaultZone: http://eureka7002.com:7002/eureka/</span></span><br><span class="line">      <span class="comment">#单机就是7001自己</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></span><br></pre></td></tr></table></figure>

<h5 id="主启动类-1"><a href="#主启动类-1" class="headerlink" title="主启动类"></a>主启动类</h5><p>在主启动类中添加@EnableEurekaServer注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaMain7001</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(EurekaMain7001.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h5><p>浏览器中输入网址<a target="_blank" rel="noopener" href="http://localhost:7001/">http://localhost:7001/</a></p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200523193945664.png" alt="image-20200523193945664"></p>
<p><strong>如果出现下图中的红色警告，别慌，这是eureka的自我保护机制，后面会说的</strong></p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200523205708198.png" alt="image-20200523205708198"></p>
<h2 id="将cloud-provider-payment8001注册进eureka中"><a href="#将cloud-provider-payment8001注册进eureka中" class="headerlink" title="将cloud-provider-payment8001注册进eureka中"></a>将cloud-provider-payment8001注册进eureka中</h2><p>以下修改都是对cloud-provider-payment8001项目进行的修改</p>
<h3 id="添加eureka-client依赖"><a href="#添加eureka-client依赖" class="headerlink" title="添加eureka-client依赖"></a>添加eureka-client依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--eureka-client--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="修改yml"><a href="#修改yml" class="headerlink" title="修改yml"></a>修改yml</h3><p>添加以下配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka/</span></span><br></pre></td></tr></table></figure>

<h3 id="修改主入口类"><a href="#修改主入口类" class="headerlink" title="修改主入口类"></a>修改主入口类</h3><p>添加@EnableEurekaClient注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentMain8001</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(PaymentMain8001.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h3><p>还是输入eureka的网址<a target="_blank" rel="noopener" href="http://localhost:7001/">http://localhost:7001/</a></p>
<p>可以看到已经出现了刚刚注册进去的服务，服务的名称就是在application.yml中配置的<code>spring.application.name</code>,这个名称最好不要随意改动</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200523200046599.png" alt="image-20200523200046599"></p>
<h2 id="将cloud-customer-order80也注册到eureka中"><a href="#将cloud-customer-order80也注册到eureka中" class="headerlink" title="将cloud-customer-order80也注册到eureka中"></a>将cloud-customer-order80也注册到eureka中</h2><p>步骤和修改和上面的一致</p>
<p>成功之后可以看到就被注册到eureka中了</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200523201616980.png" alt="image-20200523201616980"></p>
<h2 id="集群Eureka搭建步骤"><a href="#集群Eureka搭建步骤" class="headerlink" title="集群Eureka搭建步骤"></a>集群Eureka搭建步骤</h2><h3 id="eureka集群原理说明"><a href="#eureka集群原理说明" class="headerlink" title="eureka集群原理说明"></a>eureka集群原理说明</h3><p>别问，问就是偷懒o(´^｀)o</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200523202335326.png" alt="image-20200523202335326"></p>
<h3 id="再构建一个eureka-server项目"><a href="#再构建一个eureka-server项目" class="headerlink" title="再构建一个eureka-server项目"></a>再构建一个eureka-server项目</h3><p>参考eurekaServer-7001的那个，建完之后看下面的。先不要着急测试</p>
<h3 id="修改hosts文件"><a href="#修改hosts文件" class="headerlink" title="修改hosts文件"></a>修改hosts文件</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 添加以下映射</span></span><br><span class="line">127.0.0.1 eureka7001</span><br><span class="line">127.0.0.1 eureka7002</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里是两台eureka的ip映射，因为练习cloud所以就共用一台物理机，使用映射的方式区分一下。</p>
<p>当然不配置这个也可以</p>
</blockquote>
<h4 id="修改yml-1"><a href="#修改yml-1" class="headerlink" title="修改yml"></a>修改yml</h4><p>7002的yml：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">eureka7002</span> <span class="comment"># eureka服务端的实例名称</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span>     <span class="comment">#false表示不向注册中心注册自己。</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span>     <span class="comment">#false表示自己端就是注册中心，我的职责就是维护服务实例，并不需要去检索服务</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001:7001/eureka/</span> <span class="comment"># 因为是相互守望、相互注册，所以这里要填7001的注册地址</span></span><br></pre></td></tr></table></figure>

<p>7001的yml：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">eureka7001</span> <span class="comment">#eureka服务端的实例名称</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span>     <span class="comment">#false表示不向注册中心注册自己。</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span>     <span class="comment">#false表示自己端就是注册中心，我的职责就是维护服务实例，并不需要去检索服务</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7002:7002/eureka/</span> <span class="comment"># 不解释了，上面解释过了</span></span><br></pre></td></tr></table></figure>

<h3 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h3><p>访问7001和7002</p>
<p>如果像下图一样，7001中的DS Replicas中的是7002，7002中的是7001，就成功啦|ू･ω･` )</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200523205332154.png" alt="image-20200523205332154"></p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200523210126006.png" alt="image-20200523210126006"></p>
<h3 id="将订单80和订单服务提供者8001注册到eureka中"><a href="#将订单80和订单服务提供者8001注册到eureka中" class="headerlink" title="将订单80和订单服务提供者8001注册到eureka中"></a>将订单80和订单服务提供者8001注册到eureka中</h3><p>这一步很简单，只需要修改80和8001的yml配置文件即可</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka/,http://eureka7002:7002/eureka/</span></span><br><span class="line">      <span class="comment"># 将defaultZone修改为多个注册地址即可，当然只填一个也是可以的，因为eureka集群会互相复制，但是如果刚好填的那一个eureka刚好没启动，服务就注册不上去了</span></span><br></pre></td></tr></table></figure>

<h3 id="测试-3"><a href="#测试-3" class="headerlink" title="测试"></a>测试</h3><p>网址输入<a href="http://localhost:7001和http://localhost:7002">http://localhost:7001和http://localhost:7002</a></p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200523211213776.png" alt="image-20200523211213776"></p>
<h3 id="订单服务提供者8001的集群配置"><a href="#订单服务提供者8001的集群配置" class="headerlink" title="订单服务提供者8001的集群配置"></a>订单服务提供者8001的集群配置</h3><h4 id="新建8002"><a href="#新建8002" class="headerlink" title="新建8002"></a>新建8002</h4><p>参考8001</p>
<h4 id="修改yml-2"><a href="#修改yml-2" class="headerlink" title="修改yml"></a>修改yml</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8002</span> <span class="comment"># 只需要修改端口号</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>为什么不修改spring.application.name?</p>
<p>不仅不要修改，名称还必须一致。因为8001和8002的服务提供都是一样的，如果名称不一致那么就做不到负载均衡了</p>
</blockquote>
<h4 id="测试-4"><a href="#测试-4" class="headerlink" title="测试"></a>测试</h4><p>如果配置成功，可以看到下面出现了8001和8002</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200523214156853.png" alt="image-20200523214156853"></p>
<h3 id="使用下单服务80去访问订单服务集群"><a href="#使用下单服务80去访问订单服务集群" class="headerlink" title="使用下单服务80去访问订单服务集群"></a>使用下单服务80去访问订单服务集群</h3><p>因为订单服务已经是集群了，并且注册到了eureka中，所以这里只需要访问订单服务名称(<strong>CLOUD-PAYMENT-SERVICE</strong>)即可</p>
<blockquote>
<p>由于这里写死的网址是配置在配置文件中，所以这里只需要修改配置文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;$&#123;my-config.cloud-payment-url&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String PAYMENT_URL;</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">my-config:</span></span><br><span class="line">  <span class="attr">cloud-payment-url:</span> <span class="string">http://CLOUD-PAYMENT-SERVICE</span> <span class="comment"># 修改为服务名称</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>这里出现了以下错误，是因为没有开启RestTemplate的负载均衡能力</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200523214619780.png" alt="image-20200523214619780"></p>
<p><strong>开启方法：</strong></p>
<p>在之前的配置类中加入@LoadBalanced注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试</strong></p>
<p>在8001和8002的controller加一个标识，方便测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> CommonResult(<span class="number">200</span>, <span class="string">&quot;插入成功,serverPost:&quot;</span>+port, i);</span><br><span class="line"><span class="comment">// 在返回json串的时候加入一下port</span></span><br></pre></td></tr></table></figure>

<p>访问80的请求地址，连续多访问几次，如果返回的json串中的port一直在切换，那就成功啦！！！</p>
<p>因为默认是使用轮询的方式完成的负载均衡</p>
<h2 id="actuator微服务信息完善"><a href="#actuator微服务信息完善" class="headerlink" title="actuator微服务信息完善"></a>actuator微服务信息完善</h2><h3 id="微服务名称修改"><a href="#微服务名称修改" class="headerlink" title="微服务名称修改"></a>微服务名称修改</h3><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200523220413283.png" alt="image-20200523220413283"></p>
<p>修改这里的名称，这里显示的主机名，这么显示一般不太好</p>
<p><strong>修改yml文件</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka/,http://eureka7002:7002/eureka/</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">payment8002</span> <span class="comment"># 添加这个属性</span></span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200523220814238.png" alt="image-20200523220814238"></p>
<p>这样就改掉了</p>
<h3 id="ip显示"><a href="#ip显示" class="headerlink" title="ip显示"></a>ip显示</h3><p>当鼠标放到微服务名称连接上时，不会出现ip地址，这样不利于调试排错</p>
<p><strong>修改yml文件</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka/,http://eureka7002:7002/eureka/</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">payment8002</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span> <span class="comment"># 添加这个 显示ip地址</span></span><br></pre></td></tr></table></figure>



<h2 id="服务发现Disovery"><a href="#服务发现Disovery" class="headerlink" title="服务发现Disovery"></a>服务发现Disovery</h2><p>可通过DiscoveryClient类来获取服务的信息</p>
<p><strong>使用方式</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> DiscoveryClient discovery;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/payment/discovery&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">discovery</span><span class="params">()</span></span>&#123;</span><br><span class="line">    List&lt;String&gt; services = discovery.getServices(); <span class="comment">// 这个方法可以获取到eureka中注册的所有服务的名称</span></span><br><span class="line">    services.forEach((i)-&gt;&#123;</span><br><span class="line">        log.info(<span class="string">&quot;*********element&quot;</span>+i);</span><br><span class="line">    &#125;);</span><br><span class="line">    List&lt;ServiceInstance&gt; instances = discovery.getInstances(<span class="string">&quot;CLOUD-PAYMENT-SERVICE&quot;</span>); <span class="comment">// 这个方法中可以获取指定服务名称中的服务，因为服务有可能是多个，所以这里返回一个列表</span></span><br><span class="line">    instances.forEach((i)-&gt;&#123;</span><br><span class="line">        log.info(i.getServiceId()+<span class="string">&quot;, &quot;</span>+i.getHost()+<span class="string">&quot;, &quot;</span>+i.getPort()+<span class="string">&quot;, &quot;</span>+i.getUri());</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.discovery;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后在主配置类中加入@EnableDiscoveryClient注解，开启功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentMain8002</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(PaymentMain8002.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>打印结果</strong></p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200523223307895.png" alt="image-20200523223307895"></p>
<h2 id="Eureka自我保护机制原理"><a href="#Eureka自我保护机制原理" class="headerlink" title="Eureka自我保护机制原理"></a>Eureka自我保护机制原理</h2><h3 id="故障现象"><a href="#故障现象" class="headerlink" title="故障现象"></a>故障现象</h3><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200523223453312.png" alt="image-20200523223453312"></p>
<h3 id="导致原因"><a href="#导致原因" class="headerlink" title="导致原因"></a>导致原因</h3><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200523223834549.png" alt="image-20200523223834549"></p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200523223858560.png" alt="image-20200523223858560"></p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200523224153468.png" alt="image-20200523224153468"></p>
<h3 id="怎么禁止自我保护"><a href="#怎么禁止自我保护" class="headerlink" title="怎么禁止自我保护"></a>怎么禁止自我保护</h3><p>修改eureka7001的yml文件</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">eureka7001</span> <span class="comment">#eureka服务端的实例名称</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span>     <span class="comment">#false表示不向注册中心注册自己。</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span>     <span class="comment">#false表示自己端就是注册中心，我的职责就是维护服务实例，并不需要去检索服务</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="comment"># defaultZone: http://eureka7002:7002/eureka/</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001:7001/eureka/</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">      <span class="comment">#关闭自我保护机制，保证不可用服务被及时踢除 添加以下两个属性</span></span><br><span class="line">    <span class="attr">enable-self-preservation:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">eviction-interval-timer-in-ms:</span> <span class="number">2000</span> <span class="comment"># 收心跳包的间隔时间 ms</span></span><br></pre></td></tr></table></figure>

<p>修改8001的yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line"><span class="comment">#      defaultZone: http://localhost:7001/eureka/,http://eureka7002:7002/eureka/</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka/</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">payment8001</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span> <span class="comment"># 显示ip地址</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment"># ---------------添加以下两个属性</span></span><br><span class="line">    <span class="comment">#Eureka客户端向服务端发送心跳的时间间隔，单位为秒(默认是30秒)</span></span><br><span class="line">    <span class="attr">lease-renewal-interval-in-seconds:</span> <span class="number">1</span></span><br><span class="line">    <span class="comment">#Eureka服务端在收到最后一次心跳后等待时间上限，单位为秒(默认是90秒)，超时将剔除服务</span></span><br><span class="line">    <span class="attr">lease-expiration-duration-in-seconds:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>

<p><strong>测试</strong></p>
<p>关闭之后再访问eureka7001就会出现以下提示，提醒自我保护机制已经关闭了</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200523225802348.png" alt="image-20200523225802348"></p>
<p>关闭自我保护机制后，如果8001出现宕机或者网络延迟较久的话，7001就会立刻删除这个服务</p>
<h1 id="三、zookeeper服务注册与发现"><a href="#三、zookeeper服务注册与发现" class="headerlink" title="三、zookeeper服务注册与发现"></a>三、zookeeper服务注册与发现</h1><h2 id="使用zookeeper代替eureka"><a href="#使用zookeeper代替eureka" class="headerlink" title="使用zookeeper代替eureka"></a>使用zookeeper代替eureka</h2><h3 id="将订单服务提供者注册进zookeeper"><a href="#将订单服务提供者注册进zookeeper" class="headerlink" title="将订单服务提供者注册进zookeeper"></a>将订单服务提供者注册进zookeeper</h3><h4 id="启动zookeeper"><a href="#启动zookeeper" class="headerlink" title="启动zookeeper"></a>启动zookeeper</h4><p>看之前的zookeeper笔记</p>
<h4 id="新建cloud-provider-payment8004"><a href="#新建cloud-provider-payment8004" class="headerlink" title="新建cloud-provider-payment8004"></a>新建cloud-provider-payment8004</h4><p>参考8001</p>
<h4 id="修改pom文件-加入zookeeper的jar包"><a href="#修改pom文件-加入zookeeper的jar包" class="headerlink" title="修改pom文件, 加入zookeeper的jar包"></a>修改pom文件, 加入zookeeper的jar包</h4><p><strong>注意：因为spring-cloud-starter-zookeeper-discovery中会自带zookeeper3.5.3的jar包，如果测试的时候出现错误，请排除掉它自带的那个jar包，添加一个和安装的zookeeper版本相同的jar包</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- SpringBoot整合Web组件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span><span class="comment">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ll.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- SpringBoot整合zookeeper客户端 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zookeeper-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--先排除自带的zookeeper3.5.3--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.zookeeper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--添加zookeeper3.6.1版本--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.zookeeper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.6.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="yml"><a href="#yml" class="headerlink" title="yml"></a><strong>yml</strong></h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8004</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-payment-service</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">zookeeper:</span></span><br><span class="line">      <span class="attr">connect-string:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.108</span><span class="string">:2181</span> <span class="comment"># 连接zookeeper的ip和端口号</span></span><br></pre></td></tr></table></figure>

<h4 id="测试-5"><a href="#测试-5" class="headerlink" title="测试"></a><strong>测试</strong></h4><p>使用zkCli连接，查看根节点下是否出现了services节点，services节点下是否出现了刚刚注册的服务名称，服务名称下应该还会有一个序列号，查看序列号里的内容，如果里面的内容和配置对的上就ok啦。</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200524100642945.png" alt="image-20200524100642945"></p>
<h3 id="将服务消费者注册到zookeeper中"><a href="#将服务消费者注册到zookeeper中" class="headerlink" title="将服务消费者注册到zookeeper中"></a>将服务消费者注册到zookeeper中</h3><h4 id="创建cloud-customer-zk-order80"><a href="#创建cloud-customer-zk-order80" class="headerlink" title="创建cloud-customer-zk-order80"></a>创建cloud-customer-zk-order80</h4><p>参考80</p>
<p>其他步骤参考8004和代码，溜了</p>
<p>测试成功后znode里面会出现注册进去的服务</p>
<h1 id="四、consul服务注册与发现"><a href="#四、consul服务注册与发现" class="headerlink" title="四、consul服务注册与发现"></a>四、consul服务注册与发现</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><h3 id="官网"><a href="#官网" class="headerlink" title="官网"></a>官网</h3><p><a target="_blank" rel="noopener" href="https://www.consul.io/">https://www.consul.io/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.springcloud.cc/spring-cloud-consul.html">中文文档</a></p>
<h3 id="是什么"><a href="#是什么" class="headerlink" title="是什么"></a>是什么</h3><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200524103853662.png" alt="image-20200524103853662"></p>
<h3 id="能干嘛"><a href="#能干嘛" class="headerlink" title="能干嘛"></a>能干嘛</h3><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200524104040484.png" alt="image-20200524104040484"></p>
<h3 id="去哪下"><a href="#去哪下" class="headerlink" title="去哪下"></a>去哪下</h3><p><a target="_blank" rel="noopener" href="https://www.consul.io/downloads">https://www.consul.io/downloads</a></p>
<h2 id="安装并运行consul"><a href="#安装并运行consul" class="headerlink" title="安装并运行consul"></a>安装并运行consul</h2><p>下载liunx或windows版的consul</p>
<p>步骤都一样</p>
<ul>
<li><p>解压文件</p>
<ul>
<li>linux解压命令: <code>unzip zip文件</code></li>
</ul>
</li>
<li><p>放到一个全英文的路径里面去</p>
</li>
<li><p>控制台输入 ./consul –version 查看是否成功</p>
</li>
<li><p>启动：<code>./consul agent -dev</code></p>
</li>
</ul>
<p>ps: windows的就不要./了</p>
<p>启动之后输入ip:8500就ok啦</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200524110833439.png" alt="image-20200524110833439"></p>
<h2 id="服务提供者"><a href="#服务提供者" class="headerlink" title="服务提供者"></a>服务提供者</h2><h3 id="新建cloud-provider-payment8006"><a href="#新建cloud-provider-payment8006" class="headerlink" title="新建cloud-provider-payment8006"></a>新建cloud-provider-payment8006</h3><p>参考8004</p>
<h3 id="pom"><a href="#pom" class="headerlink" title="pom"></a>pom</h3><p>注意：spring-boot-starter-actuator一定要导入，不然会有一个红叉叉</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- SpringBoot整合Web组件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span><span class="comment">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ll.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- SpringBoot整合zookeeper客户端 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-consul-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="yml-1"><a href="#yml-1" class="headerlink" title="yml"></a>yml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8006</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-payment-service</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">service-name:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="测试-6"><a href="#测试-6" class="headerlink" title="测试"></a>测试</h3><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200524113640405.png" alt="image-20200524113640405"></p>
<h2 id="服务消费者"><a href="#服务消费者" class="headerlink" title="服务消费者"></a>服务消费者</h2><p>参考zookeeper的80，具体的看代码，这里就不写了</p>
<h3 id="pom-1"><a href="#pom-1" class="headerlink" title="pom"></a>pom</h3><p>和8006的一样</p>
<h3 id="yaml"><a href="#yaml" class="headerlink" title="yaml"></a>yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-order-service</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">service-name:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">my-config:</span></span><br><span class="line">  <span class="attr">cloud-payment-url:</span> <span class="string">http://cloud-payment-service</span></span><br></pre></td></tr></table></figure>

<h2 id="三个注册中心的异同点"><a href="#三个注册中心的异同点" class="headerlink" title="三个注册中心的异同点"></a>三个注册中心的异同点</h2><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200524125743220.png" alt="image-20200524125743220"></p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200524125945132.png" alt="image-20200524125945132"></p>
<h1 id="五、Ribbon负载均衡服务调用"><a href="#五、Ribbon负载均衡服务调用" class="headerlink" title="五、Ribbon负载均衡服务调用"></a>五、Ribbon负载均衡服务调用</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><h3 id="是什么-1"><a href="#是什么-1" class="headerlink" title="是什么"></a>是什么</h3><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200524130743392.png" alt="image-20200524130743392"></p>
<h2 id="核心组件IRule"><a href="#核心组件IRule" class="headerlink" title="核心组件IRule"></a>核心组件IRule</h2><p>IRule算法：</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200524132523252.png" alt="image-20200524132523252"></p>
<h2 id="如何替换"><a href="#如何替换" class="headerlink" title="如何替换"></a>如何替换</h2><p>测试前提：要订单服务提供者的集群，不然看不出效果</p>
<h3 id="修改order80"><a href="#修改order80" class="headerlink" title="修改order80"></a>修改order80</h3><p>添加一个配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySelfRule</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IRule <span class="title">iRule</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RandomRule(); <span class="comment">// 定义为随机</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：这个类不能被@ComponentScan给扫描到，否则这个规则会被所有的ribbon给扫描到，就达不到私有化定制的目的了</p>
<p>说人话就是：不要放在主配置类下面（因为@SpringBootApplication里面就有@ComponentScan）</p>
</blockquote>
<p>像这样，放在主配置类外面，不要和他同包，也不要放在同包的子包里面</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200524135705933.png" alt="image-20200524135705933"></p>
<p>最后给主配置类加上如下注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="comment">// 加我加我，看看孩子；name是需要定制规则的那个服务名称，configuration就是自定义的规则类</span></span><br><span class="line"><span class="meta">@RibbonClient(name = &quot;CLOUD-PAYMENT-SERVICE&quot;, configuration = MySelfRule.class)</span> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderMain80</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(OrderMain80.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试自己测，如果8001和8002的标识（标识前面加过了）随机出现就对了</p>
<h2 id="Ribbon负载均衡算法"><a href="#Ribbon负载均衡算法" class="headerlink" title="Ribbon负载均衡算法"></a>Ribbon负载均衡算法</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200524140916349.png" alt="image-20200524140916349"></p>
<h1 id="六、OpenFeign服务接口调用"><a href="#六、OpenFeign服务接口调用" class="headerlink" title="六、OpenFeign服务接口调用"></a>六、OpenFeign服务接口调用</h1><h2 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h2><h3 id="是什么-2"><a href="#是什么-2" class="headerlink" title="是什么"></a>是什么</h3><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200524144034245.png" alt="image-20200524144034245"></p>
<h3 id="能干嘛-1"><a href="#能干嘛-1" class="headerlink" title="能干嘛"></a>能干嘛</h3><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200524144259064.png" alt="image-20200524144259064"></p>
<h3 id="OpenFegin和Fegin两者之间的区别"><a href="#OpenFegin和Fegin两者之间的区别" class="headerlink" title="OpenFegin和Fegin两者之间的区别"></a>OpenFegin和Fegin两者之间的区别</h3><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200524144717167.png" alt="image-20200524144717167"></p>
<h2 id="OpenFeign使用步骤"><a href="#OpenFeign使用步骤" class="headerlink" title="OpenFeign使用步骤"></a>OpenFeign使用步骤</h2><h3 id="新建cloud-customer-openfeign-order80"><a href="#新建cloud-customer-openfeign-order80" class="headerlink" title="新建cloud-customer-openfeign-order80"></a>新建cloud-customer-openfeign-order80</h3><p>参考cloud-customer-order80</p>
<h4 id="pom-2"><a href="#pom-2" class="headerlink" title="pom"></a>pom</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--openfeign--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--eureka client--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ll.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--web--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--一般基础通用配置--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="yml-2"><a href="#yml-2" class="headerlink" title="yml"></a>yml</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-order-service</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka/,http://eureka7002:7002/eureka/</span> <span class="comment"># 也可以不配集群</span></span><br></pre></td></tr></table></figure>

<h4 id="添加一个service"><a href="#添加一个service" class="headerlink" title="添加一个service"></a>添加一个service</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="comment">// 标注是哪个服务里面的</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;CLOUD-PAYMENT-SERVICE&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PaymentFeignService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/&#123;id&#125;&quot;)</span> <span class="comment">// 这个需要和订单提供者的请求地址一样</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title">getPlaymentById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="修改controller"><a href="#修改controller" class="headerlink" title="修改controller"></a>修改controller</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PaymentFeignService paymentFeignService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/order/payment/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult <span class="title">getPaymentById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span></span>&#123;</span><br><span class="line">        <span class="comment">// 直接调用service</span></span><br><span class="line">        <span class="keyword">return</span> paymentFeignService.getPlaymentById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="修改主配置类"><a href="#修改主配置类" class="headerlink" title="修改主配置类"></a>修改主配置类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="comment">// 加我(*^▽^*)开启功能</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderFeignMain80</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(OrderFeignMain80.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="测试-7"><a href="#测试-7" class="headerlink" title="测试"></a>测试</h4><p>还是和以前一样测一下接口能不能访问得到就好啦</p>
<h2 id="OpenFeign超时控制"><a href="#OpenFeign超时控制" class="headerlink" title="OpenFeign超时控制"></a>OpenFeign超时控制</h2><p>openFeign默认超时时间为1秒钟，如果超时就会报错。这里在订单服务提供方那里写了个等待3秒的方法。具体的看代码</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200524153136502.png" alt="image-20200524153136502"></p>
<h3 id="怎么解决"><a href="#怎么解决" class="headerlink" title="怎么解决"></a>怎么解决</h3><p>由于openfeign底层是使用的ribbon来做的管理，所以可以通过配置ribbon来解决</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在80的yml中加入以下配置</span></span><br><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="comment"># 指的是建立连接后从服务器读取到可用资源所用的时间</span></span><br><span class="line">  <span class="attr">ReadTimeout:</span> <span class="number">5000</span> <span class="comment"># 因为8001延迟三秒，所以这边也加长一点</span></span><br><span class="line">  <span class="comment"># 指的是建立连接所用的时间，适用于网络状况正常的情况下,两端连接所用的时间</span></span><br><span class="line">  <span class="attr">ConnectTimeout:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure>



<h2 id="OpenFeign日志打印功能"><a href="#OpenFeign日志打印功能" class="headerlink" title="OpenFeign日志打印功能"></a>OpenFeign日志打印功能</h2><h3 id="日志级别"><a href="#日志级别" class="headerlink" title="日志级别"></a>日志级别</h3><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200524154834154.png" alt="image-20200524154834154"></p>
<h3 id="开启步骤"><a href="#开启步骤" class="headerlink" title="开启步骤"></a>开启步骤</h3><p>以下修改都是在80里面修改的</p>
<h3 id="向容器中注入Logger-Level"><a href="#向容器中注入Logger-Level" class="headerlink" title="向容器中注入Logger.Level"></a>向容器中注入Logger.Level</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FeignConfig</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    Logger.<span class="function">Level <span class="title">feignLoggerLevel</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Logger.Level.FULL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="修改yml-3"><a href="#修改yml-3" class="headerlink" title="修改yml"></a>修改yml</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加以下配置</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="comment"># feign日志以什么级别监控哪个接口</span></span><br><span class="line">    <span class="attr">com.ll.springcloud.service.PaymentFeignService:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure>

<h3 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h3><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200524155826147.png" alt="image-20200524155826147"></p>
<h1 id="七、Hystrix"><a href="#七、Hystrix" class="headerlink" title="七、Hystrix"></a>七、Hystrix</h1><h2 id="概述-2"><a href="#概述-2" class="headerlink" title="概述"></a>概述</h2><h3 id="分布式系统面临的问题"><a href="#分布式系统面临的问题" class="headerlink" title="分布式系统面临的问题"></a>分布式系统面临的问题</h3><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200524160650509.png" alt="image-20200524160650509"></p>
<h3 id="是什么-3"><a href="#是什么-3" class="headerlink" title="是什么"></a>是什么</h3><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200524160815102.png" alt="image-20200524160815102"></p>
<h2 id="star2-Hystrix重要概念"><a href="#star2-Hystrix重要概念" class="headerlink" title=":star2:Hystrix重要概念"></a>:star2:Hystrix重要概念</h2><h3 id="服务降级"><a href="#服务降级" class="headerlink" title="服务降级"></a>服务降级</h3><blockquote>
<p>  服务器忙，请稍后再试，不让客户端等待并立刻返回一个友好提示， fallback</p>
</blockquote>
<p><strong>哪些情况会出现服务降级</strong></p>
<ul>
<li><p>  程序运行异常</p>
</li>
<li><p>  超时</p>
</li>
<li><p>  服务熔断触发服务降级</p>
</li>
<li><p>  线程池/信号量打满也会导致服务降级</p>
</li>
</ul>
<h3 id="服务熔断"><a href="#服务熔断" class="headerlink" title="服务熔断"></a>服务熔断</h3><blockquote>
<p>  类比保险丝达到最大服务访问后，直接拒绝访问，拉闸限电然后调用服务降级的方法并返回友好提示</p>
<p>  服务的降级 -&gt; 进而熔断 -&gt;恢复调用链路</p>
</blockquote>
<h3 id="服务限流"><a href="#服务限流" class="headerlink" title="服务限流"></a>服务限流</h3><h2 id="star2-Hystrix案例"><a href="#star2-Hystrix案例" class="headerlink" title=":star2:Hystrix案例"></a>:star2:Hystrix案例</h2><h3 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h3><h4 id="创建cloud-provider-hystrix-payment8001"><a href="#创建cloud-provider-hystrix-payment8001" class="headerlink" title="创建cloud-provider-hystrix-payment8001"></a>创建cloud-provider-hystrix-payment8001</h4><p>参考8001</p>
<h4 id="pom-3"><a href="#pom-3" class="headerlink" title="pom"></a>pom</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--hystrix--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--eureka client--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--web--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span><span class="comment">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ll.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="yml-3"><a href="#yml-3" class="headerlink" title="yml"></a>yml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-payment-service</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line"><span class="comment">#      defaultZone: http://localhost:7001/eureka/,http://eureka7002:7002/eureka/</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka/</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">payment8001</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span> <span class="comment"># 显示ip地址</span></span><br></pre></td></tr></table></figure>

<h4 id="测试-8"><a href="#测试-8" class="headerlink" title="测试"></a>测试</h4><p>记得写controller再测试，只要能访问成功就好啦:laughing:</p>
<h3 id="高并发测试"><a href="#高并发测试" class="headerlink" title="高并发测试"></a>高并发测试</h3><h4 id="jmeter压测测试"><a href="#jmeter压测测试" class="headerlink" title="jmeter压测测试"></a>jmeter压测测试</h4><p>用jmeter测试，使用200个线程访问100次，也就是两万个请求去访问8001，这时候再在网页上发起请求可以看到有明显的卡顿了</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/1.gif"></p>
<h4 id="看热闹不嫌事大，加入80"><a href="#看热闹不嫌事大，加入80" class="headerlink" title="看热闹不嫌事大，加入80"></a>看热闹不嫌事大，加入80</h4><h5 id="新建一个cloud-consumer-feign-hystrix-order80"><a href="#新建一个cloud-consumer-feign-hystrix-order80" class="headerlink" title="新建一个cloud-consumer-feign-hystrix-order80"></a>新建一个cloud-consumer-feign-hystrix-order80</h5><p>参考之前的80</p>
<h5 id="pom-4"><a href="#pom-4" class="headerlink" title="pom"></a>pom</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--openfeign--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--hystrix--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--eureka client--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ll.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--web--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--一般基础通用配置--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="yml-4"><a href="#yml-4" class="headerlink" title="yml"></a>yml</h5><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-order-service</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka/</span></span><br></pre></td></tr></table></figure>

<p>controller里面访问8001，具体的看代码</p>
<p>将80启动，我们再启动jmeter去压测8001，同时我们在网页去访问80，因为80调用了8001，所以80的调8001的那个服务响应的时间也变慢了，如果运气好的话还可能会碰到超时，因为feign默认是超时时间是1秒</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200525084915511.png" alt="image-20200525084915511"></p>
<h3 id="故障现象和导致原因"><a href="#故障现象和导致原因" class="headerlink" title="故障现象和导致原因"></a>故障现象和导致原因</h3><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200525085220088.png" alt="image-20200525085220088"></p>
<h3 id="上述结论"><a href="#上述结论" class="headerlink" title="上述结论"></a>上述结论</h3><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200525090403534.png" alt="image-20200525090403534"></p>
<h3 id="如何解决？解决的要求"><a href="#如何解决？解决的要求" class="headerlink" title="如何解决？解决的要求"></a>如何解决？解决的要求</h3><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200525090301764.png" alt="image-20200525090301764"></p>
<h3 id="star-服务降级"><a href="#star-服务降级" class="headerlink" title=":star:服务降级"></a>:star:服务降级</h3><h4 id="降级配置"><a href="#降级配置" class="headerlink" title="降级配置"></a>降级配置</h4><p>使用@HystrixCommand</p>
<h4 id="8001自身"><a href="#8001自身" class="headerlink" title="8001自身"></a>8001自身</h4><p>设置自身超时时间峰值，峰值内正常运行，超过了需要有兜底方案，做服务降级fallbake</p>
<h4 id="8001fallback"><a href="#8001fallback" class="headerlink" title="8001fallback"></a>8001fallback</h4><p>修改service</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentService</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 使用@HystrixCommand来指定兜底方案，当发生异常会自动调用timeoutHandle</span></span><br><span class="line">    <span class="meta">@HystrixCommand(fallbackMethod = &quot;timeoutHandle&quot;, commandProperties = &#123;</span></span><br><span class="line"><span class="meta">        	// 这里设置超时时间</span></span><br><span class="line"><span class="meta">            @HystrixProperty(name=&quot;execution.isolation.thread.timeoutInMilliseconds&quot;, value = &quot;3000&quot;)</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">timeout</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> timeout = <span class="number">5</span>;</span><br><span class="line">        <span class="comment">// 这里故意弄一个异常</span></span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">10</span>/<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 超时5秒</span></span><br><span class="line">            TimeUnit.SECONDS.sleep(timeout);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> UUID.randomUUID().toString()+<span class="string">&quot;  超时&quot;</span>+timeout+<span class="string">&quot;秒&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">timeoutHandle</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;呜呜呜，系统繁忙&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">ok</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ok   &quot;</span>+UUID.randomUUID().toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：使用@HystrixCommand需要在主配置类中添加@EnableCircuitBreaker注解开启功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableCircuitBreaker</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentHystrisMain8001</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(PaymentHystrisMain8001.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="80fallbake"><a href="#80fallbake" class="headerlink" title="80fallbake"></a>80fallbake</h4><h5 id="题外话"><a href="#题外话" class="headerlink" title="题外话"></a>题外话</h5><p>我们自己配置过的热部署方式对ava代码的改动明显，</p>
<p>但对＠Hystrix Command内属性的修改建议重启微服务</p>
<h5 id="业务类-1"><a href="#业务类-1" class="headerlink" title="业务类"></a>业务类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/order/payment/timeout&quot;)</span></span><br><span class="line"><span class="meta">@HystrixCommand(fallbackMethod = &quot;timeoutHandle&quot;, commandProperties = &#123;</span></span><br><span class="line"><span class="meta">    @HystrixProperty(name=&quot;execution.isolation.thread.timeoutInMilliseconds&quot;, value = &quot;2000&quot;)</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">timeout</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> paymentFeignService.timeout();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">timeoutHandle</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;qwq&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="主配置类"><a href="#主配置类" class="headerlink" title="主配置类"></a>主配置类</h5><p>添加@EnableHystrix注解，开启功能</p>
<h4 id="目前问题"><a href="#目前问题" class="headerlink" title="目前问题"></a>目前问题</h4><p>每个业务方法对应一个兜底的方法，代码膨胀</p>
<p>统一和自定义的分开</p>
<h4 id="解决问题"><a href="#解决问题" class="headerlink" title="解决问题"></a>解决问题</h4><h5 id="每个方法配置一个？？？膨胀"><a href="#每个方法配置一个？？？膨胀" class="headerlink" title="每个方法配置一个？？？膨胀"></a>每个方法配置一个？？？膨胀</h5><p><strong>＠Default Properties（defaultFallback=““）</strong></p>
<p><strong>说明：</strong></p>
<blockquote>
<p>  1:1每个方法配置一个服务降级方法，技术上可以，实际上傻X</p>
<p>  1:N除了个别重要核心业务有专属，其它普通的可以通过＠ DefaultProperties（default Fallback=“）统一跳转到统—处理结果页面</p>
<p>  通用的和独享的各自分开，避兔了代码膨胀，合理减少了代码量</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="comment">// 加上这个注解配置全局属性，这里配置了一个默认的处理方法</span></span><br><span class="line"><span class="meta">@DefaultProperties(defaultFallback = &quot;globalHandle&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PaymentFeignService paymentFeignService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/order/payment/ok&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">ok</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> paymentFeignService.ok();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/order/payment/timeout&quot;)</span></span><br><span class="line"><span class="comment">//    @HystrixCommand(fallbackMethod = &quot;timeoutHandle&quot;, commandProperties = &#123;</span></span><br><span class="line"><span class="comment">//            @HystrixProperty(name=&quot;execution.isolation.thread.timeoutInMilliseconds&quot;, value = &quot;2000&quot;)</span></span><br><span class="line"><span class="comment">//    &#125;)</span></span><br><span class="line">    <span class="meta">@HystrixCommand</span> <span class="comment">// 当未指定fallbackMethod的时候就会调用默认的</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">timeout</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> paymentFeignService.timeout();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">timeoutHandle</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;qwq&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">globalHandle</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;全局处理异常&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h5 id="和业务逻辑混一起？？？混乱"><a href="#和业务逻辑混一起？？？混乱" class="headerlink" title="和业务逻辑混一起？？？混乱"></a>和业务逻辑混一起？？？混乱</h5><ul>
<li><p>  服务降级，客户端去调用服务端，碰上服务端宕机或关闭</p>
</li>
<li><p>本次案例服务降级处理是在客户端80实现完成的，与服务端8001没有关系</p>
<p>  只需要为 Feign客户端定义的接口添加一个服务降级处理的实现类即可实现解耦</p>
</li>
<li><p>未来我们要面对的异常</p>
<ul>
<li>  运行</li>
<li>  超时</li>
<li>  宕机</li>
</ul>
</li>
</ul>
<p><strong>修改cloud-consumer-feign-hystrix-order80</strong></p>
<blockquote>
<p>  根据cloud-consumer-feign-hystrix-order80已经有的PaymentHystrixService接口，重新新建一个类（ <strong>PaymentFallbackService</strong>）实现该接口，统一为接口里面的方法进行异常处理</p>
</blockquote>
<ul>
<li><p><strong>yml</strong></p>
<ul>
<li>```yml<br>  feign:<pre><code>hystrix:
  enabled: true # 开启feign对hystrix的支持
</code></pre>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">+   PaymentFallbackService</span><br><span class="line"></span><br><span class="line">    +   &#96;&#96;&#96;java</span><br><span class="line">        @Component</span><br><span class="line">        public class PaymentFallbackService implements PaymentFeignService &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public String ok() &#123;</span><br><span class="line">                return &quot;not ok!!! qwq&quot;;</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">            @Override</span><br><span class="line">            public String timeout() &#123;</span><br><span class="line">                return &quot;timeout qwq&quot;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>PaymentFeignService接口</p>
<ul>
<li>```java<br>  @Component<br>  // 添加一个fallback属性，指定出现异常时的兜底方案<br>  @FeignClient(value = “CLOUD-PAYMENT-SERVICE”, fallback = PaymentFallbackService.class)<br>  public interface PaymentFeignService {<pre><code>  @GetMapping(&quot;/payment/ok&quot;)
  String ok();

  @GetMapping(&quot;/payment/timeout&quot;)
  String timeout();
</code></pre>
  }  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### :star:服务熔断</span><br><span class="line"></span><br><span class="line">#### 是什么</span><br><span class="line"></span><br><span class="line">&gt;   熔断机制概述</span><br><span class="line">&gt;</span><br><span class="line">&gt;   熔断机制是应对雪崩效应的种微服务链路保护机制。当扇岀链路的某个微服务出错不可用或者晌应时间太长时，</span><br><span class="line">&gt;</span><br><span class="line">&gt;   会进行服务的降级，进而熔断该节点微服务的调用，快速返回错误的响应信息。</span><br><span class="line">&gt;</span><br><span class="line">&gt;   当检测到该节点微服务调用响应正常后，恢复调用链路</span><br><span class="line">&gt;</span><br><span class="line">&gt;   在 Spring Cloud框架里，熔断机制通过 Hystrix实现。 Hystrix会监控微服务间调用的状况，</span><br><span class="line">&gt;</span><br><span class="line">&gt;   当失败的调用到一定阈值，缺省是5秒内20次调用失败，就会启动熔断机制。熔断机制的注解是＠HystrixCommand。</span><br><span class="line"></span><br><span class="line">#### 实操</span><br><span class="line"></span><br><span class="line">**修改coud-provider-hystrix-payment8001**</span><br><span class="line"></span><br><span class="line">+   PaymentService</span><br><span class="line"></span><br><span class="line">    在PaymentService添加以下方法</span><br><span class="line"></span><br><span class="line">    &#96;&#96;&#96;java</span><br><span class="line">    &#x2F;&#x2F;--------服务熔断</span><br><span class="line">    @HystrixCommand(fallbackMethod &#x3D; &quot;paymentCircuitBreaker_fallback&quot;,commandProperties &#x3D; &#123;</span><br><span class="line">        @HystrixProperty(name &#x3D; &quot;circuitBreaker.enabled&quot;,value &#x3D; &quot;true&quot;),&#x2F;&#x2F; 是否开启断路器</span><br><span class="line">        @HystrixProperty(name &#x3D; &quot;circuitBreaker.requestVolumeThreshold&quot;,value &#x3D; &quot;10&quot;),&#x2F;&#x2F; 请求次数</span><br><span class="line">        @HystrixProperty(name &#x3D; &quot;circuitBreaker.sleepWindowInMilliseconds&quot;,value &#x3D; &quot;10000&quot;), &#x2F;&#x2F; 时间窗口期</span><br><span class="line">        @HystrixProperty(name &#x3D; &quot;circuitBreaker.errorThresholdPercentage&quot;,value &#x3D; &quot;60&quot;),&#x2F;&#x2F; 失败率达到多少后跳闸</span><br><span class="line">    &#125;)</span><br><span class="line">    public String paymentCircuitBreaker(Integer id)</span><br><span class="line">    &#123;</span><br><span class="line">        if(id &lt; 0)</span><br><span class="line">        &#123;</span><br><span class="line">            throw new RuntimeException(&quot;******id 不能负数&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        String serialNumber &#x3D; IdUtil.simpleUUID();</span><br><span class="line">    </span><br><span class="line">        return Thread.currentThread().getName()+&quot;\t&quot;+&quot;调用成功，流水号: &quot; + serialNumber;</span><br><span class="line">    &#125;</span><br><span class="line">    public String paymentCircuitBreaker_fallback(Integer id)</span><br><span class="line">    &#123;</span><br><span class="line">        return &quot;id 不能负数，请稍后再试，&#x2F;(ㄒoㄒ)&#x2F;~~   id: &quot; +id;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>PaymentController</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/payment/break/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">breaker</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> paymentService.paymentCircuitBreaker(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>  测试：在10次请求中如果有6次及以上的错误，就会触发熔断，这时再次发送正确的请求也会返回fallbake提示</p>
</li>
</ul>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p><strong>熔断类型：</strong></p>
<ul>
<li><p>  熔断打开：请求不再进行调用当前服务，内部设罩时钟一般为MTTR（平均故障处理时间），当打开时长达到所设时钟则进入半熔断状态</p>
</li>
<li><p>  熔断关闭：熔断关闭不会对服务进行熔断</p>
</li>
<li><p>  熔断半开：部分请求根据规则调用当前服务，如果请求成功且符合规则则认为当前服务恢复正常，关闭熔断</p>
</li>
</ul>
<h4 id="官网断路器流程"><a href="#官网断路器流程" class="headerlink" title="官网断路器流程"></a>官网断路器流程</h4><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200525113443796.png" alt="image-20200525113443796"></p>
<h5 id="断路器在什么状态下起作用"><a href="#断路器在什么状态下起作用" class="headerlink" title="断路器在什么状态下起作用"></a>断路器在什么状态下起作用</h5><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200525113549607.png" alt="image-20200525113549607"></p>
<h5 id="断路器开启或关闭的条件"><a href="#断路器开启或关闭的条件" class="headerlink" title="断路器开启或关闭的条件"></a>断路器开启或关闭的条件</h5><ol>
<li><p> 当满足一定的阀值的时候（默认10秒内超过20个请求次数）</p>
</li>
<li><p> 当失败率达到一定的时候（默认10秒内超过50％的请求失败）</p>
</li>
<li><p> 到达以上阀值，断路器将会开启</p>
</li>
<li><p> 当开启的时候，所有请求都不会进行转发</p>
</li>
<li><p> 一段时间之后（默认是5秒），这个时候断路器是半开状态，会让其中一个请求进行转发。</p>
</li>
<li><p> 如果成功，断路器会关闭，若失败，继续开启。重复4和5</p>
</li>
</ol>
<h5 id="断路器打开之后"><a href="#断路器打开之后" class="headerlink" title="断路器打开之后"></a>断路器打开之后</h5><ol>
<li><p> 再有请求调用的时候，将不会调用主逻辑，而是直接调用降级 fallback。通过断路器，实现了自动地发现错误并将降级逻辑切换为主逻辑，减少晌应延迟的效果</p>
</li>
<li><p>原来的主逻辑要如何恢复呢？</p>
<p> 对于这一问题， hystrix也为我们实现了自动恢复功能。当断路器打开，对主逻辑进行熔断之后， hystrix会启动—个休眠时间窗，在这个时间窗内，降级逻辑是临时的成为主逻辑，当休眠时间窗到期，断路器将进入半开状态，释放一次请求到原来的主逻辑上，如果此次请求正常返回，那么断路器将会闭合，主逻辑恢复，如果这次请求依然有问题，断路器继续进入打开状态，休眠时间窗重新计时。</p>
</li>
</ol>
<h3 id="服务监控-hystrixDashboard"><a href="#服务监控-hystrixDashboard" class="headerlink" title="服务监控 hystrixDashboard"></a>服务监控 hystrixDashboard</h3><h4 id="概述-3"><a href="#概述-3" class="headerlink" title="概述"></a>概述</h4><blockquote>
<p>  除了隔离依赖服务的调用以外, Hystriⅸ还提供了准实时的调用监控( Hystrix Dashboard), Hystrix会持续地记录所有通过 Hystⅸ发  起的请求的执行信息,并以统计报表和图形的形式展示给用户,包括每秒执行多少请求多少成功,多少失败等。 Netflix通过  hystrix-metrIcs-event-stream项目实现了对以上指标的监控。 Spring Cloud也提供了 Hystrix Dashboard的整合,对监控内容转化成可视化界面。</p>
</blockquote>
<h4 id="仪表盘9001"><a href="#仪表盘9001" class="headerlink" title="仪表盘9001"></a>仪表盘9001</h4><ol>
<li><p><strong>新建cloud-consumer-hystrixdashboard9001</strong></p>
<ol>
<li><p>```xml</p>
 <dependency>
     <groupId>org.springframework.cloud</groupId>
     <artifactId>spring-cloud-starter-netflix-hystrix-dashboard</artifactId>
 </dependency>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">2.  &#96;&#96;&#96;yaml</span><br><span class="line">    server:</span><br><span class="line">      port: 9001</span><br></pre></td></tr></table></figure></li>
<li><p>```java<br> @SpringBootApplication<br> // 使用这个注解开启Hystrix图形监控功能<br> @EnableHystrixDashboard<br> public class HystrixDashboardMain9001 {</p>
<pre><code> public static void main(String[] args) &#123;
     SpringApplication.run(HystrixDashboardMain9001.class, args);
 &#125;
</code></pre>
<p> }</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">    4.  访问：http:&#x2F;&#x2F;localhost:9001&#x2F;hystrix</span><br><span class="line"></span><br><span class="line">        如果出现以下界面则成功</span><br><span class="line"></span><br><span class="line">        ![image-20200525155420212](README.assets&#x2F;image-20200525155420212.png)</span><br><span class="line"></span><br><span class="line">#### 断路器演示(服务监控 hystrixDashboard)</span><br><span class="line"></span><br><span class="line">#### 9001监控8001</span><br><span class="line"></span><br><span class="line">**修改8001**</span><br><span class="line"></span><br><span class="line">&gt;   添加这个组件到容器里面</span><br><span class="line">&gt;</span><br><span class="line">&gt;   &#96;&#96;&#96;java</span><br><span class="line">&gt;   &#x2F;**</span><br><span class="line">&gt;        *此配置是为了服务监控而配置，与服务容错本身无关，springcloud升级后的坑</span><br><span class="line">&gt;        *ServletRegistrationBean因为springboot的默认路径不是&quot;&#x2F;hystrix.stream&quot;，</span><br><span class="line">&gt;        *只要在自己的项目里配置上下面的servlet就可以了</span><br><span class="line">&gt;        *&#x2F;</span><br><span class="line">&gt;   @Bean</span><br><span class="line">&gt;   public ServletRegistrationBean getServlet() &#123;</span><br><span class="line">&gt;       HystrixMetricsStreamServlet streamServlet &#x3D; new HystrixMetricsStreamServlet();</span><br><span class="line">&gt;       ServletRegistrationBean registrationBean &#x3D; new ServletRegistrationBean(streamServlet);</span><br><span class="line">&gt;       registrationBean.setLoadOnStartup(1);</span><br><span class="line">&gt;       registrationBean.addUrlMappings(&quot;&#x2F;hystrix.stream&quot;);</span><br><span class="line">&gt;       registrationBean.setName(&quot;HystrixMetricsStreamServlet&quot;);</span><br><span class="line">&gt;       return registrationBean;</span><br><span class="line">&gt;   &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>  如果不加就会出现这个错误<code>Unable to connect to Command Metric Stream.</code></p>
<p>  <img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200525162858622.png" alt="image-20200525162858622"></p>
<p>  测试：在框框里输入要监控的微服务，http://微服务地址/hystrix.stream</p>
<p>  <img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200525163340606.png" alt="image-20200525163340606"></p>
<p>  成功之后就会进入到仪表盘的界面：</p>
<p>  <img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200525163637779.png" alt="image-20200525163637779"></p>
</blockquote>
</li>
</ol>
</li>
</ol>
<h5 id="如何看"><a href="#如何看" class="headerlink" title="如何看"></a>如何看</h5><h6 id="一圈"><a href="#一圈" class="headerlink" title="一圈"></a>一圈</h6><blockquote>
<p>  实心圆:共有两种含义。它通过颜色的变化代表了实例的健康程度,它的健康度从绿色&lt;黄色&lt;橙色&lt;红色递减 </p>
<p>  该实心圆除了颜色的变化之外,它的大小也会根据实例的请求流量发生变化,流量越大该实心圆就越大。所以通过该实心圆的展示,就  可以在大量的实例中快速的发现<strong>故障实例和高压力实例。</strong></p>
</blockquote>
<h6 id="一线"><a href="#一线" class="headerlink" title="一线"></a>一线</h6><p>曲线：用来记录2分钟内流量的相对变化,可以通过它来观察到流量的上升和下降趋势。</p>
<h6 id="整图说明"><a href="#整图说明" class="headerlink" title="整图说明"></a>整图说明</h6><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200525161705175.png" alt="image-20200525161705175"></p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200525161722240.png" alt="image-20200525161722240"></p>
<h3 id="star-服务限流"><a href="#star-服务限流" class="headerlink" title=":star:服务限流"></a>:star:服务限流</h3><h1 id="八、GateWay新一代网关"><a href="#八、GateWay新一代网关" class="headerlink" title="八、GateWay新一代网关"></a>八、GateWay新一代网关</h1><h2 id="概述简介"><a href="#概述简介" class="headerlink" title="概述简介"></a>概述简介</h2><h3 id="是什么-4"><a href="#是什么-4" class="headerlink" title="是什么"></a>是什么</h3><blockquote>
<p>  Gateway是在 Spring生态系统之上构建的AP网关服务,基于 Spring5, Spring Boot2和 Project Reactor等技术  Gateway旨在提供_种简单而有效的方式来对AP进行路由,以提供些强大的过滤器功能,例如:熔断、限流、重试等</p>
<p>  SpringCloud Gateway 是Spring Cloud的一个全新项目，基于Spring 5.0+Spring Boot 2.0和Project Reactor 等技术开发的网关，它旨在为微服务架构提供一种简单有效的统一的API路由管理方式。</p>
<p>  Spring Cloud Gateway作为 Spring Cloud生态系统中的网关,目标是替代zuul,在 Spring Cloud2.0以上版本中,没有对新版本的zuul2.0以上最新高性能版本进行集成,仍然还是使用的zuul 1.x非 Reactor模式的老版本。而为了提升网关的性能, SpringCloud Gateway是基于 WebFluxl框架实现的,而 WebFlux框架底层则使用了高性能的 Reactor模式通信框架Netty</p>
<p>  Spring Cloud Gateway的目标提供统一的路由方式且基于 Filter 链的方式提供了网关基本的功能,例如:安全,监控/指标,和限流</p>
</blockquote>
<p><strong>一句话：</strong> Spring Cloud Gateway使用的 Webflux中的reactor-netty响应式编程组件,底层使用了 Netty 通讯框架。</p>
<h3 id="能干嘛-2"><a href="#能干嘛-2" class="headerlink" title="能干嘛"></a>能干嘛</h3><ul>
<li>  反向代理</li>
<li>  鉴权</li>
<li>  流量</li>
<li>  控制</li>
<li>  熔断</li>
<li>  日志监控</li>
<li>  。。。</li>
</ul>
<h3 id="微服务架构中网关在哪里"><a href="#微服务架构中网关在哪里" class="headerlink" title="微服务架构中网关在哪里"></a>微服务架构中网关在哪里</h3><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200525170114159.png" alt="image-20200525170114159"></p>
<h2 id="三大核心概念"><a href="#三大核心概念" class="headerlink" title="三大核心概念"></a>三大核心概念</h2><h3 id="Route-路由"><a href="#Route-路由" class="headerlink" title="Route(路由)"></a>Route(路由)</h3><p>路由是构建网关的基本模块,它由ID,目标URI,一系列的断言和过滤器组成,如果断言为true则匹配该路由</p>
<h3 id="Predicate-断言"><a href="#Predicate-断言" class="headerlink" title="Predicate(断言)"></a>Predicate(断言)</h3><p>参考的是Java8的java.util.function.Predicate<br>开发人员可以匹配HTTP请求中的所有内容（例如请求头或请求参数），如果请求与断言相匹配则进行路由</p>
<h3 id="Filter-过滤"><a href="#Filter-过滤" class="headerlink" title="Filter(过滤)"></a>Filter(过滤)</h3><p>指的是 Spring框架中 Gateway Filter的实例,使用过滤器,可以在请求被路由前或者之后对请求进行修改。</p>
<h3 id="总体"><a href="#总体" class="headerlink" title="总体"></a>总体</h3><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200525171426906.png" alt="image-20200525171426906"></p>
<p>web请求，通过一些匹配条件，定位到真止的服务节点。并在这个转发过程的前后，进行一些精细化控制。<br>predicate就是我们的匹配条件；而filter，就可以理解为一个无所不能的拦截器。有了这两个元素，再加上目标uri，就可以实现一个具体的路由了</p>
<h2 id="Gateway工作流程"><a href="#Gateway工作流程" class="headerlink" title="Gateway工作流程"></a>Gateway工作流程</h2><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200525171907990.png" alt="image-20200525171907990"></p>
<blockquote>
<p>  客户端向 Spring Cloud Gateway发出请求。然后在 Gateway Handler Mapping中找到与请求相匹配的路由,将其发送到 Gateway  Web Handler.      </p>
<p>  Handler再通过指定的过滤器链来将请求发送到我们实际的服务执行业务逻辑,然后返回。  </p>
<p>  过滤器之间用虚线分开是因为过滤器可能会在发送代理请求之前(“pre”)或之后(post”)执行业务逻辑。      </p>
<p>  Filter在“pre”类型的过滤器可以做参数校验、权限校验、流量监控、日志输出、协议转换等,  在“post类型的过滤器中可以做响应内容、响应头的修改,日志的输出,流量监控等有着非常重要的作用。</p>
</blockquote>
<p><strong>核心逻辑：</strong> 路由转发+执行过滤器链</p>
<h2 id="入门配置"><a href="#入门配置" class="headerlink" title="入门配置"></a>入门配置</h2><h3 id="新建-Module"><a href="#新建-Module" class="headerlink" title="新建 Module"></a>新建 Module</h3><p>cloud-gateway-gateway9527</p>
<h4 id="POM"><a href="#POM" class="headerlink" title="POM"></a>POM</h4><p><strong>注意：gateway不需要web和actuator包</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--gateway--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--eureka-client--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ll.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--一般基础配置类--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="YML"><a href="#YML" class="headerlink" title="YML"></a>YML</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9527</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-gateway</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">cloud-gateway-service</span></span><br><span class="line">  <span class="attr">client:</span> <span class="comment">#服务提供者provider注册进eureka服务列表内</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001:7001/eureka</span></span><br></pre></td></tr></table></figure>



<h4 id="业务类-2"><a href="#业务类-2" class="headerlink" title="业务类"></a>业务类</h4><p>网关莫得业务，嘿嘿嘿:laughing:</p>
<h4 id="主启动类-2"><a href="#主启动类-2" class="headerlink" title="主启动类"></a>主启动类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayMain9527</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(GatewayMain9527.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="9527网关如何做路由映射那"><a href="#9527网关如何做路由映射那" class="headerlink" title="9527网关如何做路由映射那??"></a>9527网关如何做路由映射那??</h4><p>8001 的 controller 的两个请求路径/payment/ok和/payment/break</p>
<p>我们目前不想暴露8001端口,希望在8001外面套一层9527</p>
<p>看下面的配置:arrow_double_down:</p>
<h4 id="YML新增网关配置"><a href="#YML新增网关配置" class="headerlink" title="YML新增网关配置"></a>YML新增网关配置</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9527</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">    <span class="comment">#----------从这里开始就是对路由的配置啦</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh</span> <span class="comment">#payment_route    #路由的ID，没有固定规则但要求唯一，建议配合服务名</span></span><br><span class="line">            <span class="attr">uri:</span> <span class="string">http://localhost:8001</span>          <span class="comment">#匹配后提供服务的路由地址</span></span><br><span class="line">            <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/payment/ok</span>         <span class="comment"># 断言，路径相匹配的进行路由</span></span><br><span class="line"></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh2</span> <span class="comment">#payment_route    #路由的ID，没有固定规则但要求唯一，建议配合服务名</span></span><br><span class="line">            <span class="attr">uri:</span> <span class="string">http://localhost:8001</span>          <span class="comment">#匹配后提供服务的路由地址</span></span><br><span class="line">            <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/payment/break/**</span>         <span class="comment"># 断言，路径相匹配的进行路由</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">cloud-gateway-service</span></span><br><span class="line">  <span class="attr">client:</span> <span class="comment">#服务提供者provider注册进eureka服务列表内</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001:7001/eureka</span></span><br></pre></td></tr></table></figure>



<h4 id="测试-9"><a href="#测试-9" class="headerlink" title="测试"></a>测试</h4><h4 id="YML配置说明"><a href="#YML配置说明" class="headerlink" title="YML配置说明"></a>YML配置说明</h4><p>gateway的网关路由配置方式有两种</p>
<ul>
<li><p>第一种是yaml配置</p>
<ul>
<li>  看前面的配置😒</li>
</ul>
</li>
<li><p>第二种是代码中注入Routelocator的Bean</p>
<ul>
<li>```java<br>  // 输入<a target="_blank" rel="noopener" href="http://localhost:9527/guonei%E4%BC%9A%E8%87%AA%E5%8A%A8%E8%BD%AC%E5%8F%91%E5%88%B0http://news.baidu.com/guonei">http://localhost:9527/guonei会自动转发到http://news.baidu.com/guonei</a><br>  @Configuration<br>  public class GateWayConfig<br>  {<pre><code>  @Bean
  public RouteLocator customRouteLocator(RouteLocatorBuilder routeLocatorBuilder)
  &#123;
      RouteLocatorBuilder.Builder routes = routeLocatorBuilder.routes();

      routes.route(&quot;path_route_atguigu&quot;,
              r -&gt; r.path(&quot;/guonei&quot;)
                      .uri(&quot;http://news.baidu.com/guonei&quot;)).build();

      return routes.build();
  &#125;
</code></pre>
  }  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    +   &lt;img src&#x3D;&quot;README.assets&#x2F;2.gif&quot; alt&#x3D;&quot;qwq&quot; style&#x3D;&quot;zoom:200%;&quot; &#x2F;&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 通过微服务名实现动态路由</span><br><span class="line"></span><br><span class="line">&gt;   默认情况下 Gateway会根据注册中心注册的服务列表,  以注册中心上微服务名为路径创建动态路由进行转发,从而实现动态路由的功能</span><br><span class="line"></span><br><span class="line">测试条件：7001和8001、8002</span><br><span class="line"></span><br><span class="line">**yml**</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;yaml</span><br><span class="line">server:</span><br><span class="line">  port: 9527</span><br><span class="line"></span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: cloud-gateway</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      discovery:</span><br><span class="line">        locator:</span><br><span class="line">          enabled: true #开启从注册中心动态创建路由的功能，利用微服务名进行路由</span><br><span class="line">      routes:</span><br><span class="line">      - id: payment_routh #payment_route    #路由的ID，没有固定规则但要求唯一，建议配合服务名</span><br><span class="line">        uri: lb:&#x2F;&#x2F;cloud-payment-service #匹配后提供服务的路由地址</span><br><span class="line">        predicates:</span><br><span class="line">        - Path&#x3D;&#x2F;payment&#x2F;ok         # 断言，路径相匹配的进行路由</span><br><span class="line"></span><br><span class="line">      - id: payment_routh2 #payment_route    #路由的ID，没有固定规则但要求唯一，建议配合服务名</span><br><span class="line">        uri: lb:&#x2F;&#x2F;cloud-payment-service #匹配后提供服务的路由地址</span><br><span class="line">        predicates:</span><br><span class="line">        - Path&#x3D;&#x2F;payment&#x2F;timeout         # 断言，路径相匹配的进行路由</span><br><span class="line"></span><br><span class="line">eureka:</span><br><span class="line">  instance:</span><br><span class="line">    hostname: cloud-gateway-service</span><br><span class="line">  client: #服务提供者provider注册进eureka服务列表内</span><br><span class="line">    service-url:</span><br><span class="line">      register-with-eureka: true</span><br><span class="line">      fetch-registry: true</span><br><span class="line">      defaultZone: http:&#x2F;&#x2F;eureka7001:7001&#x2F;eureka</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<p><strong>测试</strong></p>
<p>网址输入：<a target="_blank" rel="noopener" href="http://localhost:9527/payment/ok">http://localhost:9527/payment/ok</a></p>
<p>看看有没有交替出现8001和8002的端口号</p>
<h2 id="Predicate的使用"><a href="#Predicate的使用" class="headerlink" title="Predicate的使用"></a>Predicate的使用</h2><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/20190422215919986.png" alt="在这里插入图片描述"></p>
<h3 id="AfterRoutePredicateFactory"><a href="#AfterRoutePredicateFactory" class="headerlink" title="AfterRoutePredicateFactory"></a>AfterRoutePredicateFactory</h3><p> 时间类型的Predicate （AfterRoutePredicateFactory BeforeRoutePredicateFactory BetweenRoutePredicateFactory），当只有满足特定时间要求的请求会进入到此predicate中，并交由router处理。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">after_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">http://example.org</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">After=2017-01-20T17:42:47.789-07:00[America/Denver]</span></span><br></pre></td></tr></table></figure>

<p>predicates：</p>
<p><code>- After=2017-01-20T17:42:47.789-07:00[America/Denver]</code> 会被解析成PredicateDefinition对象 <code>（name =After ，args= 2017-01-20T17:42:47.789-07:00[America/Denver]）</code>。predicates的配置，遵循的约定大于配置的思想，这个After就是指定了它的处理类为AfterRoutePredicateFactory，同理，其他类型的predicate也遵循这个规则。</p>
<p>当请求的时间在这个配置的时间之后，请求会被路由到 <a target="_blank" rel="noopener" href="http://example.org/">http://example.org</a></p>
<p> 启动工程，在浏览器上访问 <a target="_blank" rel="noopener" href="http://localhost:8081/%EF%BC%8C%E4%BC%9A%E6%98%BE%E7%A4%BA">http://localhost:8081/，会显示</a> <a target="_blank" rel="noopener" href="http://example.org/">http://example.org</a> 返回的结果，此时gateway路由到了配置的uri。如果我们将配置的时间设置到当前时之后，浏览器会显示404，此时证明没有路由到配置的uri。</p>
<h3 id="CookieRoutePredicateFactory"><a href="#CookieRoutePredicateFactory" class="headerlink" title="CookieRoutePredicateFactory"></a>CookieRoutePredicateFactory</h3><p> cookie类型的<code>CookieRoutePredicateFactory</code>，指定的cookie满足正则匹配，才会进入此router。<br>CookieRoute <code>PredicateFactory</code>需要2个参数，一个是cookie名字，另一个是值也可以是正则表达式。它用于匹配请求中，带有该名称的cookie和cookie匹配正则表达式的请求。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">cookie_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">http://example.org</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Cookie=name,</span> <span class="string">forezp</span></span><br></pre></td></tr></table></figure>

<p>在上面的配置中，请求带有cookie名为name, cookie值为forezp 的请求将都会转发到uri为 <a target="_blank" rel="noopener" href="http://example.org/">http://example.org</a> 的地址上。</p>
<p>使用curl命令进行请求，在请求中带上 cookie，会返回正确的结果，否则，请求报404错误。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl -H <span class="string">&#x27;Cookie:name=forezp&#x27;</span> localhost:8081</span></span><br></pre></td></tr></table></figure>





<h3 id="HeaderRoutePredicateFactory"><a href="#HeaderRoutePredicateFactory" class="headerlink" title="HeaderRoutePredicateFactory"></a>HeaderRoutePredicateFactory</h3><p> <code>HeaderRoutePredicateFactory</code>需要2个参数，一个是header名，另外一个header值，该值可以是一个正则表达式。当此断言匹配了请求的header名和值时，断言通过，进入到router的规则中去。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">header_route</span></span><br><span class="line">         <span class="attr">uri:</span> <span class="string">http://example.org</span></span><br><span class="line">         <span class="attr">predicates:</span></span><br><span class="line">         <span class="bullet">-</span> <span class="string">Header=X-Request-Id,</span> <span class="string">\d+</span></span><br></pre></td></tr></table></figure>


<p> 在上面的配置中，当请求的Header中有X-Request-Id的header名，且header值为数字时，请求会被路由到配置的 uri. 使用curl执行以下命令:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl -H <span class="string">&#x27;X-Request-Id:1&#x27;</span> localhost:8081</span></span><br></pre></td></tr></table></figure>

<p>执行命令后，会正确的返回请求结果。如果在请求中没有带上X-Request-Id的header名，并且值不为数字时，请求就会报404，路由没有被正确转发。</p>
<h3 id="HostRoutePredicateFactory"><a href="#HostRoutePredicateFactory" class="headerlink" title="HostRoutePredicateFactory"></a>HostRoutePredicateFactory</h3><p> <code>HostRoutePredicateFactory</code>需要一个参数即hostname，它可以使用. * 等去匹配host。这个参数会匹配请求头中的host的值，一致，则请求正确转发。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">host_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">http://example.org</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Host=**.somehost.org</span></span><br></pre></td></tr></table></figure>

<p> 在上面的配置中，请求头中含有Host为somehost.org的请求将会被路由转发转发到配置的uri。 启动工程，执行以下的curl命令，请求会返回正确的请求结果：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">curl</span> <span class="string">-H</span> <span class="string">&#x27;Host:www.somehost.org&#x27;</span> <span class="string">localhost:8081</span></span><br></pre></td></tr></table></figure>





<h3 id="MethodRoutePredicateFactory"><a href="#MethodRoutePredicateFactory" class="headerlink" title="MethodRoutePredicateFactory"></a>MethodRoutePredicateFactory</h3><p> <code>MethodRoutePredicateFactory</code> 需要一个参数，即请求的类型。比如GET类型的请求都转发到此路由。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">method_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">http://example.org</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Method=GET</span></span><br></pre></td></tr></table></figure>

<p> 在上面的配置中，所有的GET类型的请求都会路由转发到配置的uri。使用 curl命令模拟 get类型的请求，会得到正确的返回结果。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl localhost:8081</span></span><br></pre></td></tr></table></figure>

<p>使用 curl命令模拟 post请求，则返回404结果。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl -XPOST localhost:8081</span></span><br></pre></td></tr></table></figure>





<h3 id="PathRoutePredicateFactory"><a href="#PathRoutePredicateFactory" class="headerlink" title="PathRoutePredicateFactory"></a>PathRoutePredicateFactory</h3><p> <code>PathRoutePredicateFactory</code> 需要一个参数: 一个spel表达式，应用匹配路径。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">host_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">http://example.org</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/foo/&#123;segment&#125;</span></span><br></pre></td></tr></table></figure>

<p> 在上面的配置中，所有的请求路径满足/foo/{segment}的请求将会匹配并被路由，比如/foo/1 、/foo/bar的请求，将会命中匹配，并成功转发。<br> 使用curl模拟一个请求localhost:8081/foo/dew，执行之后会返回正确的请求结果。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl localhost:8081/foo/dew</span></span><br></pre></td></tr></table></figure>





<h3 id="QueryRoutePredicateFactory"><a href="#QueryRoutePredicateFactory" class="headerlink" title="QueryRoutePredicateFactory"></a>QueryRoutePredicateFactory</h3><p> <code>QueryRoutePredicateFactory</code> 需要2个参数:一个参数名和一个参数值的正则表达式。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">query_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">http://example.org</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Query=foo,</span> <span class="string">ba.</span></span><br></pre></td></tr></table></figure>

<p>在上面的配置文件中，配置了请求中含有参数foo，并且foo的值匹配ba.，则请求命中路由，比如一个请求中含有参数名为foo，值的为bar，能够被正确路由转发。<br> 模拟请求的命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl localhost:8081?foo=bar</span></span><br></pre></td></tr></table></figure>

<p> <code>QueryRoutePredicateFactory</code>也可以只填一个参数，填一个参数时，则只匹配参数名，即请求的参数中含有配置的参数名，则命中路由。<br> 比如以下的配置中，配置了请求参数中含有参数名为foo 的参数将会被请求转发到uri为 <a target="_blank" rel="noopener" href="http://example.org/">http://example.org</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">query_route</span></span><br><span class="line">         <span class="attr">uri:</span> <span class="string">http://example.org</span></span><br><span class="line">         <span class="attr">predicates:</span></span><br><span class="line">         <span class="bullet">-</span> <span class="string">Query=foo</span></span><br></pre></td></tr></table></figure>



<p> 总之每一种predicate都会对当前的客户端请求进行判断，是否满足当前的要求，如果满足则交给当前请求处理。如果有很多个Predicate，并且一个请求满足多个Predicate，则按照配置的顺序第一个生效。具体的可以在官网文档查看：<a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.1.0.RC3/single/spring-cloud-gateway.html#gateway-starter">SpringCloudGateWay官网地址</a></p>
<h2 id="Filter的使用"><a href="#Filter的使用" class="headerlink" title="Filter的使用"></a>Filter的使用</h2><h3 id="是什么-5"><a href="#是什么-5" class="headerlink" title="是什么"></a>是什么</h3><blockquote>
<p>  路由过滤器可用于修改进入的HTTP请求和返回的HTTP响应，路由过滤器只能指定路由进行使用。</p>
<p>  Spring Cloud Gateway 内置了多种路由过滤器，他们都由GatewayFilter的工厂类来产生</p>
</blockquote>
<h3 id="spring-cloud-gateway-的-filter"><a href="#spring-cloud-gateway-的-filter" class="headerlink" title="spring cloud gateway 的 filter"></a>spring cloud gateway 的 filter</h3><p>spring cloud gateway 的 filter都只有两种</p>
<h4 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h4><ul>
<li>  pre</li>
<li>  post</li>
</ul>
<h4 id="种类"><a href="#种类" class="headerlink" title="种类"></a>种类</h4><ul>
<li><p>Gateway Filter</p>
<blockquote>
<h2 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h2><p>  在<a target="_blank" rel="noopener" href="http://cloud.spring.io/spring-cloud-gateway/single/spring-cloud-gateway.html#_gatewayfilter_factories">【spring cloud gateway】</a>的官方文档中，是这样说明GatewayFilterFactory的：</p>
<blockquote>
<p>  <strong>Route filters allow the modification of the incoming HTTP request or outgoing HTTP response in some manner. Route filters are scoped to a particular route. Spring Cloud Gateway includes many built-in GatewayFilter Factories.</strong></p>
</blockquote>
<ul>
<li>  路由过滤器允许以某种方式修改传入的HTTP请求或传出的HTTP响应；</li>
<li>  GatewayFilter不同于GlobalFilter，它只作用于指定的路由；</li>
<li>  spring cloud gateway中内置了大量的网关过滤器工厂；</li>
</ul>
<h2 id="2-分类"><a href="#2-分类" class="headerlink" title="2. 分类"></a>2. 分类</h2><p>  内置的过滤器工厂一共有22个，位于 <code>org.springframework.cloud.gateway.filter.factory</code>及<code>org.springframework.cloud.gateway.filter.factory.rewrite</code>包中</p>
<h3 id="2-1-根据用途划分"><a href="#2-1-根据用途划分" class="headerlink" title="2.1 根据用途划分"></a>2.1 根据用途划分</h3><p>  根据过滤器工厂的用途，可以划分为 <code>Header</code>、<code>Parameter</code>、<code>Path</code>、<code>Body</code>、<code>Status</code>、<code>Session</code>、<code>Redirect</code>、<code>Retry</code>、<code>RateLimiter</code>和<code>Hystrix</code>，具体如下：</p>
<ul>
<li><strong>Header</strong><ul>
<li>  <code>AddRequestHeaderGatewayFilterFactory</code></li>
<li>  <code>RemoveRequestHeaderGatewayFilterFactory</code></li>
<li>  <code>AddResponseHeaderGatewayFilterFactory</code></li>
<li>  <code>RemoveResponseHeaderGatewayFilterFactory</code></li>
<li>  <code>SetRequestHeaderGatewayFilterFactory</code></li>
<li>  <code>SetResponseHeaderGatewayFilterFactory</code></li>
<li>  <code>PreserveHostHeaderGatewayFilterFactory</code></li>
<li>  <code>RequestHeaderToRequestUriGatewayFilterFactory</code></li>
<li>  <code>SecureHeadersGatewayFilterFactory</code></li>
</ul>
</li>
<li><strong>Parameter</strong><ul>
<li>  <code>AddRequestParameterGatewayFilterFactory</code></li>
</ul>
</li>
<li><strong>Path</strong><ul>
<li>  <code>PrefixPathGatewayFilterFactory</code></li>
<li>  <code>RewritePathGatewayFilterFactory</code></li>
<li>  <code>SetPathGatewayFilterFactory</code></li>
<li>  <code>StripPrefixGatewayFilterFactory</code></li>
</ul>
</li>
<li><strong>Body</strong><ul>
<li>  <code>ModifyRequestBodyGatewayFilterFactory</code></li>
<li>  <code>ModifyResponseBodyGatewayFilterFactory</code></li>
</ul>
</li>
<li><strong>Status</strong><ul>
<li>  <code>SetStatusGatewayFilterFactory</code></li>
</ul>
</li>
<li><strong>Session</strong><ul>
<li>  <code>SaveSessionGatewayFilterFactory</code></li>
</ul>
</li>
<li><strong>Redirect</strong><ul>
<li>  <code>RedirectToGatewayFilterFactory</code></li>
</ul>
</li>
<li><strong>Retry</strong><ul>
<li>  <code>RetryGatewayFilterFactory</code></li>
</ul>
</li>
<li><strong>RateLimiter</strong><ul>
<li>  <code>RequestRateLimiterGatewayFilterFactory</code></li>
</ul>
</li>
<li><strong>Hystrix</strong><ul>
<li>  <code>HystrixGatewayFilterFactory</code></li>
</ul>
</li>
</ul>
<h3 id="2-2-根据作用域划分"><a href="#2-2-根据作用域划分" class="headerlink" title="2.2 根据作用域划分"></a>2.2 根据作用域划分</h3><p>  根据过滤器工厂的作用域划分，主要分为两类，一类是作用于 <code>request</code>，另一类是作用于 <code>response</code>，具体如下：</p>
<ul>
<li><strong>Request</strong><ul>
<li>  <code>AddRequestHeaderGatewayFilterFactory</code></li>
<li>  <code>RemoveRequestHeaderGatewayFilterFactory</code></li>
<li>  <code>SetRequestHeaderGatewayFilterFactory</code></li>
<li>  <code>PreserveHostHeaderGatewayFilterFactory</code></li>
<li>  <code>RequestHeaderToRequestUriGatewayFilterFactory</code></li>
<li>  <code>AddRequestParameterGatewayFilterFactory</code></li>
<li>  <code>PrefixPathGatewayFilterFactory</code></li>
<li>  <code>RewritePathGatewayFilterFactory</code></li>
<li>  <code>SetPathGatewayFilterFactory</code></li>
<li>  <code>StripPrefixGatewayFilterFactory</code></li>
<li>  <code>ModifyRequestBodyGatewayFilterFactory</code></li>
<li>  <code>SaveSessionGatewayFilterFactory</code></li>
<li>  <code>RequestRateLimiterGatewayFilterFactory</code></li>
<li>  <code>HystrixGatewayFilterFactory</code></li>
</ul>
</li>
<li><strong>Response</strong><ul>
<li>  <code>AddResponseHeaderGatewayFilterFactory</code></li>
<li>  <code>RemoveResponseHeaderGatewayFilterFactory</code></li>
<li>  <code>SetResponseHeaderGatewayFilterFactory</code></li>
<li>  <code>SecureHeadersGatewayFilterFactory</code></li>
<li>  <code>ModifyResponseBodyGatewayFilterFactory</code></li>
<li>  <code>SetStatusGatewayFilterFactory</code></li>
<li>  <code>RedirectToGatewayFilterFactory</code></li>
<li>  <code>RetryGatewayFilterFactory</code></li>
</ul>
</li>
</ul>
</blockquote>
</li>
<li><p>Global Filter</p>
<p>  在项目中添加filter.MyLogFilter</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyLogFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;************  qwq  *************&quot;</span>);</span><br><span class="line">        String uname = exchange.getRequest().getQueryParams().getFirst(<span class="string">&quot;uname&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(uname == <span class="keyword">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            log.info(<span class="string">&quot;*******用户名为null，非法用户，o(╥﹏╥)o&quot;</span>);</span><br><span class="line">            exchange.getResponse().setStatusCode(HttpStatus.NOT_ACCEPTABLE);</span><br><span class="line">            <span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="九、Spring-Cloud-Config分布式配置中心"><a href="#九、Spring-Cloud-Config分布式配置中心" class="headerlink" title="九、Spring Cloud Config分布式配置中心"></a>九、Spring Cloud Config分布式配置中心</h1><h2 id="star-概述"><a href="#star-概述" class="headerlink" title=":star:概述"></a>:star:概述</h2><h3 id="分布式系统面临的—配置问题"><a href="#分布式系统面临的—配置问题" class="headerlink" title="分布式系统面临的—配置问题"></a>分布式系统面临的—配置问题</h3><blockquote>
<p>  微服务意味着要将单体应用中的业务拆分成一个个子服务,每个服务的粒度相对较小,因此系统中会出现大量的服务。由于每个服务都需要必要的配置信息才能运行,所以一套集中式的、动态的配置管理设施是必不可少的。</p>
<p>  SpringCloud提供了ConfigServer来解决这个问题,我们每一个微服务自己带着一个 application.yyml上百个配置文件的管理….  /(ToT)~~ </p>
</blockquote>
<h3 id="是什么-6"><a href="#是什么-6" class="headerlink" title="是什么"></a>是什么</h3><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200527085525733.png" alt="image-20200527085525733"></p>
<p><strong>是什么</strong></p>
<blockquote>
<p>  SpringCloud Config为微服务架构中的微服务提供<strong>集中化</strong>的外部配置支持，配置服务器为各个不同微服务应用的所有环境提供了一个<strong>中心化的外部配置</strong>。</p>
</blockquote>
<p><strong>怎么玩</strong></p>
<blockquote>
<p>  Spring Cloud Config分为<strong>服务端和客户端两部分</strong></p>
<p>  服务端也称为<strong>分布式配置中心</strong>,它是—个<strong>独立的微服务应用</strong>,用来连接配置服务器并为客户端提供获取配置信息,加密/解密信息等访问接口</p>
<p>  客户端则是通过指定的配置中心来管理应用资源,以及与业务相关的配置内容,并在启动的时候从配置中心获取和加载配置信息，配置服务器默认采用git来存储配置信息,这样就有助于对环境配置进行版本管理,并且可以通过gt客户端工具来方便的管理和访问配置内容</p>
</blockquote>
<h3 id="能干嘛-3"><a href="#能干嘛-3" class="headerlink" title="能干嘛"></a>能干嘛</h3><ul>
<li>  集中管理配置文件</li>
<li>  不同环境不同配置，动态化的配置更新，分环境部署比如dev/test/prod/beta/release</li>
<li>  运行期间动态调整配置，不再需要在每个服务部署的机器上编写配置文件，服务会向配置中心统一拉取配置自己的信息</li>
<li>  当配置发生变动时，服务不需要重启即可感知到配置的变化并应用新的配置</li>
<li>  将配置信息以REST接口的形式暴露</li>
</ul>
<h3 id="官网-1"><a href="#官网-1" class="headerlink" title="官网"></a>官网</h3><p><a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud-config">https://spring.io/projects/spring-cloud-config</a></p>
<h2 id="star-Config服务端配置与测试"><a href="#star-Config服务端配置与测试" class="headerlink" title=":star:Config服务端配置与测试"></a>:star:Config服务端配置与测试</h2><h3 id="创建cloud-config-center3344"><a href="#创建cloud-config-center3344" class="headerlink" title="创建cloud-config-center3344"></a>创建cloud-config-center3344</h3><p>参考其他的项目</p>
<h3 id="pom-5"><a href="#pom-5" class="headerlink" title="pom"></a>pom</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 导入config-server --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="yml-5"><a href="#yml-5" class="headerlink" title="yml"></a>yml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3344</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span>  <span class="string">cloud-config-center</span> <span class="comment">#注册进Eureka服务器的微服务名</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://gitee.com/LLQWQ/cloud-config.git</span> <span class="comment">#GitHub上面的git仓库名字</span></span><br><span class="line">          <span class="comment">####搜索目录</span></span><br><span class="line">          <span class="attr">search-paths:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">cloud-config</span></span><br><span class="line">      <span class="comment">####读取分支</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#服务注册到eureka地址</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka</span></span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong> <code>spring.cloud.config.server.git.uri</code>这个属性可以通过ssh和https的方式连接到git仓库。如果使用ssh连接的方式，在电脑没有保存秘钥的情况下需要自己指定。使用<code>spring.cloud.config.server.git.privateKey</code>来指定秘钥，并且将<code>spring.cloud.config.server.git.ignoreLocalSshSettings</code>设为true</p>
<h3 id="主配置类-1"><a href="#主配置类-1" class="headerlink" title="主配置类"></a>主配置类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableConfigServer</span> <span class="comment">// 加上这个注解开启功能</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigCenterMain3344</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ConfigCenterMain3344.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="测试-10"><a href="#测试-10" class="headerlink" title="测试"></a>测试</h3><p>测试前记得创建一个仓库</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200527101835804.png" alt="image-20200527101835804"></p>
<p>在网页中输入：<a target="_blank" rel="noopener" href="http://localhost:3344/config-test.yml">http://localhost:3344/config-test.yml</a></p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200527102056673.png" alt="image-20200527102056673"></p>
<p><strong>访问规则：</strong></p>
<blockquote>
<p>  {application}：微服务应用的名称<br>  {profile}：环境<br>  {label}：哪个分支</p>
<ul>
<li>/{application}/{profile}[/{label}]<ul>
<li>使用这种方式读取出来的是一个json串<ul>
<li><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200527103503753.png" alt="image-20200527103503753" style="zoom:200%;"></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="http://localhost:3344/config/dev/master">http://localhost:3344/config/dev/master</a></li>
<li><a target="_blank" rel="noopener" href="http://localhost:3344/order/test/qwq">http://localhost:3344/order/test/qwq</a></li>
</ul>
</li>
<li>/{application}-{profile}.yml</li>
<li>/{label}/{application}-{profile}.yml</li>
<li>/{application}-{profile}.properties</li>
<li>/{label}/{application}-{profile}.properties</li>
</ul>
</blockquote>
<h2 id="star-Config客户端配置与测试"><a href="#star-Config客户端配置与测试" class="headerlink" title=":star:Config客户端配置与测试"></a>:star:Config客户端配置与测试</h2><h3 id="新建cloud-config-client3355"><a href="#新建cloud-config-client3355" class="headerlink" title="新建cloud-config-client3355"></a>新建cloud-config-client3355</h3><h3 id="pom-6"><a href="#pom-6" class="headerlink" title="pom"></a>pom</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 添加config-client --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="bootstrap-yml"><a href="#bootstrap-yml" class="headerlink" title="bootstrap.yml"></a>bootstrap.yml</h3><h4 id="是什么-7"><a href="#是什么-7" class="headerlink" title="是什么"></a>是什么</h4><blockquote>
<p>  applicaiton.yml是用户级的资源配置项</p>
<p>  bootstrap.yml是系统级的,优先级更加高</p>
<p>  Spring Cloud会创建一个“Bootstrap Context”，作为Spring应用的Application Context的父上下文。初始化的时候，Bootstrap Context 负责从外部源加载配置属性并解析配置。这两个上下文共享一个从外部获取的’Environment’。</p>
<p>  Bootstrap属性有高优先级,默认情况下,它们不会被本地配置覆盖。 Bootstrap context’和 Application Context有着不同的约定  ,所以新增了一个bootstrap.yml文件,保证 Bootstrap Context’Application  Context’配置的分离。</p>
<p>  要将 Client模块下的 application.yml文件改为 bootstrap.yml这是很关键的,  因为 bootstrap.yml是比 application.yml先加载的。 bootstrap.yml优先级高于 application.yml</p>
</blockquote>
<h4 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3355</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">config-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="comment">#Config客户端配置</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span> <span class="comment">#分支名称</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">config</span> <span class="comment">#配置文件名称</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">dev</span> <span class="comment">#读取后缀名称   上述3个综合：master分支上config-dev.yml的配置文件被读取http://config-3344.com:3344/master/config-dev.yml</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://localhost:3344</span> <span class="comment">#配置中心地址k</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#服务注册到eureka地址</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka</span></span><br></pre></td></tr></table></figure>

<h3 id="Controler"><a href="#Controler" class="headerlink" title="Controler"></a>Controler</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigClientController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;config.info&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String configInfo;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/configInfo&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getConfigInfo</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> configInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="主配置类-2"><a href="#主配置类-2" class="headerlink" title="主配置类"></a>主配置类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigClientMain3355</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ConfigClientMain3355.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试-11"><a href="#测试-11" class="headerlink" title="测试"></a>测试</h3><p>在浏览器输入：<a target="_blank" rel="noopener" href="http://localhost:3355/configInfo">http://localhost:3355/configInfo</a></p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200527110632378.png" alt="image-20200527110632378"></p>
<p>输出了git上面的配置文件的内容</p>
<h2 id="star-Config客户端之动态刷新"><a href="#star-Config客户端之动态刷新" class="headerlink" title=":star:Config客户端之动态刷新"></a>:star:Config客户端之动态刷新</h2><h3 id="修改Controller"><a href="#修改Controller" class="headerlink" title="修改Controller"></a>修改Controller</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="comment">// 添加下面这个注解</span></span><br><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigClientController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;config.info&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String configInfo;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/configInfo&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getConfigInfo</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> configInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="修改yml-4"><a href="#修改yml-4" class="headerlink" title="修改yml"></a>修改yml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 暴露监控端点</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="测试-12"><a href="#测试-12" class="headerlink" title="测试"></a>测试</h3><p>修改git仓库里面的配置内容</p>
<p>网页刷新<a target="_blank" rel="noopener" href="http://localhost:3355/configInfo">http://localhost:3355/configInfo</a></p>
<p>这时候你会发现并没有得到修改后的内容，这是因为需要向3355发送一个post请求来刷新<code>curl -X POST &quot;http://localhost:3355/actuator/refresh&quot;</code></p>
<p>这时候再去刷新网页就会发现已经同步过来了</p>
<p>但是这种方法还不是特别自动，算个半自动，所以接下来加入rabbitmq来实现git提交修改后自动同步配置</p>
<h1 id="十、Spring-Cloud-Bus-消息总线"><a href="#十、Spring-Cloud-Bus-消息总线" class="headerlink" title="十、Spring Cloud Bus 消息总线"></a>十、Spring Cloud Bus 消息总线</h1><h2 id="概述-4"><a href="#概述-4" class="headerlink" title="概述"></a>概述</h2><h3 id="是什么-8"><a href="#是什么-8" class="headerlink" title="是什么"></a>是什么</h3><p>Bus支持两种消息代理: Rabbitmq和 Kafka</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200527123547367.png" alt="image-20200527123547367"></p>
<h3 id="能干嘛-4"><a href="#能干嘛-4" class="headerlink" title="能干嘛"></a>能干嘛</h3><p>Spring Cloud Bus能管理和传播分布式系统间的消息,就像一个分布式执行器,可用于广播状态更改、事件推送等,也可以当作微服务间的通信通道</p>
<img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200527123827334.png" alt="image-20200527123827334" style="zoom:200%;">

<h3 id="为何被称为总线"><a href="#为何被称为总线" class="headerlink" title="为何被称为总线"></a>为何被称为总线</h3><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200527124031110.png" alt="image-20200527124031110"></p>
<h2 id="RabbitMQ环境配置"><a href="#RabbitMQ环境配置" class="headerlink" title="RabbitMQ环境配置"></a>RabbitMQ环境配置</h2><p>参考rabbitmq的笔记</p>
<h2 id="SpringCloud-Bus动态刷新全局广播"><a href="#SpringCloud-Bus动态刷新全局广播" class="headerlink" title="SpringCloud Bus动态刷新全局广播"></a>SpringCloud Bus动态刷新全局广播</h2><p><strong>必须先具备良好的RabbitMQ环境先</strong></p>
<h3 id="设计思想"><a href="#设计思想" class="headerlink" title="设计思想"></a>设计思想</h3><ol>
<li> 利用消息总线<strong>触发一个客户端</strong>/bus/refresh而刷新所有客户端的配置    </li>
<li> 利用消息总线<strong>触发一个服务端</strong> Config Serverl的/bus/refresh端点, 而刷新所有客户端的配置    </li>
</ol>
<p><strong>第二种的架构显然更加适合,第一种不适合的原因如下：</strong></p>
<ul>
<li><p>  打破了微服务的职责单一性,因为微服务本身是业务模块,它本不应该承担配置刷新的职责。</p>
</li>
<li><p>  破坏了微服务各节点的对等性。</p>
</li>
<li><p>有一定的局限性。例如,微服务在迁移时,它的网络地址常常会发生变化,此时如果想要做到自动刷新,那就会增加更多的修改</p>
</li>
</ul>
<h3 id="演示广播效果，增加复杂度，再以3355为模板再制作一个3366"><a href="#演示广播效果，增加复杂度，再以3355为模板再制作一个3366" class="headerlink" title="演示广播效果，增加复杂度，再以3355为模板再制作一个3366"></a>演示广播效果，增加复杂度，再以3355为模板再制作一个3366</h3><p>参考3355</p>
<h3 id="给cloud-config-center-3344配置中心服务端添加消息总线支持"><a href="#给cloud-config-center-3344配置中心服务端添加消息总线支持" class="headerlink" title="给cloud-config-center-3344配置中心服务端添加消息总线支持"></a>给cloud-config-center-3344配置中心服务端添加消息总线支持</h3><p><strong>pom</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--添加消息总线RabbitMQ支持--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>yml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3344</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span>  <span class="string">cloud-config-center</span> <span class="comment">#注册进Eureka服务器的微服务名</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://gitee.com/LLQWQ/cloud-config.git</span> <span class="comment">#GitHub上面的git仓库名字</span></span><br><span class="line">          <span class="comment">####搜索目录</span></span><br><span class="line">          <span class="attr">search-paths:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">cloud-config</span></span><br><span class="line">      <span class="comment">####读取分支</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#rabbitmq相关配置 -------------</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.107</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#服务注册到eureka地址</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##rabbitmq相关配置,暴露bus刷新配置的端点 -------------</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span> <span class="comment">#暴露bus刷新配置的端点</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;bus-refresh&#x27;</span></span><br></pre></td></tr></table></figure>



<h3 id="给cloud-config-client-3355客户端添加消息总线支持"><a href="#给cloud-config-client-3355客户端添加消息总线支持" class="headerlink" title="给cloud-config-client-3355客户端添加消息总线支持"></a>给cloud-config-client-3355客户端添加消息总线支持</h3><p>==3366也是一样的==</p>
<p><strong>pom</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--添加消息总线RabbitMQ支持--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p><strong>yml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.107</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br></pre></td></tr></table></figure>



<h3 id="测试-13"><a href="#测试-13" class="headerlink" title="测试"></a>测试</h3><ol>
<li> 将7001、3344、3355、3366依次运行起来，3344先自测一下康康能不能获取到配置信息</li>
<li> 修改git仓库中的配置信息</li>
<li> 看看3344有没有更新，然后再查看3355和3366，这个时候3355和3366应该是没有更新的</li>
<li> 向3344发送一个post请求<code>curl -X POST &quot;http://localhost:3344/actuator/bus-refresh&quot;</code></li>
<li> 再次查看3355和3366，现在应该是更新了</li>
</ol>
<p><strong>这样就做到了，一次修改，广播通知，处处生效</strong></p>
<h2 id="SpringCloud-Bus动态刷新定点通知"><a href="#SpringCloud-Bus动态刷新定点通知" class="headerlink" title="SpringCloud Bus动态刷新定点通知"></a>SpringCloud Bus动态刷新定点通知</h2><p><strong>测试场景：</strong> 修改git仓库中的配置，只刷新3355不刷新3366</p>
<p>完成以上场景，并不需要修改配置，只需要将刷新的post修改一下即可</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="code">`http://localhost:配置中心的端口号/actuator/bus-refresh/&#123;destination&#125;`</span></span><br><span class="line"></span><br><span class="line">&#123;destination&#125;：需要通知更新的服务</span><br></pre></td></tr></table></figure>

<p>按照上面的格式，只需要在修改完git仓库的配置之后使用<code>curl -X POST &quot;http://localhost:3344/actuator/bus-refresh/config-client:3355&quot;</code>来通知3344即可做到只通知3355而不通知3366的功能</p>
<p>ps：如果不写端口号则表示通知在eureka上注册的所有服务名叫config-client的服务</p>
<h1 id="十一、Spring-Cloud-Stream-消息驱动"><a href="#十一、Spring-Cloud-Stream-消息驱动" class="headerlink" title="十一、Spring Cloud Stream 消息驱动"></a>十一、Spring Cloud Stream 消息驱动</h1><h2 id="中文指导手册"><a href="#中文指导手册" class="headerlink" title="中文指导手册"></a>中文指导手册</h2><p><a target="_blank" rel="noopener" href="https://m.wang1314.com/doc/webapp/topic/20971999.html">https://m.wang1314.com/doc/webapp/topic/20971999.html</a></p>
<h2 id="概述-5"><a href="#概述-5" class="headerlink" title="概述"></a>概述</h2><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200527141810648.png" alt="image-20200527141810648"></p>
<p>一句话：屏蔽底层消息中间件的差异降低切换成本,统一消息的编程模型</p>
<h3 id="编码api的常用注解"><a href="#编码api的常用注解" class="headerlink" title="编码api的常用注解"></a>编码api的常用注解</h3><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200527143009336.png" alt="image-20200527143009336"></p>
<h2 id="案例说明"><a href="#案例说明" class="headerlink" title="案例说明"></a>案例说明</h2><p>rabbitmq环境已经搭建好了</p>
<p>工程中新建三个子模块</p>
<ul>
<li>  cloud-stream-rabbitmq-provider8801 消息发送模块</li>
<li>  cloud-stream-rabbitmq-consumer8802 消息接收模块</li>
<li>  cloud-stream-rabbitmq-consumer8803 消息接收模块</li>
</ul>
<h2 id="生产者"><a href="#生产者" class="headerlink" title="生产者"></a>生产者</h2><h3 id="创建cloud-stream-rabbitmq-provider8801"><a href="#创建cloud-stream-rabbitmq-provider8801" class="headerlink" title="创建cloud-stream-rabbitmq-provider8801"></a>创建cloud-stream-rabbitmq-provider8801</h3><h3 id="pom-7"><a href="#pom-7" class="headerlink" title="pom"></a>pom</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 导入stream-rabbit --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-stream-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--基础配置--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="yml-6"><a href="#yml-6" class="headerlink" title="yml"></a>yml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8801</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-stream-provider</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">stream:</span></span><br><span class="line">      <span class="attr">binders:</span> <span class="comment"># 在此处配置要绑定的rabbitmq的服务信息；</span></span><br><span class="line">        <span class="attr">defaultRabbit:</span> <span class="comment"># 表示定义的名称，用于于binding整合</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">rabbit</span> <span class="comment"># 消息组件类型</span></span><br><span class="line">          <span class="attr">environment:</span> <span class="comment"># 设置rabbitmq的相关的环境配置</span></span><br><span class="line">            <span class="attr">spring:</span></span><br><span class="line">              <span class="attr">rabbitmq:</span></span><br><span class="line">                <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.107</span></span><br><span class="line">                <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">                <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">                <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">      <span class="attr">bindings:</span> <span class="comment"># 服务的整合处理</span></span><br><span class="line">        <span class="attr">output:</span> <span class="comment"># 这个名字是一个通道的名称</span></span><br><span class="line">          <span class="attr">destination:</span> <span class="string">studyExchange</span> <span class="comment"># 表示要使用的Exchange名称</span></span><br><span class="line">          <span class="attr">content-type:</span> <span class="string">application/json</span> <span class="comment"># 设置消息类型，本次为json，文本则设置“text/plain”</span></span><br><span class="line">          <span class="attr">binder:</span> <span class="string">defaultRabbit</span> <span class="comment"># 设置要绑定的消息服务的具体设置</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span> <span class="comment"># 客户端进行Eureka注册的配置</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">lease-renewal-interval-in-seconds:</span> <span class="number">2</span> <span class="comment"># 设置心跳的时间间隔（默认是30秒）</span></span><br><span class="line">    <span class="attr">lease-expiration-duration-in-seconds:</span> <span class="number">5</span> <span class="comment"># 如果现在超过了5秒的间隔（默认是90秒）</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">send-8801.com</span>  <span class="comment"># 在信息列表时显示主机名称</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span>     <span class="comment"># 访问的路径变为IP地址</span></span><br></pre></td></tr></table></figure>

<h3 id="主配置类-3"><a href="#主配置类-3" class="headerlink" title="主配置类"></a>主配置类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="comment">// @EnableEurekaClient 不使用这个注解也可以注册到eureka中</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitMQProviderMain8801</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(RabbitMQProviderMain8801.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="业务层"><a href="#业务层" class="headerlink" title="业务层"></a>业务层</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IMessageProvider</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">send</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.springframework.cloud.stream.messaging.Source; 注意source不要导错包了</span></span><br><span class="line"><span class="meta">@EnableBinding(Source.class)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageProviderImpl</span> <span class="keyword">implements</span> <span class="title">IMessageProvider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> MessageChannel output;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">send</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String uuid = UUID.randomUUID().toString();</span><br><span class="line">        output.send(MessageBuilder.withPayload(uuid).build());</span><br><span class="line">        log.info(<span class="string">&quot;==============uuid: &quot;</span>+uuid);</span><br><span class="line">        <span class="keyword">return</span> uuid;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageProviderController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IMessageProvider messageProvider;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/message/send&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">send</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> messageProvider.send();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试-14"><a href="#测试-14" class="headerlink" title="测试"></a>测试</h3><ol>
<li><p> 打开rabbitmq的web控制界面</p>
</li>
<li><p> 查看是否存在名称为studyExchange的交换机，这个名称是之前在配置文件中指定的交换机名称</p>
</li>
<li><p> 浏览器输入网址：<a target="_blank" rel="noopener" href="http://localhost:8801/message/send">http://localhost:8801/message/send</a>  (多点几次)</p>
</li>
<li><p>查看交换机的图形界面有没有什么变化，就是下面这个界面，看那个视图有没有变动</p>
<p> <img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200527155914627.png" alt="image-20200527155914627"></p>
</li>
</ol>
<h2 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h2><h3 id="创建cloud-stream-rabbitmq-consumer8802"><a href="#创建cloud-stream-rabbitmq-consumer8802" class="headerlink" title="创建cloud-stream-rabbitmq-consumer8802"></a>创建cloud-stream-rabbitmq-consumer8802</h3><p>参考8801</p>
<h3 id="pom-8"><a href="#pom-8" class="headerlink" title="pom"></a>pom</h3><p>和8001一样</p>
<h3 id="yml-7"><a href="#yml-7" class="headerlink" title="yml"></a>yml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8802</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-stream-consumer</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">stream:</span></span><br><span class="line">      <span class="attr">binders:</span> <span class="comment"># 在此处配置要绑定的rabbitmq的服务信息；</span></span><br><span class="line">        <span class="attr">defaultRabbit:</span> <span class="comment"># 表示定义的名称，用于于binding整合</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">rabbit</span> <span class="comment"># 消息组件类型</span></span><br><span class="line">          <span class="attr">environment:</span> <span class="comment"># 设置rabbitmq的相关的环境配置</span></span><br><span class="line">            <span class="attr">spring:</span></span><br><span class="line">              <span class="attr">rabbitmq:</span></span><br><span class="line">                <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.107</span></span><br><span class="line">                <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">                <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">                <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">      <span class="attr">bindings:</span> <span class="comment"># 服务的整合处理</span></span><br><span class="line">        <span class="attr">input:</span> <span class="comment"># &lt;---------------这里改成input------------------- </span></span><br><span class="line">          <span class="attr">destination:</span> <span class="string">studyExchange</span> <span class="comment"># 表示要使用的Exchange名称定义</span></span><br><span class="line">          <span class="attr">content-type:</span> <span class="string">application/json</span> <span class="comment"># 设置消息类型，本次为json，文本则设置“text/plain”</span></span><br><span class="line">          <span class="attr">binder:</span> <span class="string">defaultRabbit</span> <span class="comment"># 设置要绑定的消息服务的具体设置</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span> <span class="comment"># 客户端进行Eureka注册的配置</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">lease-renewal-interval-in-seconds:</span> <span class="number">2</span> <span class="comment"># 设置心跳的时间间隔（默认是30秒）</span></span><br><span class="line">    <span class="attr">lease-expiration-duration-in-seconds:</span> <span class="number">5</span> <span class="comment"># 如果现在超过了5秒的间隔（默认是90秒）</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">receive-8802.com</span>  <span class="comment"># 在信息列表时显示主机名称</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span>     <span class="comment"># 访问的路径变为IP地址</span></span><br></pre></td></tr></table></figure>

<h3 id="controller-1"><a href="#controller-1" class="headerlink" title="controller"></a>controller</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="comment">// import org.springframework.cloud.stream.messaging.Sink;</span></span><br><span class="line"><span class="meta">@EnableBinding(Sink.class)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReceiveController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@StreamListener(Sink.INPUT)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive</span><span class="params">(Message&lt;String&gt; message)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;消费者qwq(&quot;</span>+port+<span class="string">&quot;)接收到消息： &quot;</span> + message.getPayload());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="主启动类-3"><a href="#主启动类-3" class="headerlink" title="主启动类"></a>主启动类</h3><p>和8001一样</p>
<h3 id="测试-15"><a href="#测试-15" class="headerlink" title="测试"></a>测试</h3><ol>
<li><p> 启动rabbitmq的web控制界面</p>
</li>
<li><p> 启动7001,8001,8002（如果没用到eureka的话7001都可以不用启动）</p>
</li>
<li><p> 浏览器访问：<a target="_blank" rel="noopener" href="http://localhost:8801/message/send">http://localhost:8801/message/send</a></p>
</li>
<li><p> 查看8002的控制台有没有打印出对应的消息</p>
</li>
<li><p>查看名称为studyExchange的交换机有没有订阅者和流量的变化</p>
<p> <img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200527162558243.png" alt="image-20200527162558243"></p>
</li>
</ol>
<h2 id="分组消费与持久化"><a href="#分组消费与持久化" class="headerlink" title="分组消费与持久化"></a>分组消费与持久化</h2><h3 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h3><blockquote>
<p>  stream的消费者在没指定分组时会默认分配在一个唯一的组中，并且stream的每个组都能消费到生产者发送过来的消息。这种情况就是订阅发布模式，但是如果一个组中有多个消费者，此时这多个消费者就是竞争关系，也就是一人消费一条。（说竞争关系可能不太对，应该是轮询的负载均衡模式）</p>
<p>  一句话：不同组重复消费，同一组轮询</p>
</blockquote>
<p>为了测试效果先创建一个8003</p>
<h4 id="创建cloud-stream-rabbitmq-consumer8803"><a href="#创建cloud-stream-rabbitmq-consumer8803" class="headerlink" title="创建cloud-stream-rabbitmq-consumer8803"></a>创建cloud-stream-rabbitmq-consumer8803</h4><p>参考8002（就是直接clone 8002 改一下配置）</p>
<h4 id="修改yml-5"><a href="#修改yml-5" class="headerlink" title="修改yml"></a>修改yml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">stream:</span></span><br><span class="line">      <span class="attr">bindings:</span> </span><br><span class="line">        <span class="attr">input:</span> </span><br><span class="line">          <span class="attr">group:</span> <span class="string">qwq</span> <span class="comment"># 添加这个就好了，8002和8003写一样的组名就好啦</span></span><br></pre></td></tr></table></figure>

<h4 id="测试-16"><a href="#测试-16" class="headerlink" title="测试"></a>测试</h4><ol>
<li> 浏览器访问：<a target="_blank" rel="noopener" href="http://localhost:8801/message/send">http://localhost:8801/message/send</a></li>
<li> 查看8002和8003的控制台，如果没有出现重复的消息就对啦:laughing:</li>
</ol>
<h3 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h3><p><strong>问题：</strong>当8002和8003宕机了，但是8001在它们宕机之后发送了五条消息，当8002和8003再次上线还会不会收到8001在当前后发送的5条消息？</p>
<p>答案是收得到，但是有几个前提：</p>
<ul>
<li>  8002和8003指定了分组的属性</li>
<li>  8002和8003的宕机前的分组属性和重新上线后的分组属性的值必须是一样的</li>
</ul>
<p>拿8002举例，假设它宕机前的分组属性的值是qwq，宕机后也必须是以qwq的分组登录的才能收到补发的消息。</p>
<p>因为stream在8002第一次登录时会记录分组，当他下线了，在它下线的这段时间所发送的消息会在它再次以qwq上线的时候补发给它，也就相当于qwq被注册到了stream里面。</p>
<h1 id="十二、Spring-Cloud-Sleuth-分布式请求链路跟踪"><a href="#十二、Spring-Cloud-Sleuth-分布式请求链路跟踪" class="headerlink" title="十二、Spring Cloud Sleuth 分布式请求链路跟踪"></a>十二、Spring Cloud Sleuth 分布式请求链路跟踪</h1><h2 id="概述-6"><a href="#概述-6" class="headerlink" title="概述"></a>概述</h2><h3 id="为什么会出现这样的技术？需要解决那些问题？"><a href="#为什么会出现这样的技术？需要解决那些问题？" class="headerlink" title="为什么会出现这样的技术？需要解决那些问题？"></a>为什么会出现这样的技术？需要解决那些问题？</h3><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200527172421771.png"></p>
<p>在调用链路少的情况可以不用引用，但是当链路很长的时候就很有必要对其进行监控了，比如下图这种情况</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200527172550577.png" alt="image-20200527172550577"></p>
<h3 id="是什么-9"><a href="#是什么-9" class="headerlink" title="是什么"></a>是什么</h3><p><a target="_blank" rel="noopener" href="https://github.com/spring-cloud/spring-cloud-sleuth">https://github.com/spring-cloud/spring-cloud-sleuth</a></p>
<blockquote>
<p>  Spring Cloud Sleuth提供了一套完整的服务跟踪的解决方案</p>
<p>  在分布式系统中提供追踪解决方案并且兼容支持了 zipkin</p>
</blockquote>
<h3 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h3><p>它会将调用链路记录下来，可以以web的界面展现出来</p>
<h2 id="搭建链路监控步骤"><a href="#搭建链路监控步骤" class="headerlink" title="搭建链路监控步骤"></a>搭建链路监控步骤</h2><h3 id="zipkin"><a href="#zipkin" class="headerlink" title="zipkin"></a>zipkin</h3><h4 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h4><p><a target="_blank" rel="noopener" href="https://dl.bintray.com/openzipkin/maven/io/zipkin/java/zipkin-server/">https://dl.bintray.com/openzipkin/maven/io/zipkin/java/zipkin-server/</a></p>
<p>zipkin-server-2.12.9-exec.jar</p>
<p>下载以exec结尾的jar包</p>
<h4 id="运行jar"><a href="#运行jar" class="headerlink" title="运行jar"></a>运行jar</h4><p>使用<code>java -jar zipkin-server-2.12.9-exec.jar</code>来运行，出现这个标志说明成功啦</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200527175700308.png" alt="image-20200527175700308"></p>
<h4 id="运行控制台"><a href="#运行控制台" class="headerlink" title="运行控制台"></a>运行控制台</h4><p><a target="_blank" rel="noopener" href="http://localhost:9411/zipkin/">http://localhost:9411/zipkin/</a></p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200527175752803.png" alt="image-20200527175752803"></p>
<h4 id="完整的调用链路"><a href="#完整的调用链路" class="headerlink" title="完整的调用链路"></a>完整的调用链路</h4><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200527174038626.png" alt="image-20200527174038626"></p>
<p>精简版：</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200527174102677.png" alt="image-20200527174102677"></p>
<h4 id="名称解释"><a href="#名称解释" class="headerlink" title="名称解释"></a>名称解释</h4><ul>
<li>  <strong>Trace:</strong>  类似于树结构的Span集合，表示一条调用链路，存在唯一标识</li>
<li>  <strong>span:</strong>  表示调用链路来源，通俗的理解span就是一次请求信息</li>
</ul>
<h3 id="服务提供者和调用者"><a href="#服务提供者和调用者" class="headerlink" title="服务提供者和调用者"></a>服务提供者和调用者</h3><p>修改cloud-provider-payment8001和cloud-customer-openfeign-order80</p>
<h4 id="pom-9"><a href="#pom-9" class="headerlink" title="pom"></a>pom</h4><p>添加这个依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--包含了sleuth+zipkin--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zipkin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="yml-8"><a href="#yml-8" class="headerlink" title="yml"></a>yml</h4><p>添加以下配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">	<span class="attr">zipkin:</span></span><br><span class="line">    	<span class="attr">base-url:</span> <span class="string">http://localhost:9411</span></span><br><span class="line">  	<span class="attr">sleuth:</span></span><br><span class="line">    	<span class="attr">sampler:</span></span><br><span class="line">        	<span class="comment">#采样率值介于 0 到 1 之间，1 则表示全部采集 </span></span><br><span class="line">        	<span class="comment"># 项目中一般写0.5</span></span><br><span class="line">      		<span class="attr">probability:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h4 id="测试-17"><a href="#测试-17" class="headerlink" title="测试"></a>测试</h4><ol>
<li><p> 启动zipkin-server</p>
</li>
<li><p> 浏览器访问：<a target="_blank" rel="noopener" href="http://localhost/order/payment/ok">http://localhost/order/payment/ok</a></p>
</li>
<li><p>查看zipkin-server的控制界面</p>
<p> <img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200527190516542.png" alt="image-20200527190516542"></p>
</li>
</ol>
<h1 id="十三、Spring-Cloud-Alibaba-入门简介"><a href="#十三、Spring-Cloud-Alibaba-入门简介" class="headerlink" title="十三、Spring Cloud Alibaba 入门简介"></a>十三、Spring Cloud Alibaba 入门简介</h1><p>见脑图</p>
<h1 id="star2-十四、SpringCloud-Alibaba-Nacos服务注册和配置中心"><a href="#star2-十四、SpringCloud-Alibaba-Nacos服务注册和配置中心" class="headerlink" title=":star2:十四、SpringCloud Alibaba Nacos服务注册和配置中心"></a>:star2:十四、SpringCloud Alibaba Nacos服务注册和配置中心</h1><h2 id="Nacos简介"><a href="#Nacos简介" class="headerlink" title="Nacos简介"></a>Nacos简介</h2><h3 id="为什么叫Nacos"><a href="#为什么叫Nacos" class="headerlink" title="为什么叫Nacos"></a>为什么叫Nacos</h3><blockquote>
<p>  前四个字母分别为Naming和Configuration的前两个字母，最后的s为Service</p>
</blockquote>
<h3 id="是什么-10"><a href="#是什么-10" class="headerlink" title="是什么"></a>是什么</h3><blockquote>
<p>一个更易于构建云原生应用的动态服务发现，配置管理和服务管理中心<br>Nacos：Dynamic Naming and Configuration Service<br>Nacos就是注册中心+配置中心的组合 等价于 <code>Nacos = Eureka+Config+Bus</code></p>
</blockquote>
<h3 id="能干嘛-5"><a href="#能干嘛-5" class="headerlink" title="能干嘛"></a>能干嘛</h3><blockquote>
<p>  替代Eureka做服务注册中心</p>
<p>  替代Config做服务配置中心</p>
</blockquote>
<h3 id="去哪下-1"><a href="#去哪下-1" class="headerlink" title="去哪下"></a>去哪下</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">git仓库</span>](<span class="link">https://github.com/alibaba/Nacos</span>)</span><br><span class="line"><span class="section"># 官网文档</span></span><br><span class="line"><span class="bullet">+</span> https://nacos.io/zh-cn/index.html</span><br><span class="line"></span><br><span class="line"><span class="bullet">+</span> https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html#<span class="emphasis">_spring_</span>cloud<span class="emphasis">_alibaba_</span>nacos<span class="emphasis">_discovery</span></span><br></pre></td></tr></table></figure>
<h3 id="各种注册中心比较"><a href="#各种注册中心比较" class="headerlink" title="各种注册中心比较"></a>各种注册中心比较</h3><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200528084720925.png" alt="image-20200528084720925"></p>
<p><strong>据说Nacos在阿里巴巴内部有超过10万的实例运行,已经过了类似双十一等各种大型流量的考验</strong></p>
<h2 id="安装并运行Nacos"><a href="#安装并运行Nacos" class="headerlink" title="安装并运行Nacos"></a>安装并运行Nacos</h2><ol>
<li><p> 本地Java8+Maven环境已经OK</p>
</li>
<li><p>先从官网下载Nacos</p>
<p> <a target="_blank" rel="noopener" href="https://github.com/alibaba/nacos/releases/tag/1.1.4">https://github.com/alibaba/nacos/releases/tag/1.1.4</a></p>
</li>
<li><p> 解压安装包，直接运行bin目录下的startup.cmd</p>
</li>
<li><p>命令运行成功后直接访问<a target="_blank" rel="noopener" href="http://localhost:8848/nacos">http://localhost:8848/nacos</a></p>
<p> 默认账号密码都是nacos</p>
</li>
<li><p>结果页面</p>
<p> <img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200528085646074.png" alt="image-20200528085646074"></p>
<p> <img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200528085801217.png" alt="image-20200528085801217"></p>
</li>
</ol>
<h2 id="Nacos作为服务注册中心演示"><a href="#Nacos作为服务注册中心演示" class="headerlink" title="Nacos作为服务注册中心演示"></a>Nacos作为服务注册中心演示</h2><h3 id="官网文档"><a href="#官网文档" class="headerlink" title="官网文档"></a><a target="_blank" rel="noopener" href="https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html">官网文档</a></h3><p><a target="_blank" rel="noopener" href="https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html">https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html</a></p>
<p><a target="_blank" rel="noopener" href="https://nacos.io/zh-cn/docs/what-is-nacos.html">中文官网</a></p>
<h3 id="基于Nacos的服务提供者"><a href="#基于Nacos的服务提供者" class="headerlink" title="基于Nacos的服务提供者"></a>基于Nacos的服务提供者</h3><h4 id="新建Module"><a href="#新建Module" class="headerlink" title="新建Module"></a>新建Module</h4><p>​            cloudalibaba-provider-payment9001</p>
<h4 id="POM-1"><a href="#POM-1" class="headerlink" title="POM"></a>POM</h4><p><strong>父POM</strong></p>
<p>添加如下依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--spring cloud 阿里巴巴--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p><strong>本模块POM</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--SpringCloud ailibaba nacos --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- SpringBoot整合Web组件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--日常通用jar包配置--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="YML-1"><a href="#YML-1" class="headerlink" title="YML"></a>YML</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-payment-provider</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#配置Nacos地址</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span></span><br></pre></td></tr></table></figure>



<h4 id="主启动"><a href="#主启动" class="headerlink" title="主启动"></a>主启动</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentMain9001</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(PaymentMain9001.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="业务类-3"><a href="#业务类-3" class="headerlink" title="业务类"></a>业务类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/port&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPort</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;port: &quot;</span> + port + <span class="string">&quot;, uuid: &quot;</span> + UUID.randomUUID().toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="测试-18"><a href="#测试-18" class="headerlink" title="测试"></a>测试</h4><ol>
<li> 访问nacos控制台，看服务列表里面有没有刚刚注册的服务</li>
</ol>
<p>​            <a target="_blank" rel="noopener" href="http://localhost:8848/nacos/index.html#/serviceManagement">http://localhost:8848/nacos/index.html#/serviceManagement</a></p>
<p>​            <img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200528113404419.png" alt="image-20200528113404419"></p>
<blockquote>
<p>  为了下一章节演示nacos的负载均衡，参照9001新建9002</p>
</blockquote>
<p>如果想偷懒的话就。。。看下图（这种方式可以复制一个服务）</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200528111505861.png" alt="image-20200528111505861"></p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200528111829900.png" alt="image-20200528111829900"></p>
<h3 id="基于Nacos的服务消费者"><a href="#基于Nacos的服务消费者" class="headerlink" title="基于Nacos的服务消费者"></a>基于Nacos的服务消费者</h3><h4 id="新建Module-1"><a href="#新建Module-1" class="headerlink" title="新建Module"></a>新建Module</h4><p>​            cloudalibaba-consumer-nacos-order83</p>
<h4 id="POM-2"><a href="#POM-2" class="headerlink" title="POM"></a>POM</h4><p>和9001一样</p>
<h4 id="yml-9"><a href="#yml-9" class="headerlink" title="yml"></a>yml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">83</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-consumer-provider</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#配置Nacos地址</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">myConfig:</span> <span class="comment"># 这里是自己写的配置</span></span><br><span class="line">  <span class="attr">serverUrl:</span> <span class="string">http://nacos-payment-provider</span></span><br></pre></td></tr></table></figure>

<h4 id="主启动-1"><a href="#主启动-1" class="headerlink" title="主启动"></a>主启动</h4><p>和9001一样</p>
<h4 id="业务类-4"><a href="#业务类-4" class="headerlink" title="业务类"></a>业务类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;myConfig.serverUrl&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverUrl;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/payment/port&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getProviderPort</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(serverUrl+<span class="string">&quot;/payment/port&quot;</span>, String.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="配置类"><a href="#配置类" class="headerlink" title="配置类"></a>配置类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationContextConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="测试-19"><a href="#测试-19" class="headerlink" title="测试"></a>测试</h4><ol>
<li><p>访问nacos控制台</p>
<p> <a target="_blank" rel="noopener" href="http://localhost:8848/nacos/index.html#/serviceManagement">http://localhost:8848/nacos/index.html#/serviceManagement</a></p>
</li>
<li><p>83访问9001/9002，轮询负载OK</p>
<p> 就是看到9001和9002的端口交替出现</p>
</li>
</ol>
<h4 id="为什么nacos支持负载均衡"><a href="#为什么nacos支持负载均衡" class="headerlink" title="为什么nacos支持负载均衡"></a>为什么nacos支持负载均衡</h4><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200528131821302.png" alt="image-20200528131821302"></p>
<p>因为nacos整合了ribbon</p>
<h3 id="服务注册中心对比"><a href="#服务注册中心对比" class="headerlink" title="服务注册中心对比"></a>服务注册中心对比</h3><h4 id="Nacos和CAP"><a href="#Nacos和CAP" class="headerlink" title="Nacos和CAP"></a>Nacos和CAP</h4><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200528132152933.png" alt="image-20200528132152933"></p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200528132134012.png" alt="image-20200528132134012"></p>
<h4 id="Nacos支持AP和CP模式的切换"><a href="#Nacos支持AP和CP模式的切换" class="headerlink" title="Nacos支持AP和CP模式的切换"></a>Nacos支持AP和CP模式的切换</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="quote">&gt; C是所有节点在同一时间看到的数据是一致的;而A的定义是所有的请求都会收到响应。</span></span><br><span class="line"></span><br><span class="line"><span class="quote">&gt; 何时选择使用何种模式?</span></span><br><span class="line">一般来说,如果不需要存储服务级别的信息且服务实例是通过nacos-client注册,并能够倮持心跳上报,那么就可以选挥AP模式.当前主流的服务如 Spring cloud 和Dubbo 服务,都适用于AP模式,AP模式为了服务的可用性而减弱了一致性,因此AP模式下只支持注册临时实例.</span><br><span class="line"></span><br><span class="line"><span class="quote">&gt; 如果需要在服务级别编辑或者存储配置信息,那么CP 是必须,K8S服务和DNS服务则适用于CP模式。</span></span><br><span class="line">CP模式下则支持注册持久化实例,此时则是以 Raft 协议为集群运行模式,该模式下注册实例之前必须先注册服务,如果服务不存在,则会返回错误.</span><br><span class="line"></span><br><span class="line">可以用以下命令启动并告知nacos的模式</span><br><span class="line"><span class="code">`curl-X PUT&#x27;SNACOS_SERVER:8848/nacos/v1/ns/operator/switches?entry=serverMode&amp;value=CP&#x27;`</span></span><br></pre></td></tr></table></figure>



<h2 id="Nacos作为服务配置中心演示"><a href="#Nacos作为服务配置中心演示" class="headerlink" title="Nacos作为服务配置中心演示"></a>Nacos作为服务配置中心演示</h2><h3 id="Nacos作为配置中心-基础配置"><a href="#Nacos作为配置中心-基础配置" class="headerlink" title="Nacos作为配置中心-基础配置"></a>Nacos作为配置中心-基础配置</h3><h4 id="建model"><a href="#建model" class="headerlink" title="建model"></a>建model</h4><p>cloudalibaba-config-nacos-client3377</p>
<h4 id="POM-3"><a href="#POM-3" class="headerlink" title="POM"></a>POM</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--SpringCloud ailibaba config --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--SpringCloud ailibaba nacos --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- SpringBoot整合Web组件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--日常通用jar包配置--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="YML-2"><a href="#YML-2" class="headerlink" title="YML"></a>YML</h4><h5 id="bootstrap-yml-1"><a href="#bootstrap-yml-1" class="headerlink" title="bootstrap.yml"></a>bootstrap.yml</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nacos配置</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3377</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-config-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#Nacos服务注册中心地址</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#Nacos作为配置中心地址</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span> <span class="comment">#指定yaml格式的配置</span></span><br></pre></td></tr></table></figure>

<h5 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a>application.yml</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure>

<h5 id="why配置两个"><a href="#why配置两个" class="headerlink" title="why配置两个"></a>why配置两个</h5><blockquote>
<p>  Nacos同springcloud-config一样,在项目初始化时,要保证先从配置中心进行配置拉取,拉取配置之后,才能保证项目的正常启动。<br>  springboot中配置文件的加载是存在优先级顺序的,bootstrap优先级高于application</p>
</blockquote>
<h4 id="主启动-2"><a href="#主启动-2" class="headerlink" title="主启动"></a>主启动</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NacosConfigClientMain3377</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(NacosConfigClientMain3377.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="业务类-5"><a href="#业务类-5" class="headerlink" title="业务类"></a>业务类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigClientController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;config.info&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String configInfo;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/configInfo&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getConfigInfo</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> configInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">			</span><br></pre></td></tr></table></figure>

<h4 id="在Nacos中添加配置信息"><a href="#在Nacos中添加配置信息" class="headerlink" title="在Nacos中添加配置信息"></a>在Nacos中添加配置信息</h4><p>公式：${spring.application.name}-${spring.profile.active}.${spring.cloud.nacos.config.file-extension}</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200528141639257.png" alt="image-20200528141639257"></p>
<h4 id="测试-20"><a href="#测试-20" class="headerlink" title="测试"></a>测试</h4><ol>
<li><p>在nacos的管理界面添加配置</p>
 <img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200528141830231.png" alt="image-20200528141830231" style="zoom:200%;"></li>
<li><p> 启动3377，并访问<a target="_blank" rel="noopener" href="http://localhost:3377/configInfo%E6%9F%A5%E7%9C%8B%E6%98%AF%E5%90%A6%E6%89%93%E5%8D%B0%E4%BA%86%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF">http://localhost:3377/configInfo查看是否打印了配置信息</a></p>
</li>
<li><p> 在nacos管理界面修改配置信息，查看3377是否更新</p>
</li>
</ol>
<h3 id="Nacos作为配置中心-分类配置"><a href="#Nacos作为配置中心-分类配置" class="headerlink" title="Nacos作为配置中心-分类配置"></a>Nacos作为配置中心-分类配置</h3><h4 id="Data-ID"><a href="#Data-ID" class="headerlink" title="Data ID"></a>Data ID</h4><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200528143514511.png" alt="image-20200528143514511"></p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200528143559804.png" alt="image-20200528143559804"></p>
<p>如果有一个dataid为<code>nacos-config-client-test.yaml</code>的配置，此时将action的值修改为test，那么它就会去读取<code>nacos-config-client-test.yaml</code>的配置，而不会去读取<code>nacos-config-client-dev.yaml</code>的配置</p>
<h4 id="Group"><a href="#Group" class="headerlink" title="Group"></a>Group</h4><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200528145005346.png" alt="image-20200528145005346"></p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200528145044527.png" alt="image-20200528145044527"></p>
<p>应该不用我说了吧😒</p>
<h4 id="namespace"><a href="#namespace" class="headerlink" title="namespace"></a>namespace</h4><p>新建命名空间</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200528145312056.png" alt="image-20200528145312056"></p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200528145354352.png" alt="image-20200528145354352"></p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200528145429410.png" alt="image-20200528145429410"></p>
<p>懂？🙄</p>
<h2 id="star-Nacos集群和持久化配置（重要）"><a href="#star-Nacos集群和持久化配置（重要）" class="headerlink" title=":star:==Nacos集群和持久化配置（重要）=="></a>:star:==Nacos集群和持久化配置（重要）==</h2><h3 id="nacos配置持久化"><a href="#nacos配置持久化" class="headerlink" title="nacos配置持久化"></a>nacos配置持久化</h3><h4 id="我的配置："><a href="#我的配置：" class="headerlink" title="我的配置："></a><strong>我的配置：</strong></h4><ul>
<li>  maven：3.5.4</li>
<li>  mysql：5.7.9</li>
<li>  nacos-server：1.2.1</li>
</ul>
<h4 id="配置步骤："><a href="#配置步骤：" class="headerlink" title="配置步骤："></a>配置步骤：</h4><ol>
<li> 在数据库创建一个库（nacos）</li>
<li> 运行<code>nacos安装目录/conf/nacos-mysql.sql</code>建立里面的表</li>
<li>修改<code>nacos安装目录/conf/application.properties</code><ol>
<li> 修改被箭头指向的，默认是被注释的。取消注释后再修改mysql的连接ip、账号和密码</li>
<li> <img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200528163454937.png" alt="image-20200528163454937"></li>
</ol>
</li>
<li> 登录nacos控制台，增加一条配置，查看数据库的config_info表有没有增加刚刚的配置</li>
</ol>
<h4 id="连接mysql8"><a href="#连接mysql8" class="headerlink" title="连接mysql8"></a>连接mysql8</h4><p>在nacos目前这个版本如果要连接mysql8需要添加jar包</p>
<p>在nacos安装目录下面添加<code>\plugins\mysql</code>目录，在这个目录中添加连接mysql8的jar包·</p>
<h3 id="nacos配置集群"><a href="#nacos配置集群" class="headerlink" title="nacos配置集群"></a>nacos配置集群</h3><h4 id="我的配置"><a href="#我的配置" class="headerlink" title="我的配置"></a>我的配置</h4><p>四台虚拟机</p>
<table>
<thead>
<tr>
<th>ip</th>
<th>部署服务</th>
</tr>
</thead>
<tbody><tr>
<td>192.168.1.106</td>
<td>nginx，mysql:5.7.9</td>
</tr>
<tr>
<td>192.168.1.105</td>
<td>nacos</td>
</tr>
<tr>
<td>192.168.1.108</td>
<td>nacos</td>
</tr>
<tr>
<td>192.168.1.109</td>
<td>nacos</td>
</tr>
</tbody></table>
<p>==为了保证可以安全通过，建议先在单机并且连接数据库的情况下先运行通过再配置集群==</p>
<p>ps: liunx 下的单机启动命令为<code>./startup.sh -m standalone</code>，因为.sh脚本里面默认是集群模式启动。如果想配置伪集群的话需要修改start.sh启动脚本</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200529095505214.png" alt="image-20200529095505214"></p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200529095713167.png" alt="image-20200529095713167"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copyright 1999-2018 Alibaba Group Holding Ltd.</span></span><br><span class="line"><span class="comment"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment"># you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"># You may obtain a copy of the License at</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#      http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"># See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"># limitations under the License.</span></span><br><span class="line"></span><br><span class="line">cygwin=<span class="literal">false</span></span><br><span class="line">darwin=<span class="literal">false</span></span><br><span class="line">os400=<span class="literal">false</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;`uname`&quot;</span> <span class="keyword">in</span></span><br><span class="line">CYGWIN*) cygwin=<span class="literal">true</span>;;</span><br><span class="line">Darwin*) darwin=<span class="literal">true</span>;;</span><br><span class="line">OS400*) os400=<span class="literal">true</span>;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line">error_exit ()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;ERROR: <span class="variable">$1</span> !!&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">&#125;</span><br><span class="line">[ ! -e <span class="string">&quot;<span class="variable">$JAVA_HOME</span>/bin/java&quot;</span> ] &amp;&amp; JAVA_HOME=<span class="variable">$HOME</span>/jdk/java</span><br><span class="line">[ ! -e <span class="string">&quot;<span class="variable">$JAVA_HOME</span>/bin/java&quot;</span> ] &amp;&amp; JAVA_HOME=/usr/java</span><br><span class="line">[ ! -e <span class="string">&quot;<span class="variable">$JAVA_HOME</span>/bin/java&quot;</span> ] &amp;&amp; JAVA_HOME=/opt/taobao/java</span><br><span class="line">[ ! -e <span class="string">&quot;<span class="variable">$JAVA_HOME</span>/bin/java&quot;</span> ] &amp;&amp; <span class="built_in">unset</span> JAVA_HOME</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$JAVA_HOME</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">  <span class="keyword">if</span> <span class="variable">$darwin</span>; <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ -x <span class="string">&#x27;/usr/libexec/java_home&#x27;</span> ] ; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">export</span> JAVA_HOME=`/usr/libexec/java_home`</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> [ -d <span class="string">&quot;/System/Library/Frameworks/JavaVM.framework/Versions/CurrentJDK/Home&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">export</span> JAVA_HOME=<span class="string">&quot;/System/Library/Frameworks/JavaVM.framework/Versions/CurrentJDK/Home&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    JAVA_PATH=`dirname $(readlink -f $(<span class="built_in">which</span> javac))`</span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;x<span class="variable">$JAVA_PATH</span>&quot;</span> != <span class="string">&quot;x&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">export</span> JAVA_HOME=`dirname <span class="variable">$JAVA_PATH</span> 2&gt;/dev/null`</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$JAVA_HOME</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        error_exit <span class="string">&quot;Please set the JAVA_HOME variable in your environment, We need java(x64)! jdk8 or later is better!&quot;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> SERVER=<span class="string">&quot;nacos-server&quot;</span></span><br><span class="line"><span class="built_in">export</span> MODE=<span class="string">&quot;cluster&quot;</span></span><br><span class="line"><span class="built_in">export</span> FUNCTION_MODE=<span class="string">&quot;all&quot;</span></span><br><span class="line"><span class="built_in">export</span> PORT=<span class="string">&quot;8848&quot;</span> <span class="comment"># =========================改这里========================</span></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">getopts</span> <span class="string">&quot;:m:f:s:p:&quot;</span> opt</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable">$opt</span> <span class="keyword">in</span></span><br><span class="line">        m)</span><br><span class="line">            MODE=<span class="variable">$OPTARG</span>;;</span><br><span class="line">        f)</span><br><span class="line">            FUNCTION_MODE=<span class="variable">$OPTARG</span>;;</span><br><span class="line">        s)</span><br><span class="line">            SERVER=<span class="variable">$OPTARG</span>;;</span><br><span class="line">        <span class="comment">#==================这里也要==================#</span></span><br><span class="line">        p)</span><br><span class="line">        	PORT=<span class="variable">$OPTARG</span>;;</span><br><span class="line">        ?)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Unknown parameter&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME</span><br><span class="line"><span class="built_in">export</span> JAVA=<span class="string">&quot;<span class="variable">$JAVA_HOME</span>/bin/java&quot;</span></span><br><span class="line"><span class="built_in">export</span> BASE_DIR=`<span class="built_in">cd</span> $(dirname <span class="variable">$0</span>)/..; <span class="built_in">pwd</span>`</span><br><span class="line"><span class="built_in">export</span> DEFAULT_SEARCH_LOCATIONS=<span class="string">&quot;classpath:/,classpath:/config/,file:./,file:./config/&quot;</span></span><br><span class="line"><span class="built_in">export</span> CUSTOM_SEARCH_LOCATIONS=<span class="variable">$&#123;DEFAULT_SEARCH_LOCATIONS&#125;</span>,file:<span class="variable">$&#123;BASE_DIR&#125;</span>/conf/</span><br><span class="line"></span><br><span class="line"><span class="comment">#===========================================================================================</span></span><br><span class="line"><span class="comment"># JVM Configuration</span></span><br><span class="line"><span class="comment">#===========================================================================================</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$&#123;MODE&#125;</span>&quot;</span> == <span class="string">&quot;standalone&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -Xms512m -Xmx512m -Xmn256m&quot;</span></span><br><span class="line">    JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -Dnacos.standalone=true&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -server -Xms2g -Xmx2g -Xmn1g -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=320m&quot;</span></span><br><span class="line">    JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -XX:-OmitStackTraceInFastThrow -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=<span class="variable">$&#123;BASE_DIR&#125;</span>/logs/java_heapdump.hprof&quot;</span></span><br><span class="line">    JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -XX:-UseLargePages&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$&#123;FUNCTION_MODE&#125;</span>&quot;</span> == <span class="string">&quot;config&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -Dnacos.functionMode=config&quot;</span></span><br><span class="line"><span class="keyword">elif</span> [[ <span class="string">&quot;<span class="variable">$&#123;FUNCTION_MODE&#125;</span>&quot;</span> == <span class="string">&quot;naming&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -Dnacos.functionMode=naming&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">JAVA_MAJOR_VERSION=$(<span class="variable">$JAVA</span> -version 2&gt;&amp;1 | sed -E -n <span class="string">&#x27;s/.* version &quot;([0-9]*).*$/\1/p&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$JAVA_MAJOR_VERSION</span>&quot;</span> -ge <span class="string">&quot;9&quot;</span> ]] ; <span class="keyword">then</span></span><br><span class="line">  JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -Xlog:gc*:file=<span class="variable">$&#123;BASE_DIR&#125;</span>/logs/nacos_gc.log:time,tags:filecount=10,filesize=102400&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -Djava.ext.dirs=<span class="variable">$&#123;JAVA_HOME&#125;</span>/jre/lib/ext:<span class="variable">$&#123;JAVA_HOME&#125;</span>/lib/ext&quot;</span></span><br><span class="line">  JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -Xloggc:<span class="variable">$&#123;BASE_DIR&#125;</span>/logs/nacos_gc.log -verbose:gc -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintGCTimeStamps -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=10 -XX:GCLogFileSize=100M&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -Dloader.path=<span class="variable">$&#123;BASE_DIR&#125;</span>/plugins/health,<span class="variable">$&#123;BASE_DIR&#125;</span>/plugins/cmdb,<span class="variable">$&#123;BASE_DIR&#125;</span>/plugins/mysql&quot;</span></span><br><span class="line">JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -Dnacos.home=<span class="variable">$&#123;BASE_DIR&#125;</span>&quot;</span></span><br><span class="line">JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> -jar <span class="variable">$&#123;BASE_DIR&#125;</span>/target/<span class="variable">$&#123;SERVER&#125;</span>.jar&quot;</span></span><br><span class="line">JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> <span class="variable">$&#123;JAVA_OPT_EXT&#125;</span>&quot;</span></span><br><span class="line">JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> --spring.config.location=<span class="variable">$&#123;CUSTOM_SEARCH_LOCATIONS&#125;</span>&quot;</span></span><br><span class="line">JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> --logging.config=<span class="variable">$&#123;BASE_DIR&#125;</span>/conf/nacos-logback.xml&quot;</span></span><br><span class="line">JAVA_OPT=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPT&#125;</span> --server.max-http-header-size=524288&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="string">&quot;<span class="variable">$&#123;BASE_DIR&#125;</span>/logs&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">  mkdir <span class="variable">$&#123;BASE_DIR&#125;</span>/logs</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$JAVA</span> <span class="variable">$&#123;JAVA_OPT&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$&#123;MODE&#125;</span>&quot;</span> == <span class="string">&quot;standalone&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;nacos is starting with standalone&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;nacos is starting with cluster&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># check the start.out log output file</span></span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="string">&quot;<span class="variable">$&#123;BASE_DIR&#125;</span>/logs/start.out&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">  touch <span class="string">&quot;<span class="variable">$&#123;BASE_DIR&#125;</span>/logs/start.out&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment"># start</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$JAVA</span> <span class="variable">$&#123;JAVA_OPT&#125;</span>&quot;</span> &gt; <span class="variable">$&#123;BASE_DIR&#125;</span>/logs/start.out 2&gt;&amp;1 &amp;</span><br><span class="line"><span class="comment"># ==========================改这里====================</span></span><br><span class="line">nohup <span class="variable">$JAVA</span> <span class="variable">$&#123;JAVA_OPT&#125;</span> -Dserver.port=<span class="variable">$&#123;PORT&#125;</span> nacos.nacos &gt;&gt; <span class="variable">$&#123;BASE_DIR&#125;</span>/logs/start.out 2&gt;&amp;1 &amp;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;nacos is starting，you can check the <span class="variable">$&#123;BASE_DIR&#125;</span>/logs/start.out&quot;</span></span><br></pre></td></tr></table></figure>



<h4 id="配置步骤"><a href="#配置步骤" class="headerlink" title="配置步骤"></a>配置步骤</h4><ol>
<li><p> 下载nacos-server.jar，注意：这里下载的版本一定要一样！！</p>
</li>
<li><p> 解压<code>tar -zxvf xxx.tar.gz</code></p>
</li>
<li><p>进入nacos安装目录\conf，使用cluster.conf.example文件的内容创建一个名称为cluster.conf的文件</p>
<ol>
<li> <code>cp cluster.conf.example cluster.conf</code></li>
<li> <img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200529092639246.png" alt="image-20200529092639246"></li>
</ol>
</li>
<li><p>修改cluster.conf文件，将文件内容添加集群ip:端口号</p>
<ol>
<li> <img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200529093022916.png" alt="image-20200529093022916"></li>
</ol>
</li>
<li><p>修改conf目录下的application.properties</p>
<ol>
<li><p> <img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200529093221473.png" alt="image-20200529093221473"></p>
</li>
<li><p> 添加mysql的配置，参考上一节的持久化配置</p>
</li>
<li><p> <img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200529093327553.png" alt="image-20200529093327553"></p>
</li>
<li><p>```properties<br> #*************** Config Module Related Configurations ***************#</p>
<h3 id="If-user-MySQL-as-datasource"><a href="#If-user-MySQL-as-datasource" class="headerlink" title="If user MySQL as datasource:"></a>If user MySQL as datasource:</h3><p> spring.datasource.platform=mysql</p>
<h3 id="Count-of-DB"><a href="#Count-of-DB" class="headerlink" title="Count of DB:"></a>Count of DB:</h3><p> db.num=1</p>
<h3 id="Connect-URL-of-DB"><a href="#Connect-URL-of-DB" class="headerlink" title="Connect URL of DB:"></a>Connect URL of DB:</h3><p> db.url.0=jdbc:mysql://192.168.1.106:3306/nacos?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true<br> db.user=root<br> db.password=123456</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">6.  启动mysql，如果要连接mysql8参考持久化里面的解决办法</span><br><span class="line"></span><br><span class="line">7.  启动三台nacos-server &#96;.&#x2F;startup.sh&#96;，时间可能会有点久</span><br><span class="line"></span><br><span class="line">8.  查看启动日志&#96;cat start.out&#96;在logs目录里面，如果出现什么错误可以看这个，或者nacos.log</span><br><span class="line"></span><br><span class="line">9.  全都启动起来之后，在浏览器中访问nacos控制台，三台都要</span><br><span class="line"></span><br><span class="line">10.  全都访问成功之后，配置nginx</span><br><span class="line"></span><br><span class="line">     1.  ![image-20200529094119789](README.assets&#x2F;image-20200529094119789.png)</span><br><span class="line"></span><br><span class="line">     2.  添加一个upstream和server</span><br><span class="line"></span><br><span class="line">     3.  &#96;&#96;&#96;nginx</span><br><span class="line">         upstream cluster &#123;</span><br><span class="line">             server 192.168.1.109:8848;</span><br><span class="line">             server 192.168.1.106:8848;</span><br><span class="line">             server 192.168.1.108:8848;</span><br><span class="line">         &#125;</span><br><span class="line">         </span><br><span class="line">         server &#123;</span><br><span class="line">             listen 23232;</span><br><span class="line">             server_name localhost;</span><br><span class="line">         </span><br><span class="line">             location &#x2F; &#123;</span><br><span class="line">                 proxy_pass http:&#x2F;&#x2F;cluster;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><p> 启动nginx，浏览器访问<a target="_blank" rel="noopener" href="http://192.168.1.106:23232/nacos%EF%BC%8C%E8%BF%99%E9%87%8C%E6%98%AF%E8%AE%BF%E9%97%AE%E7%9A%84nginx%EF%BC%8C%E6%9F%A5%E7%9C%8B%E6%9C%89%E6%B2%A1%E6%9C%89%E4%BB%A3%E7%90%86%E5%88%B0%E9%82%A3%E4%B8%89%E5%8F%B0nacos%E4%B8%8A%EF%BC%8C%E5%A6%82%E6%9E%9C%E5%87%BA%E7%8E%B0%E7%99%BB%E5%BD%95%E7%95%8C%E9%9D%A2%E5%88%99%E9%85%8D%E7%BD%AE%E6%88%90%E5%8A%9F">http://192.168.1.106:23232/nacos，这里是访问的nginx，查看有没有代理到那三台nacos上，如果出现登录界面则配置成功</a></p>
</li>
<li><p>nacos控制台添加一个配置，查看其他两台nacos有没有同样的数据，有就ok啦！！！！😆</p>
<p> ps：我配了一下午加一晚上🙃，该死的版本</p>
</li>
</ol>
<h1 id="star2-十五、SpringCloud-Alibaba-Sentinle实现熔断与限流"><a href="#star2-十五、SpringCloud-Alibaba-Sentinle实现熔断与限流" class="headerlink" title=":star2:十五、SpringCloud Alibaba Sentinle实现熔断与限流"></a>:star2:十五、SpringCloud Alibaba Sentinle实现熔断与限流</h1><h2 id="Sentinle"><a href="#Sentinle" class="headerlink" title="Sentinle"></a>Sentinle</h2><h3 id="官网-2"><a href="#官网-2" class="headerlink" title="官网"></a>官网</h3><p><a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel">https://github.com/alibaba/Sentinel</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/%E4%BB%8B%E7%BB%8D">中文版</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki">wiki</a></p>
<h3 id="是什么-11"><a href="#是什么-11" class="headerlink" title="是什么"></a>是什么</h3><p>一句话解释，之前我们讲解过的Hystrix的Alibaba版</p>
<h3 id="去哪下-2"><a href="#去哪下-2" class="headerlink" title="去哪下"></a>去哪下</h3><p><a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/releases">https://github.com/alibaba/Sentinel/releases</a></p>
<h3 id="能干嘛-6"><a href="#能干嘛-6" class="headerlink" title="能干嘛"></a>能干嘛</h3><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200529101917054.png" alt="image-20200529101917054"></p>
<h3 id="怎么玩"><a href="#怎么玩" class="headerlink" title="怎么玩"></a>怎么玩</h3><p><a target="_blank" rel="noopener" href="https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html#_spring_cloud_alibaba_sentinel">官网解释</a></p>
<p>服务使用中的各种问题</p>
<ul>
<li>  服务雪崩</li>
<li>  服务降级</li>
<li>  服务熔断</li>
<li>  服务限流</li>
</ul>
<h2 id="安装Sentinle控制台"><a href="#安装Sentinle控制台" class="headerlink" title="安装Sentinle控制台"></a>安装Sentinle控制台</h2><h3 id="Sentinel-分为两个部分"><a href="#Sentinel-分为两个部分" class="headerlink" title="Sentinel 分为两个部分:"></a>Sentinel 分为两个部分:</h3><ul>
<li>  核心库(Java 客户端)不依赖任何框架/库,能够运行于所有Java 运行时环境,同时对 Dubbo/Spring Cloud 等框架也有较好的支持.</li>
<li>控制台(Dashboard)基于 Spring Boot 开发,打包后可以直接运行,不需要额外的 Tomcat等应用<br>  容器.</li>
</ul>
<h3 id="安装启动步骤"><a href="#安装启动步骤" class="headerlink" title="安装启动步骤"></a>安装启动步骤</h3><ol>
<li>下载<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/releases/download/1.7.2/sentinel-dashboard-1.7.2.jar">sentinel-dashboard-1.7.2.jar</a><ol>
<li> <img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200529102718476.png" alt="image-20200529102718476"></li>
</ol>
</li>
<li> 使用 <code>java -jar</code> 命令启动，但是注意：sentinel的默认前台端口号为8080，所以8080端口不能被占用，并且需要java8的环境</li>
<li>浏览器输入<code>localhost:8080</code>，如果出现以下界面说明启动成功<ol>
<li> <img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200529103148889.png" alt="image-20200529103148889"></li>
</ol>
</li>
<li>登录sentinel，用户名和密码都是sentinel<ol>
<li> <img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200529103241722.png" alt="image-20200529103241722"></li>
</ol>
</li>
</ol>
<h2 id="初始化演示工程"><a href="#初始化演示工程" class="headerlink" title="初始化演示工程"></a>初始化演示工程</h2><h3 id="创建cloudalibaba-sentinel-service8401"><a href="#创建cloudalibaba-sentinel-service8401" class="headerlink" title="创建cloudalibaba-sentinel-service8401"></a>创建cloudalibaba-sentinel-service8401</h3><h4 id="POM-4"><a href="#POM-4" class="headerlink" title="POM"></a>POM</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span><span class="comment">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ll.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--SpringCloud ailibaba nacos --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--SpringCloud ailibaba sentinel-datasource-nacos 后续做持久化用到--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-datasource-nacos<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--SpringCloud ailibaba sentinel --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--openfeign--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- SpringBoot整合Web组件+actuator --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--日常通用jar包配置--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.6.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="YML-3"><a href="#YML-3" class="headerlink" title="YML"></a>YML</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8401</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloudalibaba-sentinel-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#Nacos服务注册中心地址</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:8080</span> <span class="comment">#配置Sentinel dashboard地址</span></span><br><span class="line">        <span class="comment"># 默认是8719，如果端口被占用会自动+1直到找到可用的端口</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8719</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span></span><br></pre></td></tr></table></figure>



<h4 id="主启动-3"><a href="#主启动-3" class="headerlink" title="主启动"></a>主启动</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainApp8410</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MainApp8410.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="业务类FlowLimitController"><a href="#业务类FlowLimitController" class="headerlink" title="业务类FlowLimitController"></a>业务类FlowLimitController</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowLimitController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/testA&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testA</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;------testA&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/testB&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testB</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        log.info(Thread.currentThread().getName()+<span class="string">&quot;\t&quot;</span>+<span class="string">&quot;...testB&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;------testB&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="测试-21"><a href="#测试-21" class="headerlink" title="测试"></a>测试</h3><ol>
<li> 启动依次nacos-server、sentinel和8401</li>
<li>登录sentinel的控制台会发现空空如也，为啥一个被监控的服务没有？<ol>
<li> <img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200529110904527.png" alt="image-20200529110904527"></li>
<li> 因为sentinel默认是懒加载，需要对应的服务有一次请求</li>
</ol>
</li>
<li>浏览器访问：<a target="_blank" rel="noopener" href="http://localhost:8401/testA%E5%92%8Chttp://localhost:8401/testB%EF%BC%8C%E7%84%B6%E5%90%8E%E5%86%8D%E6%9F%A5%E7%9C%8Bsentinel%E6%8E%A7%E5%88%B6%E5%8F%B0">http://localhost:8401/testA和http://localhost:8401/testB，然后再查看sentinel控制台</a><ol>
<li> <img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200529111045642.png" alt="image-20200529111045642"></li>
</ol>
</li>
</ol>
<h2 id="流控规则（流量控制）"><a href="#流控规则（流量控制）" class="headerlink" title="流控规则（流量控制）"></a>流控规则（流量控制）</h2><h3 id="基本介绍"><a href="#基本介绍" class="headerlink" title="基本介绍"></a>基本介绍</h3><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200529112141525.png" alt="image-20200529112141525"></p>
<ul>
<li>  资源名：唯一名称，默认请求路径</li>
<li>  针对来源：<code>Sentinel</code>可以针对调用者进行限流，填写微服务名，指定对哪个微服务进行限流 ，默认<code>default</code>(不区分来源，全部限制)</li>
<li>阈值类型/单机阈值：<ul>
<li>  QPS(每秒钟的请求数量)：当调用该接口的QPS达到了阈值的时候，进行限流；</li>
<li>  线程数：当调用该接口的线程数达到阈值时，进行限流</li>
</ul>
</li>
<li>  是否集群：不需要集群</li>
<li>流控模式：<ul>
<li>  直接：接口达到限流条件时，直接限流</li>
<li>  关联：当关联的资源达到阈值时，就限流自己</li>
<li>  链路：只记录指定链路上的流量（指定资源从入口资源进来的流量，如果达到阈值，就可以限流）[api级别的针对来源]</li>
</ul>
</li>
<li>流控效果<ul>
<li>  快速失败：直接失败，就异常</li>
<li>  Warm Up：根据**<code>codeFactor</code>**（冷加载因子，默认为3）的值，即请求 QPS 从 <strong><code>threshold / 3</code></strong> 开始，经预热时长逐渐升至设定的 QPS 阈值</li>
<li>  排队等待：匀速排队,让请求以匀速的速度通过,阈值类型必须设置为QPS,否则无效</li>
</ul>
</li>
</ul>
<p><a href="%5Bhttps://github.com/alibaba/Sentinel/wiki/%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6#%E5%9F%BA%E4%BA%8Eqps%E5%B9%B6%E5%8F%91%E6%95%B0%E7%9A%84%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%5D(https://github.com/alibaba/Sentinel/wiki/%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6#%E5%9F%BA%E4%BA%8Eqps%E5%B9%B6%E5%8F%91%E6%95%B0%E7%9A%84%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6)">详情看这里</a></p>
<h3 id="流控模式"><a href="#流控模式" class="headerlink" title="流控模式"></a>流控模式</h3><ol>
<li><p>直接快速失败</p>
<p>  <img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/../../springcloud/%E5%9B%BE%E7%89%87/sentinel%E7%9A%849.png"></p>
<p>  <img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/sentinel%E7%9A%845.png"></p>
<pre><code> ==直接失败的效果:==
</code></pre>
<p>  <img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/sentinel%E7%9A%846.png"></p>
</li>
<li><p>线程数:</p>
<p> ​        <img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/../../springcloud/%E5%9B%BE%E7%89%87/sentinel%E7%9A%848.png"></p>
<p> ​    <img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/sentinel%E7%9A%8410.png"></p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">比如a请求过来,处理很慢,在一直处理,此时b请求又过来了</span><br><span class="line">		此时因为a占用一个线程,此时要处理b请求就只有额外开启一个线程</span><br><span class="line">		那么就会报错</span><br></pre></td></tr></table></figure>

<p> <img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/sentinel%E7%9A%8411.png"></p>
</li>
</ol>
<h3 id="流控规则"><a href="#流控规则" class="headerlink" title="流控规则"></a>流控规则</h3><h4 id="直接（默认）"><a href="#直接（默认）" class="headerlink" title="直接（默认）"></a>直接（默认）</h4><p>快速点击访问<a target="_blank" rel="noopener" href="http://localhost:8401/testA">http://localhost:8401/testA</a></p>
<p>一秒只能访问一次，快速访问会出现Blocked by Sentinel (flow limiting)错误</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200529113305794.png" alt="image-20200529113305794">测试</p>
<p><strong>问题：</strong></p>
<p>直接调用默认报错信息，技术方面OK but，是否应该有我们自己的后续处理？<br>类似有一个fallback的兜底方法？</p>
<h4 id="关联"><a href="#关联" class="headerlink" title="关联"></a>关联</h4><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/sentinel%E7%9A%8412.png"></p>
<p>==应用场景:  比如<strong>支付接口</strong>达到阈值,就要限流下<strong>订单的接口</strong>,防止一直有订单==</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/sentinel%E7%9A%8413.png"></p>
<p><strong>当testA达到阈值,qps大于1,就让testB之后的请求直接失败</strong></p>
<p>可以使用postman压测</p>
<h4 id="链路"><a href="#链路" class="headerlink" title="链路"></a>链路</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">            machine-root</span><br><span class="line">              &#x2F;       \</span><br><span class="line">             &#x2F;         \</span><br><span class="line">       Entrance1     Entrance2</span><br><span class="line">          &#x2F;             \</span><br><span class="line">         &#x2F;               \</span><br><span class="line">DefaultNode(nodeA)   DefaultNode(nodeA)</span><br></pre></td></tr></table></figure>

<p>如上所示的Node分布情况，资源nodeA分别在两个上下文Entrance1和Entrance2下进行调用，假设在上下文Entrance1的调用量很大，而上下文Entrance2的调用量很小，我们想针对Entrance1上下文的nodeA调用进行限流，那么可以使用<strong>链路限流模式</strong>，配置如下：</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/a.png" alt="img"> </p>
<p>那么在上下文Entrance2下对nodeA的调用就没有影响</p>
<h4 id="预热Warm-up"><a href="#预热Warm-up" class="headerlink" title="预热Warm up"></a>预热Warm up</h4><p>​     <img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/sentinel%E7%9A%8414.png"></p>
<p>  <img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/../../springcloud/%E5%9B%BE%E7%89%87/sentinel%E7%9A%8415.png"></p>
<p> <img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/sentinel%E7%9A%8416.png"></p>
<p> ==应用场景==</p>
<p> <img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/sentinel%E7%9A%8417.png"></p>
<h4 id="排队等待"><a href="#排队等待" class="headerlink" title="排队等待"></a>排队等待</h4><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/sentinel%E7%9A%8418.png"></p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/sentinel%E7%9A%8419.png"></p>
<h2 id="降级规则"><a href="#降级规则" class="headerlink" title="降级规则"></a>降级规则</h2><p><strong>就是熔断降级</strong></p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/sentinel%E7%9A%8421.png"></p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/sentinel%E7%9A%8420.png"></p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/sentinel%E7%9A%8422.png"></p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/sentinel%E7%9A%8423.png"></p>
<h3 id="RT配置"><a href="#RT配置" class="headerlink" title="RT配置:"></a>RT配置:</h3><p>新增一个请求方法用于测试</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/sentinel%E7%9A%8424.png"></p>
<p>==配置RT:==</p>
<p>​                这里配置的PT,默认是秒级的平均响应时间</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/sentinel%E7%9A%8425.png"></p>
<p>默认计算平均时间是: 1秒类进入5个请求,并且响应的平均值超过阈值(这里的200ms),就报错]</p>
<p>​            1秒5请求是Sentinel默认设置的</p>
<p>==测试==</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/sentinel%E7%9A%8427.png"></p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/sentinel%E7%9A%8426.png"></p>
<p><strong>默认熔断后.就直接抛出异常</strong></p>
<h3 id="异常比例"><a href="#异常比例" class="headerlink" title="异常比例:"></a>异常比例:</h3><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/sentinel%E7%9A%8428.png"></p>
<p>修改请求方法</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/sentinel%E7%9A%8429.png"></p>
<p>配置:</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/sentinel%E7%9A%8431.png"></p>
<p>==如果没触发熔断,这正常抛出异常==:</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/sentinel%E7%9A%8432.png"></p>
<p>==触发熔断==:</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/sentinel%E7%9A%8433.png"></p>
<h3 id="异常数"><a href="#异常数" class="headerlink" title="异常数:"></a>异常数:</h3><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/sentinel%E7%9A%8434.png"></p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/sentinel%E7%9A%8435.png"></p>
<p>一分钟之内,有5个请求发送异常,进入熔断</p>
<h2 id="热点规则"><a href="#热点规则" class="headerlink" title="热点规则"></a>热点规则</h2><blockquote>
<p>  何为热点？热点即经常访问的数据。很多时候我们希望统计某个热点数据中访问频次最高的 Top K 数据，并对其访问进行限制。比如：</p>
<ul>
<li>  商品 ID 为参数，统计一段时间内最常购买的商品 ID 并进行限制</li>
<li>  用户 ID 为参数，针对一段时间内频繁访问的用户 ID 进行限制</li>
</ul>
<p>  热点参数限流会统计传入参数中的热点参数，并根据配置的限流阈值与模式，对包含热点参数的资源调用进行限流。热点参数限流可以看做是一种特殊的流量控制，仅对包含热点参数的资源调用生效。</p>
</blockquote>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200529142000115.png" alt="image-20200529142000115"></p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200529142308769.png" alt="image-20200529142308769"></p>
<p>参数索引是方法里面的参数位置，而不是网址里面的参数位置</p>
<h3 id="修改8401"><a href="#修改8401" class="headerlink" title="修改8401"></a>修改8401</h3><p>在controller中新增一个方法</p>
<p>@SentinelResource：value值作为新增热点规则时添加的资源名，不能重复；blockHandler值为兜底的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/testHotKey&quot;)</span></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;testHotKey&quot;, blockHandler = &quot;testHotKey_block&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">testHotKey</span><span class="params">(<span class="meta">@RequestParam(value = &quot;p1&quot;, required = false)</span> String p1,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="meta">@RequestParam(value = &quot;p2&quot;, required = false)</span> String p2)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> p1+<span class="string">&quot;, &quot;</span>+p2;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">testHotKey_block</span><span class="params">(String p1, String p2, BlockException e)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;qwq&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="额外配置"><a href="#额外配置" class="headerlink" title="额外配置"></a>额外配置</h3><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200529143651570.png" alt="image-20200529143651570"></p>
<p>当参数值为eee时限流阈值为200</p>
<p><a target="_blank" rel="noopener" href="http://localhost:8401/testHotKey?p1=eee">http://localhost:8401/testHotKey?p1=eee</a> 限流阈值为200</p>
<p><a target="_blank" rel="noopener" href="http://localhost:8401/testHotKey?p1=123">http://localhost:8401/testHotKey?p1=123</a> 限流阈值为1</p>
<h2 id="系统规则"><a href="#系统规则" class="headerlink" title="系统规则"></a>系统规则</h2><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200529145026877.png" alt="image-20200529145026877"></p>
<p>系统规则支持以下的模式：</p>
<ul>
<li>  <strong>Load 自适应</strong>（仅对 Linux/Unix-like 机器生效）：系统的 load1 作为启发指标，进行自适应系统保护。当系统 load1 超过设定的启发值，且系统当前的并发线程数超过估算的系统容量时才会触发系统保护（BBR 阶段）。系统容量由系统的 <code>maxQps * minRt</code> 估算得出。设定参考值一般是 <code>CPU cores * 2.5</code>。</li>
<li>  <strong>CPU usage</strong>（1.5.0+ 版本）：当系统 CPU 使用率超过阈值即触发系统保护（取值范围 0.0-1.0），比较灵敏。</li>
<li>  <strong>平均 RT</strong>：当单台机器上所有入口流量的平均 RT 达到阈值即触发系统保护，单位是毫秒。</li>
<li>  <strong>并发线程数</strong>：当单台机器上所有入口流量的并发线程数达到阈值即触发系统保护。</li>
<li>  <strong>入口 QPS</strong>：当单台机器上所有入口流量的 QPS 达到阈值即触发系统保护。</li>
</ul>
<h2 id="SentinelResource注解"><a href="#SentinelResource注解" class="headerlink" title="@SentinelResource注解"></a>@SentinelResource注解</h2><p><a href="%5Bhttps://github.com/alibaba/Sentinel/wiki/%E6%B3%A8%E8%A7%A3%E6%94%AF%E6%8C%81%5D(https://github.com/alibaba/Sentinel/wiki/%E6%B3%A8%E8%A7%A3%E6%94%AF%E6%8C%81)">详细的看这里</a></p>
<blockquote>
<h2 id="SentinelResource-注解"><a href="#SentinelResource-注解" class="headerlink" title="@SentinelResource 注解"></a>@SentinelResource 注解</h2><blockquote>
<p>  注意：注解方式埋点不支持 private 方法。</p>
</blockquote>
<p>  <code>@SentinelResource</code> 用于定义资源，并提供可选的异常处理和 fallback 配置项。 <code>@SentinelResource</code> 注解包含以下属性：</p>
<ul>
<li>  <code>value</code>：资源名称，必需项（不能为空）</li>
<li>  <code>entryType</code>：entry 类型，可选项（默认为 <code>EntryType.OUT</code>）</li>
<li>  <code>blockHandler</code> / <code>blockHandlerClass</code>: <code>blockHandler</code> 对应处理 <code>BlockException</code> 的函数名称，可选项。blockHandler 函数访问范围需要是 <code>public</code>，返回类型需要与原方法相匹配，参数类型需要和原方法相匹配并且最后加一个额外的参数，类型为 <code>BlockException</code>。blockHandler 函数默认需要和原方法在同一个类中。若希望使用其他类的函数，则可以指定 <code>blockHandlerClass</code> 为对应的类的 <code>Class</code> 对象，注意对应的函数必需为 static 函数，否则无法解析。</li>
<li><code>fallback</code> / <code>fallbackClass</code>：fallback 函数名称，可选项，用于在抛出异常的时候提供 fallback 处理逻辑。fallback 函数可以针对所有类型的异常（除了 <code>exceptionsToIgnore</code> 里面排除掉的异常类型）进行处理。fallback 函数签名和位置要求：<ul>
<li>  返回值类型必须与原函数返回值类型一致；</li>
<li>  方法参数列表需要和原函数一致，或者可以额外多一个 <code>Throwable</code> 类型的参数用于接收对应的异常。</li>
<li>  fallback 函数默认需要和原方法在同一个类中。若希望使用其他类的函数，则可以指定 <code>fallbackClass</code> 为对应的类的 <code>Class</code> 对象，注意对应的函数必需为 static 函数，否则无法解析。</li>
</ul>
</li>
<li><code>defaultFallback</code>（since 1.6.0）：默认的 fallback 函数名称，可选项，通常用于通用的 fallback 逻辑（即可以用于很多服务或方法）。默认 fallback 函数可以针对所有类型的异常（除了 <code>exceptionsToIgnore</code>里面排除掉的异常类型）进行处理。若同时配置了 fallback 和 defaultFallback，则只有 fallback 会生效。defaultFallback 函数签名要求：<ul>
<li>  返回值类型必须与原函数返回值类型一致；</li>
<li>  方法参数列表需要为空，或者可以额外多一个 <code>Throwable</code> 类型的参数用于接收对应的异常。</li>
<li>  defaultFallback 函数默认需要和原方法在同一个类中。若希望使用其他类的函数，则可以指定 <code>fallbackClass</code> 为对应的类的 <code>Class</code> 对象，注意对应的函数必需为 static 函数，否则无法解析。</li>
</ul>
</li>
<li>  <code>exceptionsToIgnore</code>（since 1.6.0）：用于指定哪些异常被排除掉，不会计入异常统计中，也不会进入 fallback 逻辑中，而是会原样抛出。</li>
</ul>
<blockquote>
<p>  注：1.6.0 之前的版本 fallback 函数只针对降级异常（<code>DegradeException</code>）进行处理，<strong>不能针对业务异常进行处理</strong>。</p>
</blockquote>
<p>  ==特别地，若 blockHandler 和 fallback 都进行了配置，则被限流降级而抛出 <code>BlockException</code> 时只会进入 <code>blockHandler</code> 处理逻辑。若未配置 <code>blockHandler</code>、<code>fallback</code> 和 <code>defaultFallback</code>，则被限流降级时会将 <code>BlockException</code> <strong>直接抛出</strong>（若方法本身未定义 throws BlockException 则会被 JVM 包装一层 <code>UndeclaredThrowableException</code>）。==</p>
</blockquote>
<p>blockHandler支持重写</p>
<p><code>fallback</code> 管java异常<code>blockHandler</code> 管<code>BlockException</code> </p>
<p>按url限流使用的是默认的兜底方法，而不是指定的兜底方法</p>
<p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/image-20200529152748291.png" alt="image-20200529152748291"></p>
<h3 id="自定义限流处理逻辑"><a href="#自定义限流处理逻辑" class="headerlink" title="自定义限流处理逻辑:"></a>自定义限流处理逻辑:</h3><ol>
<li><p>==单独创建一个类,用于处理限流==</p>
<p> <img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/sentinel%E7%9A%84%E7%9A%841.png"></p>
</li>
<li><p>==在controller中,指定使用自定义类中的方法作为降级方法==</p>
<p> <img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/sentinel%E7%9A%84%E7%9A%842.png"></p>
</li>
</ol>
<h2 id="服务熔断-1"><a href="#服务熔断-1" class="headerlink" title="服务熔断"></a>服务熔断</h2><p>sentinel整合ribbon+openFeign+fallback</p>
<p>有手就行，去参考openFeign整合豪猪哥的笔记，累了，不想写了。</p>
<p>注意添加openFeign对sentinel的支持，和openFeign的依赖</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">sentinel:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 激活Sentinel对Feign的支持</span></span><br></pre></td></tr></table></figure>

<h2 id="规则持久化"><a href="#规则持久化" class="headerlink" title="规则持久化"></a>规则持久化</h2><h3 id="sentinel-规则持久化到nacos"><a href="#sentinel-规则持久化到nacos" class="headerlink" title="sentinel 规则持久化到nacos"></a>sentinel 规则持久化到nacos</h3><blockquote>
<p>  <strong>目录</strong></p>
</blockquote>
<h4 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h4><p>Sentinel Dashboard中添加的规则是存储在内存中的，只要项目一重启规则就丢失了</p>
<p>此处将规则持久化到nacos中，在nacos中添加规则，然后同步到dashboard中；</p>
<p>后面研究如果将dashboard中添加的规则自动添加到nacos中</p>
<p>官网教程地址：<a target="_blank" rel="noopener" href="https://github.com/alibaba/spring-cloud-alibaba/wiki/Sentinel">https://github.com/alibaba/spring-cloud-alibaba/wiki/Sentinel</a></p>
<h4 id="实现过程"><a href="#实现过程" class="headerlink" title="实现过程"></a>实现过程</h4><p>1.导入依赖包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>Greenwich.SR2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-datasource-nacos<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>2.在application.properties中配置sentinel-nacos信息</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.application.name</span>=<span class="string">mz</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">8003</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># sentinel dashboard</span></span><br><span class="line"><span class="meta">spring.cloud.sentinel.transport.dashboard</span>=<span class="string">localhost:8080</span></span><br><span class="line"></span><br><span class="line"><span class="meta">spring.cloud.sentinel.datasource.ds1.nacos.server-addr</span>=<span class="string">localhost:8848</span></span><br><span class="line"><span class="meta">spring.cloud.sentinel.datasource.ds1.nacos.data-id</span>=<span class="string">mz-sentinel</span></span><br><span class="line"><span class="meta">spring.cloud.sentinel.datasource.ds1.nacos.group-id</span>=<span class="string">DEFAULT_GROUP</span></span><br><span class="line"><span class="meta">spring.cloud.sentinel.datasource.ds1.nacos.data-type</span>=<span class="string">json</span></span><br><span class="line"><span class="meta">spring.cloud.sentinel.datasource.ds1.nacos.rule-type</span>=<span class="string">flow</span></span><br></pre></td></tr></table></figure>

<p>3.在nacos中添加规则</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://img2018.cnblogs.com/blog/1230278/201907/1230278-20190731222443568-75493756.png" alt="img"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;resource&quot;:</span> <span class="string">&quot;/hello&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;limitApp&quot;:</span> <span class="string">&quot;default&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;grade&quot;:</span> <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;count&quot;:</span> <span class="number">5</span>,</span><br><span class="line">        <span class="attr">&quot;strategy&quot;:</span> <span class="number">0</span>,</span><br><span class="line">        <span class="attr">&quot;controlBehavior&quot;:</span> <span class="number">0</span>,</span><br><span class="line">        <span class="attr">&quot;clusterMode&quot;:</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>



<p>4.创建测试类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello sentinel&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>访问几次接口之后，就可以在Sentinel Dashboard 中看到在nacos中配置的规则信息了，并且项目服务重启依然存在</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://img2018.cnblogs.com/blog/1230278/201907/1230278-20190731222719960-166637927.png" alt="img"></p>
<h3 id="修改规则同步到Nacos"><a href="#修改规则同步到Nacos" class="headerlink" title="修改规则同步到Nacos"></a><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/b597664c7678">修改规则同步到Nacos</a></h3><h4 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h4><p>下面直接来看看如何实现的具体改造步骤，这里参考了<code>Sentinel Dashboard</code>源码中关于Nacos实现的测试用例。但是由于考虑到与Spring Cloud Alibaba的结合使用，略作修改。</p>
<p><strong>第一步</strong>：修改<code>pom.xml</code>中的sentinel-datasource-nacos的依赖，将<code>&lt;scope&gt;test&lt;/scope&gt;</code>注释掉，这样才能在主程序中使用。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-datasource-nacos<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;scope&gt;test&lt;/scope&gt;--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>第二步</strong>：找到<code>resources/app/scripts/directives/sidebar/sidebar.html</code>中的这段代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">ui-sref-active</span>=<span class="string">&quot;active&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">ui-sref</span>=<span class="string">&quot;dashboard.flowV1(&#123;app: entry.app&#125;)&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;glyphicon glyphicon-filter&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span><span class="symbol">&amp;nbsp;</span><span class="symbol">&amp;nbsp;</span>流控规则</span><br><span class="line">    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>修改为：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">ui-sref-active</span>=<span class="string">&quot;active&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">ui-sref</span>=<span class="string">&quot;dashboard.flow(&#123;app: entry.app&#125;)&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;glyphicon glyphicon-filter&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span><span class="symbol">&amp;nbsp;</span><span class="symbol">&amp;nbsp;</span>流控规则</span><br><span class="line">    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>第三步</strong>：在<code>com.alibaba.csp.sentinel.dashboard.rule</code>包下新建一个nacos包，用来编写针对Nacos的扩展实现。</p>
<p><strong>第四步</strong>：创建Nacos的配置类，具体代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NacosConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Converter&lt;List&lt;FlowRuleEntity&gt;, String&gt; flowRuleEntityEncoder() &#123;</span><br><span class="line">        <span class="keyword">return</span> JSON::toJSONString;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Converter&lt;String, List&lt;FlowRuleEntity&gt;&gt; flowRuleEntityDecoder() &#123;</span><br><span class="line">        <span class="keyword">return</span> s -&gt; JSON.parseArray(s, FlowRuleEntity.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConfigService <span class="title">nacosConfigService</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.put(PropertyKeyConst.SERVER_ADDR, <span class="string">&quot;localhost&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ConfigFactory.createConfigService(properties);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果用到了namespace隔离环境，可以在<code>nacosConfigService</code>方法中再加入配置，比如：<code>properties.put(PropertyKeyConst.NAMESPACE, &quot;130e71fa-97fe-467d-ad77-967456f2c16d&quot;);</code></p>
<p><strong>第五步</strong>：实现Nacos的配置拉取。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component(&quot;flowRuleNacosProvider&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowRuleNacosProvider</span> <span class="keyword">implements</span> <span class="title">DynamicRuleProvider</span>&lt;<span class="title">List</span>&lt;<span class="title">FlowRuleEntity</span>&gt;&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ConfigService configService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Converter&lt;String, List&lt;FlowRuleEntity&gt;&gt; converter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FLOW_DATA_ID_POSTFIX = <span class="string">&quot;-sentinel&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String GROUP_ID = <span class="string">&quot;DEFAULT_GROUP&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;FlowRuleEntity&gt; <span class="title">getRules</span><span class="params">(String appName)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String rules = configService.getConfig(appName + FLOW_DATA_ID_POSTFIX, GROUP_ID, <span class="number">3000</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtil.isEmpty(rules)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> converter.convert(rules);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>  <code>getRules</code>方法中的<code>appName</code>参数是Sentinel中的服务名称。</li>
<li>  <code>configService.getConfig</code>方法是从Nacos中获取配置信息的具体操作。其中，DataId和GroupId分别对应客户端使用时候的对应配置。比如这里的例子对应了之前我们在<a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=http://blog.didispace.com/spring-cloud-alibaba-sentinel-2-1/">《Sentinel使用Nacos存储规则》</a>一文中的配置，具体如下：</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.cloud.sentinel.datasource.ds.nacos.groupId</span>=<span class="string">DEFAULT_GROUP</span></span><br><span class="line"><span class="meta">spring.cloud.sentinel.datasource.ds.nacos.dataId</span>=<span class="string">$&#123;spring.application.name&#125;-sentinel</span></span><br></pre></td></tr></table></figure>

<p>注意：两边的DataId和GroupId必须对应上。</p>
<p><strong>第六步</strong>：实现Nacos的配置推送。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component(&quot;flowRuleNacosPublisher&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowRuleNacosPublisher</span> <span class="keyword">implements</span> <span class="title">DynamicRulePublisher</span>&lt;<span class="title">List</span>&lt;<span class="title">FlowRuleEntity</span>&gt;&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ConfigService configService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Converter&lt;List&lt;FlowRuleEntity&gt;, String&gt; converter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FLOW_DATA_ID_POSTFIX = <span class="string">&quot;-sentinel&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String GROUP_ID = <span class="string">&quot;DEFAULT_GROUP&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publish</span><span class="params">(String app, List&lt;FlowRuleEntity&gt; rules)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        AssertUtil.notEmpty(app, <span class="string">&quot;app name cannot be empty&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (rules == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        configService.publishConfig(app + FLOW_DATA_ID_POSTFIX, GROUP_ID, converter.convert(rules));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>  这里的大部分内容与上一步中的实现一致。主要就是Nacos中存储配置的DataId和GroupId不要弄错。</li>
</ul>
<p><strong>第七步</strong>：修改<code>com.alibaba.csp.sentinel.dashboard.controller.v2.FlowControllerV2</code>中<code>DynamicRuleProvider</code>和<code>DynamicRulePublisher</code>注入的Bean，改为上面我们编写的针对Apollo的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="meta">@Qualifier(&quot;flowRuleNacosProvider&quot;)</span></span><br><span class="line"><span class="keyword">private</span> DynamicRuleProvider&lt;List&lt;FlowRuleEntity&gt;&gt; ruleProvider;</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="meta">@Qualifier(&quot;flowRuleNacosPublisher&quot;)</span></span><br><span class="line"><span class="keyword">private</span> DynamicRulePublisher&lt;List&lt;FlowRuleEntity&gt;&gt; rulePublisher;</span><br></pre></td></tr></table></figure>



<h1 id="十六、SpringCloud-Seata-处理分布式事务"><a href="#十六、SpringCloud-Seata-处理分布式事务" class="headerlink" title="十六、SpringCloud Seata 处理分布式事务"></a>十六、SpringCloud Seata 处理分布式事务</h1><h2 id="seata简介"><a href="#seata简介" class="headerlink" title="seata简介"></a>seata简介</h2><h3 id="分布式事务问题"><a href="#分布式事务问题" class="headerlink" title="分布式事务问题"></a>分布式事务问题</h3><p>一句话：一次业务操作需要跨多个数据源或需要跨多个系统进行远程调用，就会产生分布式事务问题</p>
<h3 id="是什么-12"><a href="#是什么-12" class="headerlink" title="是什么"></a>是什么</h3><blockquote>
<p>  Seata是一款开源的分布式事务解决方案，致力于在微服务架构下提供高性能和简单易用的分布式事务服务<br>  <a target="_blank" rel="noopener" href="http://seata.io/zh-cn/">官网地址</a></p>
</blockquote>
<h3 id="能干嘛-7"><a href="#能干嘛-7" class="headerlink" title="能干嘛"></a>能干嘛</h3><p><strong>一个典型的分布式事务过程：</strong></p>
<p><strong>分布式事务处理过程的-ID+三组件模型</strong></p>
<ul>
<li><strong>Transaction ID XID</strong><ul>
<li>  全局唯一的事务ID</li>
</ul>
</li>
<li><strong>3组件概念</strong><ul>
<li>Transaction Coordinator(TC) <ul>
<li>  事务协调器，维护全局事务的运行状态，负责协调并驱动全局事务的提交或回滚;</li>
</ul>
</li>
<li>Transaction  Manager(TM) <ul>
<li>  控制全局事务的边界，负责开启一个全局事务，并最终发起全局提交或全局回滚的决议;</li>
</ul>
</li>
<li>Resource Manager(RM) <ul>
<li>  控制分支事务，负责分支注册，状态汇报，并接收事务协调器的指令，驱动分支（本地）事务的提交和回滚；</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="处理过程"><a href="#处理过程" class="headerlink" title="处理过程"></a>处理过程</h3><p><img src= "/img/loading.gif" data-lazy-src="/2020/07/05/spring-cloud/spring-cloud/TB1rDpkJAvoK1RjSZPfXXXPKFXa-794-478.png" alt="img"></p>
<ol>
<li> TM向TC 申请开启一个全局事务,全局事务创建成功并生成一个全局唯一的XID;</li>
<li> XID 在微服务调用链路的上下文中传播;</li>
<li> RM向TC 注册分支事务,将其纳入XID 对应全局事务的管辖;</li>
<li> TM向TC 发起针对XID 的全局提交或回滚决议;</li>
<li> TC调度 XID 下管辖的全部分支事务完成提交或回滚请求。</li>
</ol>
<h3 id="Seata术语"><a href="#Seata术语" class="headerlink" title="Seata术语"></a>Seata术语</h3><h4 id="TC-事务协调者"><a href="#TC-事务协调者" class="headerlink" title="TC - 事务协调者"></a>TC - 事务协调者</h4><p>维护全局和分支事务的状态，驱动全局事务提交或回滚。</p>
<h4 id="TM-事务管理器"><a href="#TM-事务管理器" class="headerlink" title="TM - 事务管理器"></a>TM - 事务管理器</h4><p>定义全局事务的范围：开始全局事务、提交或回滚全局事务。</p>
<h4 id="RM-资源管理器"><a href="#RM-资源管理器" class="headerlink" title="RM - 资源管理器"></a>RM - 资源管理器</h4><p>管理分支事务处理的资源，与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。</p>
<h2 id="Seata下载安装"><a href="#Seata下载安装" class="headerlink" title="Seata下载安装"></a>Seata下载安装</h2><h3 id="下载-1"><a href="#下载-1" class="headerlink" title="下载"></a>下载</h3><p><a target="_blank" rel="noopener" href="http://seata.io/zh-cn/blog/download.html">官网地址</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/seata/seata/releases">下载地址</a></p>
<p>我下载的是<a target="_blank" rel="noopener" href="https://github.com/seata/seata/releases/tag/v1.0.0">v1.0.0-GA</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">LLQWQ</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://llqwq.gitee.io/2020/07/05/spring-cloud/spring-cloud/">http://llqwq.gitee.io/2020/07/05/spring-cloud/spring-cloud/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://llqwq.gitee.io" target="_blank">LLQWQ的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/java/">java</a><a class="post-meta__tags" href="/tags/%E6%A1%86%E6%9E%B6/">框架</a><a class="post-meta__tags" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a><a class="post-meta__tags" href="/tags/spring-cloud/">spring-cloud</a></div><div class="post_share"><div class="social-share" data-image="/img/spring-cloud-cover.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/07/23/Linux/Linux%E9%94%99%E8%AF%AF%E8%AE%B0%E5%BD%95/"><img class="prev-cover" data-lazy-src="/img/%E9%94%99%E8%AF%AF%E8%AE%B0%E5%BD%95.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Linux错误记录</div></div></a></div><div class="next-post pull-right"><a href="/2020/02/05/git/git%E5%91%BD%E4%BB%A4/"><img class="next-cover" data-lazy-src="/img/git-cover.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Git</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2020/01/05/spring-boot/spring-boot/" title="spring boot 学习笔记"><img class="cover" data-lazy-src="/img/Spring-Boot.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-01-05</div><div class="title">spring boot 学习笔记</div></div></a></div><div><a href="/2020/02/05/spring-boot/错误整理/" title="Spring-Boot 错误记录"><img class="cover" data-lazy-src="/img/%E9%94%99%E8%AF%AF%E8%AE%B0%E5%BD%95.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-02-05</div><div class="title">Spring-Boot 错误记录</div></div></a></div><div><a href="/2020/08/14/zookeeper/zookeeper/" title="zookeeper 学习笔记"><img class="cover" data-lazy-src="/img/zookeeper-cover.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-08-14</div><div class="title">zookeeper 学习笔记</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" data-lazy-src="/img/48668845.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">LLQWQ</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">13</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">21</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">28</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/LLQWQ"><i class="fab fa-github"></i><span>Github</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/LLQWQ" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="https://gitee.com/LLQWQ" target="_blank" title="Gitee"><i class="fas fa-envelope"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E9%A1%B9%E7%9B%AE%E6%90%AD%E5%BB%BA"><span class="toc-number">1.</span> <span class="toc-text">一、项目搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#project"><span class="toc-number">1.1.</span> <span class="toc-text">project</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84maven%E9%A1%B9%E7%9B%AE%EF%BC%88mavn-archetype-site%EF%BC%89"><span class="toc-number">1.1.1.</span> <span class="toc-text">创建一个简单的maven项目（mavn-archetype-site）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81"><span class="toc-number">1.1.2.</span> <span class="toc-text">设置字符编码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E8%A7%A3%E7%94%9F%E6%95%88%E6%BF%80%E6%B4%BB"><span class="toc-number">1.1.3.</span> <span class="toc-text">注解生效激活</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AEjava8"><span class="toc-number">1.1.4.</span> <span class="toc-text">设置java8</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#File-Type-%E8%BF%87%E6%BB%A4%E3%80%90%E5%8F%AF%E9%80%89%E3%80%91"><span class="toc-number">1.1.5.</span> <span class="toc-text">File Type 过滤【可选】</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E7%88%B6%E5%B7%A5%E7%A8%8Bpom"><span class="toc-number">1.2.</span> <span class="toc-text">搭建父工程pom</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pom%E6%96%87%E4%BB%B6"><span class="toc-number">1.2.1.</span> <span class="toc-text">pom文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%97%AD%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><span class="toc-number">1.2.2.</span> <span class="toc-text">关闭单元测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E6%98%AF%E5%90%A6%E6%90%AD%E5%BB%BA%E6%88%90%E5%8A%9F"><span class="toc-number">1.2.3.</span> <span class="toc-text">测试是否搭建成功</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Rest%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%B7%A5%E7%A8%8B%E6%9E%84%E5%BB%BA"><span class="toc-number">1.3.</span> <span class="toc-text">Rest微服务工程构建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%99%AE%E9%80%9A%E7%9A%84maven%E5%B7%A5%E7%A8%8B%E3%80%90cloud-provider-payment8001%E3%80%91"><span class="toc-number">1.3.1.</span> <span class="toc-text">创建一个普通的maven工程【cloud-provider-payment8001】</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0pom%E4%BE%9D%E8%B5%96"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">添加pom依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%99application-yml"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">写application.yml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E5%90%AF%E5%8A%A8%E7%B1%BB"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">主启动类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E7%B1%BB"><span class="toc-number">1.3.1.4.</span> <span class="toc-text">业务类</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BB%BA%E8%A1%A8sql"><span class="toc-number">1.3.1.4.1.</span> <span class="toc-text">建表sql</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%83%AD%E9%83%A8%E7%BD%B2-Devtools"><span class="toc-number">1.3.2.</span> <span class="toc-text">热部署 Devtools</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0devtools-jar%E5%8C%85"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">添加devtools jar包</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%8F%92%E4%BB%B6%E5%88%B0%E7%88%B6%E5%B7%A5%E7%A8%8B"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">添加插件到父工程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%90%AF%E8%87%AA%E5%8A%A8%E7%BC%96%E8%AF%91%E9%80%89%E9%A1%B9"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">开启自动编译选项</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%8D%E5%90%AFidea"><span class="toc-number">1.3.2.4.</span> <span class="toc-text">重启idea</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%B6%88%E8%B4%B9%E8%80%85%E3%80%90cloud-customer-order80%E3%80%91"><span class="toc-number">1.3.3.</span> <span class="toc-text">创建消费者【cloud-customer-order80】</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E9%87%8D%E6%9E%84"><span class="toc-number">1.3.4.</span> <span class="toc-text">项目重构</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81eureka%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%8F%91%E7%8E%B0"><span class="toc-number">2.</span> <span class="toc-text">二、eureka服务注册与发现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%95%E6%9C%BAeureka%E6%9E%84%E5%BB%BA%E6%AD%A5%E9%AA%A4"><span class="toc-number">2.1.</span> <span class="toc-text">单机eureka构建步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#eurekaServer%E7%AB%AF"><span class="toc-number">2.1.1.</span> <span class="toc-text">eurekaServer端</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BB%BAmaven%E5%B7%A5%E7%A8%8B"><span class="toc-number">2.1.1.0.1.</span> <span class="toc-text">建maven工程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9pom%E6%96%87%E4%BB%B6"><span class="toc-number">2.1.1.0.2.</span> <span class="toc-text">修改pom文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%99yml"><span class="toc-number">2.1.1.0.3.</span> <span class="toc-text">写yml</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%BB%E5%90%AF%E5%8A%A8%E7%B1%BB-1"><span class="toc-number">2.1.1.0.4.</span> <span class="toc-text">主启动类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">2.1.1.0.5.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%86cloud-provider-payment8001%E6%B3%A8%E5%86%8C%E8%BF%9Beureka%E4%B8%AD"><span class="toc-number">2.2.</span> <span class="toc-text">将cloud-provider-payment8001注册进eureka中</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0eureka-client%E4%BE%9D%E8%B5%96"><span class="toc-number">2.2.1.</span> <span class="toc-text">添加eureka-client依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9yml"><span class="toc-number">2.2.2.</span> <span class="toc-text">修改yml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E4%B8%BB%E5%85%A5%E5%8F%A3%E7%B1%BB"><span class="toc-number">2.2.3.</span> <span class="toc-text">修改主入口类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-1"><span class="toc-number">2.2.4.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%86cloud-customer-order80%E4%B9%9F%E6%B3%A8%E5%86%8C%E5%88%B0eureka%E4%B8%AD"><span class="toc-number">2.3.</span> <span class="toc-text">将cloud-customer-order80也注册到eureka中</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4Eureka%E6%90%AD%E5%BB%BA%E6%AD%A5%E9%AA%A4"><span class="toc-number">2.4.</span> <span class="toc-text">集群Eureka搭建步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#eureka%E9%9B%86%E7%BE%A4%E5%8E%9F%E7%90%86%E8%AF%B4%E6%98%8E"><span class="toc-number">2.4.1.</span> <span class="toc-text">eureka集群原理说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%8D%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AAeureka-server%E9%A1%B9%E7%9B%AE"><span class="toc-number">2.4.2.</span> <span class="toc-text">再构建一个eureka-server项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9hosts%E6%96%87%E4%BB%B6"><span class="toc-number">2.4.3.</span> <span class="toc-text">修改hosts文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9yml-1"><span class="toc-number">2.4.3.1.</span> <span class="toc-text">修改yml</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-2"><span class="toc-number">2.4.4.</span> <span class="toc-text">测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E8%AE%A2%E5%8D%9580%E5%92%8C%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%858001%E6%B3%A8%E5%86%8C%E5%88%B0eureka%E4%B8%AD"><span class="toc-number">2.4.5.</span> <span class="toc-text">将订单80和订单服务提供者8001注册到eureka中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-3"><span class="toc-number">2.4.6.</span> <span class="toc-text">测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%858001%E7%9A%84%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE"><span class="toc-number">2.4.7.</span> <span class="toc-text">订单服务提供者8001的集群配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B0%E5%BB%BA8002"><span class="toc-number">2.4.7.1.</span> <span class="toc-text">新建8002</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9yml-2"><span class="toc-number">2.4.7.2.</span> <span class="toc-text">修改yml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-4"><span class="toc-number">2.4.7.3.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E4%B8%8B%E5%8D%95%E6%9C%8D%E5%8A%A180%E5%8E%BB%E8%AE%BF%E9%97%AE%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1%E9%9B%86%E7%BE%A4"><span class="toc-number">2.4.8.</span> <span class="toc-text">使用下单服务80去访问订单服务集群</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#actuator%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%A1%E6%81%AF%E5%AE%8C%E5%96%84"><span class="toc-number">2.5.</span> <span class="toc-text">actuator微服务信息完善</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%90%8D%E7%A7%B0%E4%BF%AE%E6%94%B9"><span class="toc-number">2.5.1.</span> <span class="toc-text">微服务名称修改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ip%E6%98%BE%E7%A4%BA"><span class="toc-number">2.5.2.</span> <span class="toc-text">ip显示</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0Disovery"><span class="toc-number">2.6.</span> <span class="toc-text">服务发现Disovery</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Eureka%E8%87%AA%E6%88%91%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86"><span class="toc-number">2.7.</span> <span class="toc-text">Eureka自我保护机制原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E7%8E%B0%E8%B1%A1"><span class="toc-number">2.7.1.</span> <span class="toc-text">故障现象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E8%87%B4%E5%8E%9F%E5%9B%A0"><span class="toc-number">2.7.2.</span> <span class="toc-text">导致原因</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%8E%E4%B9%88%E7%A6%81%E6%AD%A2%E8%87%AA%E6%88%91%E4%BF%9D%E6%8A%A4"><span class="toc-number">2.7.3.</span> <span class="toc-text">怎么禁止自我保护</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81zookeeper%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%8F%91%E7%8E%B0"><span class="toc-number">3.</span> <span class="toc-text">三、zookeeper服务注册与发现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8zookeeper%E4%BB%A3%E6%9B%BFeureka"><span class="toc-number">3.1.</span> <span class="toc-text">使用zookeeper代替eureka</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85%E6%B3%A8%E5%86%8C%E8%BF%9Bzookeeper"><span class="toc-number">3.1.1.</span> <span class="toc-text">将订单服务提供者注册进zookeeper</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8zookeeper"><span class="toc-number">3.1.1.1.</span> <span class="toc-text">启动zookeeper</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B0%E5%BB%BAcloud-provider-payment8004"><span class="toc-number">3.1.1.2.</span> <span class="toc-text">新建cloud-provider-payment8004</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9pom%E6%96%87%E4%BB%B6-%E5%8A%A0%E5%85%A5zookeeper%E7%9A%84jar%E5%8C%85"><span class="toc-number">3.1.1.3.</span> <span class="toc-text">修改pom文件, 加入zookeeper的jar包</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#yml"><span class="toc-number">3.1.1.4.</span> <span class="toc-text">yml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-5"><span class="toc-number">3.1.1.5.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E6%9C%8D%E5%8A%A1%E6%B6%88%E8%B4%B9%E8%80%85%E6%B3%A8%E5%86%8C%E5%88%B0zookeeper%E4%B8%AD"><span class="toc-number">3.1.2.</span> <span class="toc-text">将服务消费者注册到zookeeper中</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAcloud-customer-zk-order80"><span class="toc-number">3.1.2.1.</span> <span class="toc-text">创建cloud-customer-zk-order80</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81consul%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%8F%91%E7%8E%B0"><span class="toc-number">4.</span> <span class="toc-text">四、consul服务注册与发现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">4.1.</span> <span class="toc-text">简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%98%E7%BD%91"><span class="toc-number">4.1.1.</span> <span class="toc-text">官网</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">4.1.2.</span> <span class="toc-text">是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%83%BD%E5%B9%B2%E5%98%9B"><span class="toc-number">4.1.3.</span> <span class="toc-text">能干嘛</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%BB%E5%93%AA%E4%B8%8B"><span class="toc-number">4.1.4.</span> <span class="toc-text">去哪下</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%B9%B6%E8%BF%90%E8%A1%8Cconsul"><span class="toc-number">4.2.</span> <span class="toc-text">安装并运行consul</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85"><span class="toc-number">4.3.</span> <span class="toc-text">服务提供者</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E5%BB%BAcloud-provider-payment8006"><span class="toc-number">4.3.1.</span> <span class="toc-text">新建cloud-provider-payment8006</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pom"><span class="toc-number">4.3.2.</span> <span class="toc-text">pom</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#yml-1"><span class="toc-number">4.3.3.</span> <span class="toc-text">yml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-6"><span class="toc-number">4.3.4.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-number">4.4.</span> <span class="toc-text">服务消费者</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pom-1"><span class="toc-number">4.4.1.</span> <span class="toc-text">pom</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#yaml"><span class="toc-number">4.4.2.</span> <span class="toc-text">yaml</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E4%B8%AA%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E7%9A%84%E5%BC%82%E5%90%8C%E7%82%B9"><span class="toc-number">4.5.</span> <span class="toc-text">三个注册中心的异同点</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8"><span class="toc-number">5.</span> <span class="toc-text">五、Ribbon负载均衡服务调用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">5.1.</span> <span class="toc-text">概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%AF%E4%BB%80%E4%B9%88-1"><span class="toc-number">5.1.1.</span> <span class="toc-text">是什么</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6IRule"><span class="toc-number">5.2.</span> <span class="toc-text">核心组件IRule</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%9B%BF%E6%8D%A2"><span class="toc-number">5.3.</span> <span class="toc-text">如何替换</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9order80"><span class="toc-number">5.3.1.</span> <span class="toc-text">修改order80</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95"><span class="toc-number">5.4.</span> <span class="toc-text">Ribbon负载均衡算法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">5.4.1.</span> <span class="toc-text">原理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD%E3%80%81OpenFeign%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3%E8%B0%83%E7%94%A8"><span class="toc-number">6.</span> <span class="toc-text">六、OpenFeign服务接口调用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-1"><span class="toc-number">6.1.</span> <span class="toc-text">概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%AF%E4%BB%80%E4%B9%88-2"><span class="toc-number">6.1.1.</span> <span class="toc-text">是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%83%BD%E5%B9%B2%E5%98%9B-1"><span class="toc-number">6.1.2.</span> <span class="toc-text">能干嘛</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OpenFegin%E5%92%8CFegin%E4%B8%A4%E8%80%85%E4%B9%8B%E9%97%B4%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">6.1.3.</span> <span class="toc-text">OpenFegin和Fegin两者之间的区别</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OpenFeign%E4%BD%BF%E7%94%A8%E6%AD%A5%E9%AA%A4"><span class="toc-number">6.2.</span> <span class="toc-text">OpenFeign使用步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E5%BB%BAcloud-customer-openfeign-order80"><span class="toc-number">6.2.1.</span> <span class="toc-text">新建cloud-customer-openfeign-order80</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#pom-2"><span class="toc-number">6.2.1.1.</span> <span class="toc-text">pom</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#yml-2"><span class="toc-number">6.2.1.2.</span> <span class="toc-text">yml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%B8%AAservice"><span class="toc-number">6.2.1.3.</span> <span class="toc-text">添加一个service</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9controller"><span class="toc-number">6.2.1.4.</span> <span class="toc-text">修改controller</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E4%B8%BB%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-number">6.2.1.5.</span> <span class="toc-text">修改主配置类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-7"><span class="toc-number">6.2.1.6.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OpenFeign%E8%B6%85%E6%97%B6%E6%8E%A7%E5%88%B6"><span class="toc-number">6.3.</span> <span class="toc-text">OpenFeign超时控制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%8E%E4%B9%88%E8%A7%A3%E5%86%B3"><span class="toc-number">6.3.1.</span> <span class="toc-text">怎么解决</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OpenFeign%E6%97%A5%E5%BF%97%E6%89%93%E5%8D%B0%E5%8A%9F%E8%83%BD"><span class="toc-number">6.4.</span> <span class="toc-text">OpenFeign日志打印功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E7%BA%A7%E5%88%AB"><span class="toc-number">6.4.1.</span> <span class="toc-text">日志级别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%90%AF%E6%AD%A5%E9%AA%A4"><span class="toc-number">6.4.2.</span> <span class="toc-text">开启步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%91%E5%AE%B9%E5%99%A8%E4%B8%AD%E6%B3%A8%E5%85%A5Logger-Level"><span class="toc-number">6.4.3.</span> <span class="toc-text">向容器中注入Logger.Level</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9yml-3"><span class="toc-number">6.4.4.</span> <span class="toc-text">修改yml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E6%9E%9C"><span class="toc-number">6.4.5.</span> <span class="toc-text">结果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%83%E3%80%81Hystrix"><span class="toc-number">7.</span> <span class="toc-text">七、Hystrix</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-2"><span class="toc-number">7.1.</span> <span class="toc-text">概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E9%9D%A2%E4%B8%B4%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">7.1.1.</span> <span class="toc-text">分布式系统面临的问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%AF%E4%BB%80%E4%B9%88-3"><span class="toc-number">7.1.2.</span> <span class="toc-text">是什么</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#star2-Hystrix%E9%87%8D%E8%A6%81%E6%A6%82%E5%BF%B5"><span class="toc-number">7.2.</span> <span class="toc-text">:star2:Hystrix重要概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7"><span class="toc-number">7.2.1.</span> <span class="toc-text">服务降级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD"><span class="toc-number">7.2.2.</span> <span class="toc-text">服务熔断</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E9%99%90%E6%B5%81"><span class="toc-number">7.2.3.</span> <span class="toc-text">服务限流</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#star2-Hystrix%E6%A1%88%E4%BE%8B"><span class="toc-number">7.3.</span> <span class="toc-text">:star2:Hystrix案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA"><span class="toc-number">7.3.1.</span> <span class="toc-text">构建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAcloud-provider-hystrix-payment8001"><span class="toc-number">7.3.1.1.</span> <span class="toc-text">创建cloud-provider-hystrix-payment8001</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pom-3"><span class="toc-number">7.3.1.2.</span> <span class="toc-text">pom</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#yml-3"><span class="toc-number">7.3.1.3.</span> <span class="toc-text">yml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-8"><span class="toc-number">7.3.1.4.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AB%98%E5%B9%B6%E5%8F%91%E6%B5%8B%E8%AF%95"><span class="toc-number">7.3.2.</span> <span class="toc-text">高并发测试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#jmeter%E5%8E%8B%E6%B5%8B%E6%B5%8B%E8%AF%95"><span class="toc-number">7.3.2.1.</span> <span class="toc-text">jmeter压测测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9C%8B%E7%83%AD%E9%97%B9%E4%B8%8D%E5%AB%8C%E4%BA%8B%E5%A4%A7%EF%BC%8C%E5%8A%A0%E5%85%A580"><span class="toc-number">7.3.2.2.</span> <span class="toc-text">看热闹不嫌事大，加入80</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B0%E5%BB%BA%E4%B8%80%E4%B8%AAcloud-consumer-feign-hystrix-order80"><span class="toc-number">7.3.2.2.1.</span> <span class="toc-text">新建一个cloud-consumer-feign-hystrix-order80</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#pom-4"><span class="toc-number">7.3.2.2.2.</span> <span class="toc-text">pom</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#yml-4"><span class="toc-number">7.3.2.2.3.</span> <span class="toc-text">yml</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E7%8E%B0%E8%B1%A1%E5%92%8C%E5%AF%BC%E8%87%B4%E5%8E%9F%E5%9B%A0"><span class="toc-number">7.3.3.</span> <span class="toc-text">故障现象和导致原因</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8A%E8%BF%B0%E7%BB%93%E8%AE%BA"><span class="toc-number">7.3.4.</span> <span class="toc-text">上述结论</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%EF%BC%9F%E8%A7%A3%E5%86%B3%E7%9A%84%E8%A6%81%E6%B1%82"><span class="toc-number">7.3.5.</span> <span class="toc-text">如何解决？解决的要求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#star-%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7"><span class="toc-number">7.3.6.</span> <span class="toc-text">:star:服务降级</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%99%8D%E7%BA%A7%E9%85%8D%E7%BD%AE"><span class="toc-number">7.3.6.1.</span> <span class="toc-text">降级配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8001%E8%87%AA%E8%BA%AB"><span class="toc-number">7.3.6.2.</span> <span class="toc-text">8001自身</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8001fallback"><span class="toc-number">7.3.6.3.</span> <span class="toc-text">8001fallback</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#80fallbake"><span class="toc-number">7.3.6.4.</span> <span class="toc-text">80fallbake</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%A2%98%E5%A4%96%E8%AF%9D"><span class="toc-number">7.3.6.4.1.</span> <span class="toc-text">题外话</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E7%B1%BB-1"><span class="toc-number">7.3.6.4.2.</span> <span class="toc-text">业务类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%BB%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-number">7.3.6.4.3.</span> <span class="toc-text">主配置类</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%AE%E5%89%8D%E9%97%AE%E9%A2%98"><span class="toc-number">7.3.6.5.</span> <span class="toc-text">目前问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E9%97%AE%E9%A2%98"><span class="toc-number">7.3.6.6.</span> <span class="toc-text">解决问题</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AF%8F%E4%B8%AA%E6%96%B9%E6%B3%95%E9%85%8D%E7%BD%AE%E4%B8%80%E4%B8%AA%EF%BC%9F%EF%BC%9F%EF%BC%9F%E8%86%A8%E8%83%80"><span class="toc-number">7.3.6.6.1.</span> <span class="toc-text">每个方法配置一个？？？膨胀</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%92%8C%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E6%B7%B7%E4%B8%80%E8%B5%B7%EF%BC%9F%EF%BC%9F%EF%BC%9F%E6%B7%B7%E4%B9%B1"><span class="toc-number">7.3.6.6.2.</span> <span class="toc-text">和业务逻辑混一起？？？混乱</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">7.3.6.7.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%98%E7%BD%91%E6%96%AD%E8%B7%AF%E5%99%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">7.3.6.8.</span> <span class="toc-text">官网断路器流程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%AD%E8%B7%AF%E5%99%A8%E5%9C%A8%E4%BB%80%E4%B9%88%E7%8A%B6%E6%80%81%E4%B8%8B%E8%B5%B7%E4%BD%9C%E7%94%A8"><span class="toc-number">7.3.6.8.1.</span> <span class="toc-text">断路器在什么状态下起作用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%AD%E8%B7%AF%E5%99%A8%E5%BC%80%E5%90%AF%E6%88%96%E5%85%B3%E9%97%AD%E7%9A%84%E6%9D%A1%E4%BB%B6"><span class="toc-number">7.3.6.8.2.</span> <span class="toc-text">断路器开启或关闭的条件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%AD%E8%B7%AF%E5%99%A8%E6%89%93%E5%BC%80%E4%B9%8B%E5%90%8E"><span class="toc-number">7.3.6.8.3.</span> <span class="toc-text">断路器打开之后</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7-hystrixDashboard"><span class="toc-number">7.3.7.</span> <span class="toc-text">服务监控 hystrixDashboard</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-3"><span class="toc-number">7.3.7.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%AA%E8%A1%A8%E7%9B%989001"><span class="toc-number">7.3.7.2.</span> <span class="toc-text">仪表盘9001</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E7%9C%8B"><span class="toc-number">7.3.7.2.1.</span> <span class="toc-text">如何看</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%80%E5%9C%88"><span class="toc-number">7.3.7.2.1.1.</span> <span class="toc-text">一圈</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%80%E7%BA%BF"><span class="toc-number">7.3.7.2.1.2.</span> <span class="toc-text">一线</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%95%B4%E5%9B%BE%E8%AF%B4%E6%98%8E"><span class="toc-number">7.3.7.2.1.3.</span> <span class="toc-text">整图说明</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#star-%E6%9C%8D%E5%8A%A1%E9%99%90%E6%B5%81"><span class="toc-number">7.3.8.</span> <span class="toc-text">:star:服务限流</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AB%E3%80%81GateWay%E6%96%B0%E4%B8%80%E4%BB%A3%E7%BD%91%E5%85%B3"><span class="toc-number">8.</span> <span class="toc-text">八、GateWay新一代网关</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0%E7%AE%80%E4%BB%8B"><span class="toc-number">8.1.</span> <span class="toc-text">概述简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%AF%E4%BB%80%E4%B9%88-4"><span class="toc-number">8.1.1.</span> <span class="toc-text">是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%83%BD%E5%B9%B2%E5%98%9B-2"><span class="toc-number">8.1.2.</span> <span class="toc-text">能干嘛</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E4%B8%AD%E7%BD%91%E5%85%B3%E5%9C%A8%E5%93%AA%E9%87%8C"><span class="toc-number">8.1.3.</span> <span class="toc-text">微服务架构中网关在哪里</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E5%A4%A7%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-number">8.2.</span> <span class="toc-text">三大核心概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Route-%E8%B7%AF%E7%94%B1"><span class="toc-number">8.2.1.</span> <span class="toc-text">Route(路由)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Predicate-%E6%96%AD%E8%A8%80"><span class="toc-number">8.2.2.</span> <span class="toc-text">Predicate(断言)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Filter-%E8%BF%87%E6%BB%A4"><span class="toc-number">8.2.3.</span> <span class="toc-text">Filter(过滤)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E4%BD%93"><span class="toc-number">8.2.4.</span> <span class="toc-text">总体</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Gateway%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">8.3.</span> <span class="toc-text">Gateway工作流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A5%E9%97%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">8.4.</span> <span class="toc-text">入门配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E5%BB%BA-Module"><span class="toc-number">8.4.1.</span> <span class="toc-text">新建 Module</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#POM"><span class="toc-number">8.4.1.1.</span> <span class="toc-text">POM</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#YML"><span class="toc-number">8.4.1.2.</span> <span class="toc-text">YML</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E7%B1%BB-2"><span class="toc-number">8.4.1.3.</span> <span class="toc-text">业务类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E5%90%AF%E5%8A%A8%E7%B1%BB-2"><span class="toc-number">8.4.1.4.</span> <span class="toc-text">主启动类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9527%E7%BD%91%E5%85%B3%E5%A6%82%E4%BD%95%E5%81%9A%E8%B7%AF%E7%94%B1%E6%98%A0%E5%B0%84%E9%82%A3"><span class="toc-number">8.4.1.5.</span> <span class="toc-text">9527网关如何做路由映射那??</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#YML%E6%96%B0%E5%A2%9E%E7%BD%91%E5%85%B3%E9%85%8D%E7%BD%AE"><span class="toc-number">8.4.1.6.</span> <span class="toc-text">YML新增网关配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-9"><span class="toc-number">8.4.1.7.</span> <span class="toc-text">测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#YML%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E"><span class="toc-number">8.4.1.8.</span> <span class="toc-text">YML配置说明</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Predicate%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">8.5.</span> <span class="toc-text">Predicate的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AfterRoutePredicateFactory"><span class="toc-number">8.5.1.</span> <span class="toc-text">AfterRoutePredicateFactory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CookieRoutePredicateFactory"><span class="toc-number">8.5.2.</span> <span class="toc-text">CookieRoutePredicateFactory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HeaderRoutePredicateFactory"><span class="toc-number">8.5.3.</span> <span class="toc-text">HeaderRoutePredicateFactory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HostRoutePredicateFactory"><span class="toc-number">8.5.4.</span> <span class="toc-text">HostRoutePredicateFactory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MethodRoutePredicateFactory"><span class="toc-number">8.5.5.</span> <span class="toc-text">MethodRoutePredicateFactory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PathRoutePredicateFactory"><span class="toc-number">8.5.6.</span> <span class="toc-text">PathRoutePredicateFactory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#QueryRoutePredicateFactory"><span class="toc-number">8.5.7.</span> <span class="toc-text">QueryRoutePredicateFactory</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Filter%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">8.6.</span> <span class="toc-text">Filter的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%AF%E4%BB%80%E4%B9%88-5"><span class="toc-number">8.6.1.</span> <span class="toc-text">是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#spring-cloud-gateway-%E7%9A%84-filter"><span class="toc-number">8.6.2.</span> <span class="toc-text">spring cloud gateway 的 filter</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">8.6.2.1.</span> <span class="toc-text">生命周期</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A7%8D%E7%B1%BB"><span class="toc-number">8.6.2.2.</span> <span class="toc-text">种类</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%A6%82%E8%BF%B0"><span class="toc-number">8.7.</span> <span class="toc-text">1. 概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%88%86%E7%B1%BB"><span class="toc-number">8.8.</span> <span class="toc-text">2. 分类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E6%A0%B9%E6%8D%AE%E7%94%A8%E9%80%94%E5%88%92%E5%88%86"><span class="toc-number">8.8.1.</span> <span class="toc-text">2.1 根据用途划分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E6%A0%B9%E6%8D%AE%E4%BD%9C%E7%94%A8%E5%9F%9F%E5%88%92%E5%88%86"><span class="toc-number">8.8.2.</span> <span class="toc-text">2.2 根据作用域划分</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B9%9D%E3%80%81Spring-Cloud-Config%E5%88%86%E5%B8%83%E5%BC%8F%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="toc-number">9.</span> <span class="toc-text">九、Spring Cloud Config分布式配置中心</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#star-%E6%A6%82%E8%BF%B0"><span class="toc-number">9.1.</span> <span class="toc-text">:star:概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E9%9D%A2%E4%B8%B4%E7%9A%84%E2%80%94%E9%85%8D%E7%BD%AE%E9%97%AE%E9%A2%98"><span class="toc-number">9.1.1.</span> <span class="toc-text">分布式系统面临的—配置问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%AF%E4%BB%80%E4%B9%88-6"><span class="toc-number">9.1.2.</span> <span class="toc-text">是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%83%BD%E5%B9%B2%E5%98%9B-3"><span class="toc-number">9.1.3.</span> <span class="toc-text">能干嘛</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%98%E7%BD%91-1"><span class="toc-number">9.1.4.</span> <span class="toc-text">官网</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#star-Config%E6%9C%8D%E5%8A%A1%E7%AB%AF%E9%85%8D%E7%BD%AE%E4%B8%8E%E6%B5%8B%E8%AF%95"><span class="toc-number">9.2.</span> <span class="toc-text">:star:Config服务端配置与测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAcloud-config-center3344"><span class="toc-number">9.2.1.</span> <span class="toc-text">创建cloud-config-center3344</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pom-5"><span class="toc-number">9.2.2.</span> <span class="toc-text">pom</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#yml-5"><span class="toc-number">9.2.3.</span> <span class="toc-text">yml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E9%85%8D%E7%BD%AE%E7%B1%BB-1"><span class="toc-number">9.2.4.</span> <span class="toc-text">主配置类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-10"><span class="toc-number">9.2.5.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#star-Config%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%85%8D%E7%BD%AE%E4%B8%8E%E6%B5%8B%E8%AF%95"><span class="toc-number">9.3.</span> <span class="toc-text">:star:Config客户端配置与测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E5%BB%BAcloud-config-client3355"><span class="toc-number">9.3.1.</span> <span class="toc-text">新建cloud-config-client3355</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pom-6"><span class="toc-number">9.3.2.</span> <span class="toc-text">pom</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bootstrap-yml"><span class="toc-number">9.3.3.</span> <span class="toc-text">bootstrap.yml</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%98%AF%E4%BB%80%E4%B9%88-7"><span class="toc-number">9.3.3.1.</span> <span class="toc-text">是什么</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AE%B9"><span class="toc-number">9.3.3.2.</span> <span class="toc-text">内容</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Controler"><span class="toc-number">9.3.4.</span> <span class="toc-text">Controler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E9%85%8D%E7%BD%AE%E7%B1%BB-2"><span class="toc-number">9.3.5.</span> <span class="toc-text">主配置类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-11"><span class="toc-number">9.3.6.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#star-Config%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%B9%8B%E5%8A%A8%E6%80%81%E5%88%B7%E6%96%B0"><span class="toc-number">9.4.</span> <span class="toc-text">:star:Config客户端之动态刷新</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9Controller"><span class="toc-number">9.4.1.</span> <span class="toc-text">修改Controller</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9yml-4"><span class="toc-number">9.4.2.</span> <span class="toc-text">修改yml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-12"><span class="toc-number">9.4.3.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E3%80%81Spring-Cloud-Bus-%E6%B6%88%E6%81%AF%E6%80%BB%E7%BA%BF"><span class="toc-number">10.</span> <span class="toc-text">十、Spring Cloud Bus 消息总线</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-4"><span class="toc-number">10.1.</span> <span class="toc-text">概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%AF%E4%BB%80%E4%B9%88-8"><span class="toc-number">10.1.1.</span> <span class="toc-text">是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%83%BD%E5%B9%B2%E5%98%9B-4"><span class="toc-number">10.1.2.</span> <span class="toc-text">能干嘛</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BD%95%E8%A2%AB%E7%A7%B0%E4%B8%BA%E6%80%BB%E7%BA%BF"><span class="toc-number">10.1.3.</span> <span class="toc-text">为何被称为总线</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RabbitMQ%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">10.2.</span> <span class="toc-text">RabbitMQ环境配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringCloud-Bus%E5%8A%A8%E6%80%81%E5%88%B7%E6%96%B0%E5%85%A8%E5%B1%80%E5%B9%BF%E6%92%AD"><span class="toc-number">10.3.</span> <span class="toc-text">SpringCloud Bus动态刷新全局广播</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3"><span class="toc-number">10.3.1.</span> <span class="toc-text">设计思想</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%94%E7%A4%BA%E5%B9%BF%E6%92%AD%E6%95%88%E6%9E%9C%EF%BC%8C%E5%A2%9E%E5%8A%A0%E5%A4%8D%E6%9D%82%E5%BA%A6%EF%BC%8C%E5%86%8D%E4%BB%A53355%E4%B8%BA%E6%A8%A1%E6%9D%BF%E5%86%8D%E5%88%B6%E4%BD%9C%E4%B8%80%E4%B8%AA3366"><span class="toc-number">10.3.2.</span> <span class="toc-text">演示广播效果，增加复杂度，再以3355为模板再制作一个3366</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%99cloud-config-center-3344%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B7%BB%E5%8A%A0%E6%B6%88%E6%81%AF%E6%80%BB%E7%BA%BF%E6%94%AF%E6%8C%81"><span class="toc-number">10.3.3.</span> <span class="toc-text">给cloud-config-center-3344配置中心服务端添加消息总线支持</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%99cloud-config-client-3355%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%B7%BB%E5%8A%A0%E6%B6%88%E6%81%AF%E6%80%BB%E7%BA%BF%E6%94%AF%E6%8C%81"><span class="toc-number">10.3.4.</span> <span class="toc-text">给cloud-config-client-3355客户端添加消息总线支持</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-13"><span class="toc-number">10.3.5.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringCloud-Bus%E5%8A%A8%E6%80%81%E5%88%B7%E6%96%B0%E5%AE%9A%E7%82%B9%E9%80%9A%E7%9F%A5"><span class="toc-number">10.4.</span> <span class="toc-text">SpringCloud Bus动态刷新定点通知</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E4%B8%80%E3%80%81Spring-Cloud-Stream-%E6%B6%88%E6%81%AF%E9%A9%B1%E5%8A%A8"><span class="toc-number">11.</span> <span class="toc-text">十一、Spring Cloud Stream 消息驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%AD%E6%96%87%E6%8C%87%E5%AF%BC%E6%89%8B%E5%86%8C"><span class="toc-number">11.1.</span> <span class="toc-text">中文指导手册</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-5"><span class="toc-number">11.2.</span> <span class="toc-text">概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E7%A0%81api%E7%9A%84%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3"><span class="toc-number">11.2.1.</span> <span class="toc-text">编码api的常用注解</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E8%AF%B4%E6%98%8E"><span class="toc-number">11.3.</span> <span class="toc-text">案例说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85"><span class="toc-number">11.4.</span> <span class="toc-text">生产者</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAcloud-stream-rabbitmq-provider8801"><span class="toc-number">11.4.1.</span> <span class="toc-text">创建cloud-stream-rabbitmq-provider8801</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pom-7"><span class="toc-number">11.4.2.</span> <span class="toc-text">pom</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#yml-6"><span class="toc-number">11.4.3.</span> <span class="toc-text">yml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E9%85%8D%E7%BD%AE%E7%B1%BB-3"><span class="toc-number">11.4.4.</span> <span class="toc-text">主配置类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E5%B1%82"><span class="toc-number">11.4.5.</span> <span class="toc-text">业务层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#controller"><span class="toc-number">11.4.6.</span> <span class="toc-text">controller</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-14"><span class="toc-number">11.4.7.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-number">11.5.</span> <span class="toc-text">消费者</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAcloud-stream-rabbitmq-consumer8802"><span class="toc-number">11.5.1.</span> <span class="toc-text">创建cloud-stream-rabbitmq-consumer8802</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pom-8"><span class="toc-number">11.5.2.</span> <span class="toc-text">pom</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#yml-7"><span class="toc-number">11.5.3.</span> <span class="toc-text">yml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#controller-1"><span class="toc-number">11.5.4.</span> <span class="toc-text">controller</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E5%90%AF%E5%8A%A8%E7%B1%BB-3"><span class="toc-number">11.5.5.</span> <span class="toc-text">主启动类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-15"><span class="toc-number">11.5.6.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E7%BB%84%E6%B6%88%E8%B4%B9%E4%B8%8E%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">11.6.</span> <span class="toc-text">分组消费与持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%BB%84"><span class="toc-number">11.6.1.</span> <span class="toc-text">分组</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAcloud-stream-rabbitmq-consumer8803"><span class="toc-number">11.6.1.1.</span> <span class="toc-text">创建cloud-stream-rabbitmq-consumer8803</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9yml-5"><span class="toc-number">11.6.1.2.</span> <span class="toc-text">修改yml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-16"><span class="toc-number">11.6.1.3.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">11.6.2.</span> <span class="toc-text">持久化</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E4%BA%8C%E3%80%81Spring-Cloud-Sleuth-%E5%88%86%E5%B8%83%E5%BC%8F%E8%AF%B7%E6%B1%82%E9%93%BE%E8%B7%AF%E8%B7%9F%E8%B8%AA"><span class="toc-number">12.</span> <span class="toc-text">十二、Spring Cloud Sleuth 分布式请求链路跟踪</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-6"><span class="toc-number">12.1.</span> <span class="toc-text">概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E5%87%BA%E7%8E%B0%E8%BF%99%E6%A0%B7%E7%9A%84%E6%8A%80%E6%9C%AF%EF%BC%9F%E9%9C%80%E8%A6%81%E8%A7%A3%E5%86%B3%E9%82%A3%E4%BA%9B%E9%97%AE%E9%A2%98%EF%BC%9F"><span class="toc-number">12.1.1.</span> <span class="toc-text">为什么会出现这样的技术？需要解决那些问题？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%AF%E4%BB%80%E4%B9%88-9"><span class="toc-number">12.1.2.</span> <span class="toc-text">是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3"><span class="toc-number">12.1.3.</span> <span class="toc-text">解决</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E9%93%BE%E8%B7%AF%E7%9B%91%E6%8E%A7%E6%AD%A5%E9%AA%A4"><span class="toc-number">12.2.</span> <span class="toc-text">搭建链路监控步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#zipkin"><span class="toc-number">12.2.1.</span> <span class="toc-text">zipkin</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD"><span class="toc-number">12.2.1.1.</span> <span class="toc-text">下载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%90%E8%A1%8Cjar"><span class="toc-number">12.2.1.2.</span> <span class="toc-text">运行jar</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E6%8E%A7%E5%88%B6%E5%8F%B0"><span class="toc-number">12.2.1.3.</span> <span class="toc-text">运行控制台</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E7%9A%84%E8%B0%83%E7%94%A8%E9%93%BE%E8%B7%AF"><span class="toc-number">12.2.1.4.</span> <span class="toc-text">完整的调用链路</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8D%E7%A7%B0%E8%A7%A3%E9%87%8A"><span class="toc-number">12.2.1.5.</span> <span class="toc-text">名称解释</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85%E5%92%8C%E8%B0%83%E7%94%A8%E8%80%85"><span class="toc-number">12.2.2.</span> <span class="toc-text">服务提供者和调用者</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#pom-9"><span class="toc-number">12.2.2.1.</span> <span class="toc-text">pom</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#yml-8"><span class="toc-number">12.2.2.2.</span> <span class="toc-text">yml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-17"><span class="toc-number">12.2.2.3.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E4%B8%89%E3%80%81Spring-Cloud-Alibaba-%E5%85%A5%E9%97%A8%E7%AE%80%E4%BB%8B"><span class="toc-number">13.</span> <span class="toc-text">十三、Spring Cloud Alibaba 入门简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#star2-%E5%8D%81%E5%9B%9B%E3%80%81SpringCloud-Alibaba-Nacos%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="toc-number">14.</span> <span class="toc-text">:star2:十四、SpringCloud Alibaba Nacos服务注册和配置中心</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Nacos%E7%AE%80%E4%BB%8B"><span class="toc-number">14.1.</span> <span class="toc-text">Nacos简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E5%8F%ABNacos"><span class="toc-number">14.1.1.</span> <span class="toc-text">为什么叫Nacos</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%AF%E4%BB%80%E4%B9%88-10"><span class="toc-number">14.1.2.</span> <span class="toc-text">是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%83%BD%E5%B9%B2%E5%98%9B-5"><span class="toc-number">14.1.3.</span> <span class="toc-text">能干嘛</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%BB%E5%93%AA%E4%B8%8B-1"><span class="toc-number">14.1.4.</span> <span class="toc-text">去哪下</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%84%E7%A7%8D%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%AF%94%E8%BE%83"><span class="toc-number">14.1.5.</span> <span class="toc-text">各种注册中心比较</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%B9%B6%E8%BF%90%E8%A1%8CNacos"><span class="toc-number">14.2.</span> <span class="toc-text">安装并运行Nacos</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nacos%E4%BD%9C%E4%B8%BA%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%BC%94%E7%A4%BA"><span class="toc-number">14.3.</span> <span class="toc-text">Nacos作为服务注册中心演示</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%98%E7%BD%91%E6%96%87%E6%A1%A3"><span class="toc-number">14.3.1.</span> <span class="toc-text">官网文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8ENacos%E7%9A%84%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85"><span class="toc-number">14.3.2.</span> <span class="toc-text">基于Nacos的服务提供者</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B0%E5%BB%BAModule"><span class="toc-number">14.3.2.1.</span> <span class="toc-text">新建Module</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#POM-1"><span class="toc-number">14.3.2.2.</span> <span class="toc-text">POM</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#YML-1"><span class="toc-number">14.3.2.3.</span> <span class="toc-text">YML</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E5%90%AF%E5%8A%A8"><span class="toc-number">14.3.2.4.</span> <span class="toc-text">主启动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E7%B1%BB-3"><span class="toc-number">14.3.2.5.</span> <span class="toc-text">业务类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-18"><span class="toc-number">14.3.2.6.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8ENacos%E7%9A%84%E6%9C%8D%E5%8A%A1%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-number">14.3.3.</span> <span class="toc-text">基于Nacos的服务消费者</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B0%E5%BB%BAModule-1"><span class="toc-number">14.3.3.1.</span> <span class="toc-text">新建Module</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#POM-2"><span class="toc-number">14.3.3.2.</span> <span class="toc-text">POM</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#yml-9"><span class="toc-number">14.3.3.3.</span> <span class="toc-text">yml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E5%90%AF%E5%8A%A8-1"><span class="toc-number">14.3.3.4.</span> <span class="toc-text">主启动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E7%B1%BB-4"><span class="toc-number">14.3.3.5.</span> <span class="toc-text">业务类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-number">14.3.3.6.</span> <span class="toc-text">配置类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-19"><span class="toc-number">14.3.3.7.</span> <span class="toc-text">测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88nacos%E6%94%AF%E6%8C%81%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">14.3.3.8.</span> <span class="toc-text">为什么nacos支持负载均衡</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%AF%B9%E6%AF%94"><span class="toc-number">14.3.4.</span> <span class="toc-text">服务注册中心对比</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Nacos%E5%92%8CCAP"><span class="toc-number">14.3.4.1.</span> <span class="toc-text">Nacos和CAP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Nacos%E6%94%AF%E6%8C%81AP%E5%92%8CCP%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%88%87%E6%8D%A2"><span class="toc-number">14.3.4.2.</span> <span class="toc-text">Nacos支持AP和CP模式的切换</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nacos%E4%BD%9C%E4%B8%BA%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E6%BC%94%E7%A4%BA"><span class="toc-number">14.4.</span> <span class="toc-text">Nacos作为服务配置中心演示</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Nacos%E4%BD%9C%E4%B8%BA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE"><span class="toc-number">14.4.1.</span> <span class="toc-text">Nacos作为配置中心-基础配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BB%BAmodel"><span class="toc-number">14.4.1.1.</span> <span class="toc-text">建model</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#POM-3"><span class="toc-number">14.4.1.2.</span> <span class="toc-text">POM</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#YML-2"><span class="toc-number">14.4.1.3.</span> <span class="toc-text">YML</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#bootstrap-yml-1"><span class="toc-number">14.4.1.3.1.</span> <span class="toc-text">bootstrap.yml</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#application-yml"><span class="toc-number">14.4.1.3.2.</span> <span class="toc-text">application.yml</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#why%E9%85%8D%E7%BD%AE%E4%B8%A4%E4%B8%AA"><span class="toc-number">14.4.1.3.3.</span> <span class="toc-text">why配置两个</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E5%90%AF%E5%8A%A8-2"><span class="toc-number">14.4.1.4.</span> <span class="toc-text">主启动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E7%B1%BB-5"><span class="toc-number">14.4.1.5.</span> <span class="toc-text">业务类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8Nacos%E4%B8%AD%E6%B7%BB%E5%8A%A0%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF"><span class="toc-number">14.4.1.6.</span> <span class="toc-text">在Nacos中添加配置信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-20"><span class="toc-number">14.4.1.7.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nacos%E4%BD%9C%E4%B8%BA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E5%88%86%E7%B1%BB%E9%85%8D%E7%BD%AE"><span class="toc-number">14.4.2.</span> <span class="toc-text">Nacos作为配置中心-分类配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Data-ID"><span class="toc-number">14.4.2.1.</span> <span class="toc-text">Data ID</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Group"><span class="toc-number">14.4.2.2.</span> <span class="toc-text">Group</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#namespace"><span class="toc-number">14.4.2.3.</span> <span class="toc-text">namespace</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#star-Nacos%E9%9B%86%E7%BE%A4%E5%92%8C%E6%8C%81%E4%B9%85%E5%8C%96%E9%85%8D%E7%BD%AE%EF%BC%88%E9%87%8D%E8%A6%81%EF%BC%89"><span class="toc-number">14.5.</span> <span class="toc-text">:star:&#x3D;&#x3D;Nacos集群和持久化配置（重要）&#x3D;&#x3D;</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#nacos%E9%85%8D%E7%BD%AE%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">14.5.1.</span> <span class="toc-text">nacos配置持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%88%91%E7%9A%84%E9%85%8D%E7%BD%AE%EF%BC%9A"><span class="toc-number">14.5.1.1.</span> <span class="toc-text">我的配置：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%AD%A5%E9%AA%A4%EF%BC%9A"><span class="toc-number">14.5.1.2.</span> <span class="toc-text">配置步骤：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5mysql8"><span class="toc-number">14.5.1.3.</span> <span class="toc-text">连接mysql8</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nacos%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4"><span class="toc-number">14.5.2.</span> <span class="toc-text">nacos配置集群</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%88%91%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="toc-number">14.5.2.1.</span> <span class="toc-text">我的配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%AD%A5%E9%AA%A4"><span class="toc-number">14.5.2.2.</span> <span class="toc-text">配置步骤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#If-user-MySQL-as-datasource"><span class="toc-number">14.5.3.</span> <span class="toc-text">If user MySQL as datasource:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Count-of-DB"><span class="toc-number">14.5.4.</span> <span class="toc-text">Count of DB:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Connect-URL-of-DB"><span class="toc-number">14.5.5.</span> <span class="toc-text">Connect URL of DB:</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#star2-%E5%8D%81%E4%BA%94%E3%80%81SpringCloud-Alibaba-Sentinle%E5%AE%9E%E7%8E%B0%E7%86%94%E6%96%AD%E4%B8%8E%E9%99%90%E6%B5%81"><span class="toc-number">15.</span> <span class="toc-text">:star2:十五、SpringCloud Alibaba Sentinle实现熔断与限流</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Sentinle"><span class="toc-number">15.1.</span> <span class="toc-text">Sentinle</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%98%E7%BD%91-2"><span class="toc-number">15.1.1.</span> <span class="toc-text">官网</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%AF%E4%BB%80%E4%B9%88-11"><span class="toc-number">15.1.2.</span> <span class="toc-text">是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%BB%E5%93%AA%E4%B8%8B-2"><span class="toc-number">15.1.3.</span> <span class="toc-text">去哪下</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%83%BD%E5%B9%B2%E5%98%9B-6"><span class="toc-number">15.1.4.</span> <span class="toc-text">能干嘛</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%8E%E4%B9%88%E7%8E%A9"><span class="toc-number">15.1.5.</span> <span class="toc-text">怎么玩</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Sentinle%E6%8E%A7%E5%88%B6%E5%8F%B0"><span class="toc-number">15.2.</span> <span class="toc-text">安装Sentinle控制台</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Sentinel-%E5%88%86%E4%B8%BA%E4%B8%A4%E4%B8%AA%E9%83%A8%E5%88%86"><span class="toc-number">15.2.1.</span> <span class="toc-text">Sentinel 分为两个部分:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%90%AF%E5%8A%A8%E6%AD%A5%E9%AA%A4"><span class="toc-number">15.2.2.</span> <span class="toc-text">安装启动步骤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%BC%94%E7%A4%BA%E5%B7%A5%E7%A8%8B"><span class="toc-number">15.3.</span> <span class="toc-text">初始化演示工程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAcloudalibaba-sentinel-service8401"><span class="toc-number">15.3.1.</span> <span class="toc-text">创建cloudalibaba-sentinel-service8401</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#POM-4"><span class="toc-number">15.3.1.1.</span> <span class="toc-text">POM</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#YML-3"><span class="toc-number">15.3.1.2.</span> <span class="toc-text">YML</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E5%90%AF%E5%8A%A8-3"><span class="toc-number">15.3.1.3.</span> <span class="toc-text">主启动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E7%B1%BBFlowLimitController"><span class="toc-number">15.3.1.4.</span> <span class="toc-text">业务类FlowLimitController</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-21"><span class="toc-number">15.3.2.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E6%8E%A7%E8%A7%84%E5%88%99%EF%BC%88%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%EF%BC%89"><span class="toc-number">15.4.</span> <span class="toc-text">流控规则（流量控制）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D"><span class="toc-number">15.4.1.</span> <span class="toc-text">基本介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E6%8E%A7%E6%A8%A1%E5%BC%8F"><span class="toc-number">15.4.2.</span> <span class="toc-text">流控模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E6%8E%A7%E8%A7%84%E5%88%99"><span class="toc-number">15.4.3.</span> <span class="toc-text">流控规则</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%EF%BC%88%E9%BB%98%E8%AE%A4%EF%BC%89"><span class="toc-number">15.4.3.1.</span> <span class="toc-text">直接（默认）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E8%81%94"><span class="toc-number">15.4.3.2.</span> <span class="toc-text">关联</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%93%BE%E8%B7%AF"><span class="toc-number">15.4.3.3.</span> <span class="toc-text">链路</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%84%E7%83%ADWarm-up"><span class="toc-number">15.4.3.4.</span> <span class="toc-text">预热Warm up</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%92%E9%98%9F%E7%AD%89%E5%BE%85"><span class="toc-number">15.4.3.5.</span> <span class="toc-text">排队等待</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%8D%E7%BA%A7%E8%A7%84%E5%88%99"><span class="toc-number">15.5.</span> <span class="toc-text">降级规则</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RT%E9%85%8D%E7%BD%AE"><span class="toc-number">15.5.1.</span> <span class="toc-text">RT配置:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E6%AF%94%E4%BE%8B"><span class="toc-number">15.5.2.</span> <span class="toc-text">异常比例:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E6%95%B0"><span class="toc-number">15.5.3.</span> <span class="toc-text">异常数:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%83%AD%E7%82%B9%E8%A7%84%E5%88%99"><span class="toc-number">15.6.</span> <span class="toc-text">热点规则</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B98401"><span class="toc-number">15.6.1.</span> <span class="toc-text">修改8401</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%9D%E5%A4%96%E9%85%8D%E7%BD%AE"><span class="toc-number">15.6.2.</span> <span class="toc-text">额外配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E8%A7%84%E5%88%99"><span class="toc-number">15.7.</span> <span class="toc-text">系统规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SentinelResource%E6%B3%A8%E8%A7%A3"><span class="toc-number">15.8.</span> <span class="toc-text">@SentinelResource注解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SentinelResource-%E6%B3%A8%E8%A7%A3"><span class="toc-number">15.9.</span> <span class="toc-text">@SentinelResource 注解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%99%90%E6%B5%81%E5%A4%84%E7%90%86%E9%80%BB%E8%BE%91"><span class="toc-number">15.9.1.</span> <span class="toc-text">自定义限流处理逻辑:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD-1"><span class="toc-number">15.10.</span> <span class="toc-text">服务熔断</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%84%E5%88%99%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">15.11.</span> <span class="toc-text">规则持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sentinel-%E8%A7%84%E5%88%99%E6%8C%81%E4%B9%85%E5%8C%96%E5%88%B0nacos"><span class="toc-number">15.11.1.</span> <span class="toc-text">sentinel 规则持久化到nacos</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0"><span class="toc-number">15.11.1.1.</span> <span class="toc-text">问题描述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B"><span class="toc-number">15.11.1.2.</span> <span class="toc-text">实现过程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E8%A7%84%E5%88%99%E5%90%8C%E6%AD%A5%E5%88%B0Nacos"><span class="toc-number">15.11.2.</span> <span class="toc-text">修改规则同步到Nacos</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">15.11.2.1.</span> <span class="toc-text">代码实现</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E5%85%AD%E3%80%81SpringCloud-Seata-%E5%A4%84%E7%90%86%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-number">16.</span> <span class="toc-text">十六、SpringCloud Seata 处理分布式事务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#seata%E7%AE%80%E4%BB%8B"><span class="toc-number">16.1.</span> <span class="toc-text">seata简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E9%97%AE%E9%A2%98"><span class="toc-number">16.1.1.</span> <span class="toc-text">分布式事务问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%AF%E4%BB%80%E4%B9%88-12"><span class="toc-number">16.1.2.</span> <span class="toc-text">是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%83%BD%E5%B9%B2%E5%98%9B-7"><span class="toc-number">16.1.3.</span> <span class="toc-text">能干嘛</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E8%BF%87%E7%A8%8B"><span class="toc-number">16.1.4.</span> <span class="toc-text">处理过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Seata%E6%9C%AF%E8%AF%AD"><span class="toc-number">16.1.5.</span> <span class="toc-text">Seata术语</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TC-%E4%BA%8B%E5%8A%A1%E5%8D%8F%E8%B0%83%E8%80%85"><span class="toc-number">16.1.5.1.</span> <span class="toc-text">TC - 事务协调者</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TM-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86%E5%99%A8"><span class="toc-number">16.1.5.2.</span> <span class="toc-text">TM - 事务管理器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RM-%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%99%A8"><span class="toc-number">16.1.5.3.</span> <span class="toc-text">RM - 资源管理器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Seata%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85"><span class="toc-number">16.2.</span> <span class="toc-text">Seata下载安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD-1"><span class="toc-number">16.2.1.</span> <span class="toc-text">下载</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2020/11/05/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E5%A4%A7%E8%AF%9D%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-xmind/" title="数据结构 学习笔记"><img data-lazy-src="/img/default_top.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="数据结构 学习笔记"/></a><div class="content"><a class="title" href="/2020/11/05/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E5%A4%A7%E8%AF%9D%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-xmind/" title="数据结构 学习笔记">数据结构 学习笔记</a><time datetime="2020-11-04T16:00:00.000Z" title="发表于 2020-11-05 00:00:00">2020-11-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/10/21/MQ/RabbitMQ/RabbitMQ/" title="rabbitMQ 学习笔记"><img data-lazy-src="/img/rabbitMQ-cover.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="rabbitMQ 学习笔记"/></a><div class="content"><a class="title" href="/2020/10/21/MQ/RabbitMQ/RabbitMQ/" title="rabbitMQ 学习笔记">rabbitMQ 学习笔记</a><time datetime="2020-10-20T16:00:00.000Z" title="发表于 2020-10-21 00:00:00">2020-10-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/10/21/MQ/RabbitMQ/%E9%94%99%E8%AF%AF%E8%AE%B0%E5%BD%95/" title="rabbitMQ 错误记录"><img data-lazy-src="/img/%E9%94%99%E8%AF%AF%E8%AE%B0%E5%BD%95.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="rabbitMQ 错误记录"/></a><div class="content"><a class="title" href="/2020/10/21/MQ/RabbitMQ/%E9%94%99%E8%AF%AF%E8%AE%B0%E5%BD%95/" title="rabbitMQ 错误记录">rabbitMQ 错误记录</a><time datetime="2020-10-20T16:00:00.000Z" title="发表于 2020-10-21 00:00:00">2020-10-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/08/14/zookeeper/zookeeper/" title="zookeeper 学习笔记"><img data-lazy-src="/img/zookeeper-cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="zookeeper 学习笔记"/></a><div class="content"><a class="title" href="/2020/08/14/zookeeper/zookeeper/" title="zookeeper 学习笔记">zookeeper 学习笔记</a><time datetime="2020-08-13T16:00:00.000Z" title="发表于 2020-08-14 00:00:00">2020-08-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/08/12/MQ/ActiveMQ/activeMQ/" title="activeMQ 学习笔记"><img data-lazy-src="/img/activeMQ-cover.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="activeMQ 学习笔记"/></a><div class="content"><a class="title" href="/2020/08/12/MQ/ActiveMQ/activeMQ/" title="activeMQ 学习笔记">activeMQ 学习笔记</a><time datetime="2020-08-11T16:00:00.000Z" title="发表于 2020-08-12 00:00:00">2020-08-12</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By LLQWQ</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">欸嘿( •̀ ω •́ )✧</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script></div></body></html>